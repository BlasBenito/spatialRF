<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Spatial Random Forest Models • spatialRF</title>
<script src="../deps/jquery-3.6.1/jquery-3.6.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Spatial Random Forest Models">
<link rel="stylesheet" href="extra.css">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">spatialRF</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.5</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Tutorials</h6></li>
    <li><a class="dropdown-item" href="../articles/non_spatial_models.html">Non-Spatial Random Forest Models</a></li>
    <li><a class="dropdown-item" href="../articles/spatial_models.html">Spatial Random Forest Models</a></li>
    <li><a class="dropdown-item" href="../articles/download_history.html">Download history</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Development</h6></li>
    <li><a class="dropdown-item" href="../articles/development_roadmap.html">Development Roadmap</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/BlasBenito/spatialRF/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<script src="spatial_models_files/kePrint-0.0.1/kePrint.js"></script><link href="spatial_models_files/lightable-0.0.1/lightable.css" rel="stylesheet">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Spatial Random Forest Models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/BlasBenito/spatialRF/blob/HEAD/vignettes/articles/spatial_models.Rmd" class="external-link"><code>vignettes/articles/spatial_models.Rmd</code></a></small>
      <div class="d-none name"><code>spatial_models.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This tutorial demonstrates how to address spatial autocorrelation in
random forest model residuals using the <code>spatialRF</code> package.
Spatial autocorrelation occurs when model residuals at nearby locations
are more similar than expected by chance, violating the assumption of
independence and potentially leading to inflated performance metrics and
biased variable importance scores.</p>
<p>The <code><a href="../reference/rf_spatial.html">rf_spatial()</a></code> function addresses this issue by
incorporating <strong>spatial predictors</strong> (Moran’s Eigenvector
Maps) that capture spatial structure not explained by environmental
predictors alone.</p>
<p>For an introduction to non-spatial random forest modeling with
spatialRF, see the <a href="non_spatial_models.html">Non-Spatial Random
Forest Models</a> tutorial.</p>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://blasbenito.github.io/spatialRF/">spatialRF</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rnaturalearth/" class="external-link">rnaturalearth</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rnaturalearthdata/" class="external-link">rnaturalearthdata</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load data and precomputed non-spatial model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span></span>
<span>  <span class="va">plants_df</span>,</span>
<span>  <span class="va">plants_response</span>,</span>
<span>  <span class="va">plants_predictors</span>,</span>
<span>  <span class="va">plants_distance</span>,</span>
<span>  <span class="va">plants_xy</span>,</span>
<span>  <span class="va">plants_rf</span>  <span class="co"># precomputed non-spatial model</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#distance thresholds (same units as plants_distance, km)</span></span>
<span><span class="co">#used to assess spatial correlation at different distances</span></span>
<span><span class="va">distance_thresholds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">100</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, <span class="fl">4000</span>, <span class="fl">8000</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#a pretty color palette</span></span>
<span><span class="va">colors</span> <span class="op">&lt;-</span> <span class="fu">grDevices</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    palette <span class="op">=</span> <span class="st">"Zissou 1"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co"># Parallel backend</span></span>
<span><span class="va">cluster</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span></span>
<span>  <span class="fl">2</span>, <span class="co">#parallel::detectCores() - 1,</span></span>
<span>  type <span class="op">=</span> <span class="st">"PSOCK"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load world map for visualizations</span></span>
<span><span class="va">world</span> <span class="op">&lt;-</span> <span class="fu">rnaturalearth</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/rnaturalearth/reference/ne_countries.html" class="external-link">ne_countries</a></span><span class="op">(</span></span>
<span>  scale <span class="op">=</span> <span class="st">"medium"</span>,</span>
<span>  returnclass <span class="op">=</span> <span class="st">"sf"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="non-spatial-vs-spatial-model">Non-spatial vs spatial model<a class="anchor" aria-label="anchor" href="#non-spatial-vs-spatial-model"></a>
</h2>
<p>The plot below shows the spatial autocorrelation of of the residuals
from a non-spatial model.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m.non_spatial</span> <span class="op">&lt;-</span> <span class="fu">spatialRF</span><span class="fu">::</span><span class="fu"><a href="../reference/rf.html">rf</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">plants_df</span>,</span>
<span>  dependent.variable.name <span class="op">=</span> <span class="va">plants_response</span>,</span>
<span>  predictor.variable.names <span class="op">=</span> <span class="va">plants_predictors</span>,</span>
<span>  distance.matrix <span class="op">=</span> <span class="va">plants_distance</span>,</span>
<span>  distance.thresholds <span class="op">=</span> <span class="va">distance_thresholds</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">spatialRF</span><span class="fu">::</span><span class="fu"><a href="../reference/plot_moran.html">plot_moran</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">m.non_spatial</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  point.color <span class="op">=</span> <span class="va">colors</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="spatial_models_files/figure-html/unnamed-chunk-2-1.png" class="r-plt" alt="" width="100%"></p>
<p>The spatial autocorrelation of the model residuals is high for
neighborhood distances up to ~3000km</p>
<p>To reduce the spatial autocorrelation of the residuals as much as
possible, the non-spatial model can be transformed into a <em>spatial
model</em> with <a href="https://blasbenito.github.io/spatialRF/reference/rf_spatial.html"><code>rf_spatial()</code></a>.</p>
<p>This function is the true core of the package!</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m.spatial</span> <span class="op">&lt;-</span> <span class="fu">spatialRF</span><span class="fu">::</span><span class="fu"><a href="../reference/rf_spatial.html">rf_spatial</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">m.non_spatial</span>,</span>
<span>  cluster <span class="op">=</span> <span class="va">cluster</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu">spatialRF</span><span class="fu">::</span><span class="fu"><a href="../reference/plot_moran.html">plot_moran</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">m.spatial</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  point.color <span class="op">=</span> <span class="va">colors</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="spatial_models_files/figure-html/unnamed-chunk-3-1.png" class="r-plt" alt="" width="100%"></p>
<p>The residuals of the spatial model plotted above are not spatially
correlated anymore!</p>
<p>This improvement results from adding <em>spatial predictors</em> to
the model.</p>
</div>
<div class="section level2">
<h2 id="spatial-predictors">Spatial predictors<a class="anchor" aria-label="anchor" href="#spatial-predictors"></a>
</h2>
<p>The variable importance plot below shows that the spatial model has
<strong>spatial predictors</strong> with varying levels or
importance.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">spatialRF</span><span class="fu">::</span><span class="fu"><a href="../reference/plot_importance.html">plot_importance</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">m.spatial</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  fill.color <span class="op">=</span> <span class="va">colors</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="spatial_models_files/figure-html/unnamed-chunk-4-1.png" class="r-plt" alt="" width="100%"></p>
<p>Spatial predictors are named <code>spatial_predictor_X_Y</code>,
where <code>X</code> is the neighborhood distance at which the predictor
is generated, and <code>Y</code> is the index of the predictor.</p>
<table class="table">
<thead><tr class="header">
<th align="left">variable</th>
<th align="right">importance</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">spatial_predictor_10_3</td>
<td align="right">1045.043</td>
</tr>
<tr class="even">
<td align="left">spatial_predictor_10_2</td>
<td align="right">844.255</td>
</tr>
<tr class="odd">
<td align="left">spatial_predictor_10_5</td>
<td align="right">770.861</td>
</tr>
<tr class="even">
<td align="left">spatial_predictor_10_1</td>
<td align="right">707.001</td>
</tr>
<tr class="odd">
<td align="left">spatial_predictor_10_4</td>
<td align="right">638.946</td>
</tr>
<tr class="even">
<td align="left">spatial_predictor_10_13</td>
<td align="right">556.443</td>
</tr>
<tr class="odd">
<td align="left">spatial_predictor_10_10</td>
<td align="right">477.876</td>
</tr>
<tr class="even">
<td align="left">spatial_predictor_10_20</td>
<td align="right">476.759</td>
</tr>
<tr class="odd">
<td align="left">spatial_predictor_10_8</td>
<td align="right">468.989</td>
</tr>
<tr class="even">
<td align="left">spatial_predictor_10_16</td>
<td align="right">468.463</td>
</tr>
<tr class="odd">
<td align="left">spatial_predictor_2000_3</td>
<td align="right">461.205</td>
</tr>
<tr class="even">
<td align="left">spatial_predictor_10_15</td>
<td align="right">446.738</td>
</tr>
<tr class="odd">
<td align="left">spatial_predictor_1000_11</td>
<td align="right">426.185</td>
</tr>
<tr class="even">
<td align="left">spatial_predictor_10_12</td>
<td align="right">372.793</td>
</tr>
<tr class="odd">
<td align="left">spatial_predictor_10_17</td>
<td align="right">357.319</td>
</tr>
<tr class="even">
<td align="left">spatial_predictor_10_22</td>
<td align="right">348.198</td>
</tr>
<tr class="odd">
<td align="left">spatial_predictor_10_14</td>
<td align="right">337.736</td>
</tr>
<tr class="even">
<td align="left">spatial_predictor_10_11</td>
<td align="right">328.416</td>
</tr>
<tr class="odd">
<td align="left">spatial_predictor_10_21</td>
<td align="right">306.931</td>
</tr>
<tr class="even">
<td align="left">spatial_predictor_10_9</td>
<td align="right">302.574</td>
</tr>
<tr class="odd">
<td align="left">spatial_predictor_10_7</td>
<td align="right">299.491</td>
</tr>
<tr class="even">
<td align="left">spatial_predictor_10_19</td>
<td align="right">285.000</td>
</tr>
<tr class="odd">
<td align="left">spatial_predictor_10_18</td>
<td align="right">264.969</td>
</tr>
<tr class="even">
<td align="left">spatial_predictor_2000_6</td>
<td align="right">258.225</td>
</tr>
<tr class="odd">
<td align="left">spatial_predictor_1000_9</td>
<td align="right">244.433</td>
</tr>
<tr class="even">
<td align="left">spatial_predictor_1000_10</td>
<td align="right">220.619</td>
</tr>
</tbody>
</table>
<p>Spatial predictors are smooth surfaces representing neighborhood
among records at different spatial scales. They are computed from the
distance matrix in different ways.</p>
<p>The ones computed by default in <code><a href="../reference/rf_spatial.html">rf_spatial()</a></code> are the
eigenvectors of the double-centered distance matrix of weights (a.k.a,
Moran’s Eigenvector Maps).</p>
<p>They represent the effect of spatial proximity among records, helping
to represent biogeographic and spatial processes not considered by the
non-spatial predictors.</p>
<p>They can be extracted from the model with the function
<code><a href="../reference/get_spatial_predictors.html">get_spatial_predictors()</a></code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spatial.predictors</span> <span class="op">&lt;-</span> <span class="fu">spatialRF</span><span class="fu">::</span><span class="fu"><a href="../reference/get_spatial_predictors.html">get_spatial_predictors</a></span><span class="op">(</span><span class="va">m.spatial</span><span class="op">)</span></span></code></pre></div>
<p>The map below shows a couple of them.</p>
<p><img src="spatial_models_files/figure-html/unnamed-chunk-7-1.png" class="r-plt" alt="" width="100%"></p>
</div>
<div class="section level2">
<h2 id="selection-of-spatial-predictors">Selection of spatial predictors<a class="anchor" aria-label="anchor" href="#selection-of-spatial-predictors"></a>
</h2>
<p>The spatial predictors are included in the model sequentially via <a href="https://blasbenito.github.io/spatialRF/reference/select_spatial_predictors_sequential.html"><code>select_spatial_predictors_sequential()</code></a>.
This function finds the smallest subset of spatial predictors that
maximizes the model’s R squared and minimizes the Moran’s I of the
residuals.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">spatialRF</span><span class="fu">::</span><span class="fu"><a href="../reference/plot_optimization.html">plot_optimization</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">m.spatial</span>,</span>
<span>  point.color <span class="op">=</span> <span class="va">colors</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="spatial_models_files/figure-html/unnamed-chunk-8-1.png" class="r-plt" alt="" width="100%">
The path in the plot below shows the iterative selection of spatial
predictors, that tries to reduce the spatial autocorrelation of the
residuals (<em>y</em> axis) without degrading model performance
(<em>x</em> axis).</p>
</div>
<div class="section level2">
<h2 id="model-comparison">Model comparison<a class="anchor" aria-label="anchor" href="#model-comparison"></a>
</h2>
<p>The function <a href="https://blasbenito.github.io/spatialRF/reference/rf_compare.html"><code>rf_compare()</code></a>
takes named list with models trained with the same data, and applies
<code><a href="../reference/rf_evaluate.html">rf_evaluate()</a></code> to each one of them to compare their
predictive performances across spatial folds.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">comparison</span> <span class="op">&lt;-</span> <span class="fu">spatialRF</span><span class="fu">::</span><span class="fu"><a href="../reference/rf_compare.html">rf_compare</a></span><span class="op">(</span></span>
<span>  models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    `Non-spatial` <span class="op">=</span> <span class="va">m.non_spatial</span>,</span>
<span>    `Spatial` <span class="op">=</span> <span class="va">m.spatial</span></span>
<span>  <span class="op">)</span>,</span>
<span>  xy <span class="op">=</span> <span class="va">plants_xy</span>,</span>
<span>  repetitions <span class="op">=</span> <span class="fl">30</span>,</span>
<span>  training.fraction <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>  fill.color <span class="op">=</span> <span class="va">colors</span>,</span>
<span>  cluster <span class="op">=</span> <span class="va">cluster</span>,</span>
<span>  metrics <span class="op">=</span> <span class="st">"r.squared"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="spatial_models_files/figure-html/unnamed-chunk-9-1.png" class="r-plt" alt="" width="100%"></p>
<p>The comparison shows that the spatial model has a better performance
on when predicting on independent spatial folds. This is an expected
behavior: spatial predictors make models less transferable in space!
That’s why <code>spatialRF</code> is focused on explanatory models
rather than predictive ones.</p>
</div>
<div class="section level2">
<h2 id="using-spatial-predictors-in-other-models">Using spatial predictors in other models<a class="anchor" aria-label="anchor" href="#using-spatial-predictors-in-other-models"></a>
</h2>
<p>Spatial predictors from <code>spatialRF</code> can be used with any
modeling method. The workflow: generate MEMs, rank by Moran’s I, add
sequentially until residual autocorrelation is resolved.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#generate and rank MEMs</span></span>
<span><span class="va">mems</span> <span class="op">&lt;-</span> <span class="fu">spatialRF</span><span class="fu">::</span><span class="fu"><a href="../reference/mem_multithreshold.html">mem_multithreshold</a></span><span class="op">(</span></span>
<span>  distance.matrix <span class="op">=</span> <span class="va">plants_distance</span>,</span>
<span>  distance.thresholds <span class="op">=</span> <span class="va">distance_thresholds</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ranked</span> <span class="op">&lt;-</span> <span class="fu">spatialRF</span><span class="fu">::</span><span class="fu"><a href="../reference/rank_spatial_predictors.html">rank_spatial_predictors</a></span><span class="op">(</span></span>
<span>  distance.matrix <span class="op">=</span> <span class="va">plants_distance</span>,</span>
<span>  spatial.predictors.df <span class="op">=</span> <span class="va">mems</span>,</span>
<span>  ranking.method <span class="op">=</span> <span class="st">"moran"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">mems</span> <span class="op">&lt;-</span> <span class="va">mems</span><span class="op">[</span>, <span class="va">ranked</span><span class="op">$</span><span class="va">ranking</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#prepare scaled data</span></span>
<span><span class="va">plants_df.scaled</span> <span class="op">&lt;-</span> <span class="va">plants_df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#fit non-spatial model</span></span>
<span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span></span>
<span>  <span class="va">richness_species_vascular</span> <span class="op">~</span> <span class="va">human_population</span> <span class="op">+</span> <span class="va">climate_bio1_average</span> <span class="op">+</span></span>
<span>    <span class="va">climate_hypervolume</span> <span class="op">+</span> <span class="va">human_footprint_average</span>,</span>
<span>  data <span class="op">=</span> <span class="va">plants_df.scaled</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#check autocorrelation</span></span>
<span><span class="va">m1.moran</span> <span class="op">&lt;-</span> <span class="fu">spatialRF</span><span class="fu">::</span><span class="fu"><a href="../reference/moran.html">moran</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span>,</span>
<span>  distance.matrix <span class="op">=</span> <span class="va">plants_distance</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">m1.moran</span><span class="op">$</span><span class="va">plot</span></span></code></pre></div>
<p><img src="spatial_models_files/figure-html/unnamed-chunk-11-1.png" class="r-plt" alt="" width="100%"></p>
<p>Residuals show spatial autocorrelation. Let’s add MEMs
sequentially:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#combine data with MEMs</span></span>
<span><span class="va">plants_df.mem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">plants_df.scaled</span>, <span class="va">mems</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#add MEMs until autocorrelation resolved</span></span>
<span><span class="va">spatial_predictors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">mems</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="va">spatial_predictors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">spatial_predictors</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mems</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">formula_i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/delete.response.html" class="external-link">reformulate</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"human_population"</span>, </span>
<span>      <span class="st">"climate_bio1_average"</span>,</span>
<span>      <span class="st">"climate_hypervolume"</span>, </span>
<span>      <span class="st">"human_footprint_average"</span>,</span>
<span>      <span class="va">spatial_predictors</span></span>
<span>      <span class="op">)</span>,</span>
<span>    response <span class="op">=</span> <span class="va">plants_response</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> <span class="va">formula_i</span>, </span>
<span>    data <span class="op">=</span> <span class="va">plants_df.mem</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>  <span class="va">m2.moran</span> <span class="op">&lt;-</span> <span class="fu">spatialRF</span><span class="fu">::</span><span class="fu"><a href="../reference/moran.html">moran</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span>,</span>
<span>    distance.matrix <span class="op">=</span> <span class="va">plants_distance</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">m2.moran</span><span class="op">$</span><span class="va">test</span><span class="op">$</span><span class="va">interpretation</span> <span class="op">==</span> <span class="st">"No spatial correlation"</span><span class="op">)</span> <span class="kw">break</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">m2.moran</span><span class="op">$</span><span class="va">plot</span></span></code></pre></div>
<p><img src="spatial_models_files/figure-html/unnamed-chunk-12-1.png" class="r-plt" alt="" width="100%"></p>
<p>Compare models:</p>
<table class="table  lightable-paper lightable-hover" style='font-family: "Arial Narrow", arial, helvetica, sans-serif; width: auto !important; margin-left: auto; margin-right: auto;'>
<thead><tr>
<th style="text-align:left;">
Model
</th>
<th style="text-align:right;">
Predictors
</th>
<th style="text-align:right;">
R2
</th>
<th style="text-align:right;">
Moran_I
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
Non-spatial
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
0.386
</td>
<td style="text-align:right;">
0.174
</td>
</tr>
<tr>
<td style="text-align:left;">
Spatial
</td>
<td style="text-align:right;">
24
</td>
<td style="text-align:right;">
0.494
</td>
<td style="text-align:right;">
0.048
</td>
</tr>
</tbody>
</table>
<p>Adding the spatial predictors eliminated autocorrelation while
improving model fit.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://blasbenito.com" class="external-link">Blas M. Benito</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
