<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Easy Spatial Modeling with Random Forest • spatialRF</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Easy Spatial Modeling with Random Forest">
<meta property="og:description" content="Automatic generation and selection of spatial predictors for spatial regression with Random Forest. Spatial predictors are surrogates of variables driving the spatial structure of a response variable. The package offers two methods to generate spatial predictors from a distance matrix among training cases: 1) Morans Eigenvector Maps (MEMs; Dray, Legendre, and Peres-Neto 2006 &lt;DOI:10.1016/j.ecolmodel.2006.02.015&gt;): computed as the eigenvectors of a weighted matrix of distances; 2) RFsp (Hengl et al. &lt;DOI:10.7717/peerj.5518&gt;): columns of the distance matrix used as spatial predictors. Spatial predictors help minimize the spatial autocorrelation of the model residuals and facilitate an honest assessment of the importance scores of the non-spatial predictors. Additionally, functions to reduce multicollinearity, identify relevant variable interactions, tune random forest hyperparameters, assess model transferability via spatial cross-validation, and explore model results via partial dependence curves and interaction surfaces are included in the package. The modelling functions are built around the highly efficient ranger' package (Wright and Ziegler 2017 &lt;DOI:10.18637/jss.v077.i01&gt;).  ">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">spatialRF</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/BlasBenito/spatialRF/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">

<div id="spatialrf-easy-spatial-regression-with-random-forest" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#spatialrf-easy-spatial-regression-with-random-forest" class="anchor"></a><code>spatialRF</code>: Easy Spatial Regression with Random Forest</h1></div>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#development">Development</a></li>
<li><a href="#applications">Applications</a></li>
<li><a href="#citation">Citation</a></li>
<li><a href="#install">Install</a></li>
<li><a href="#data-requirements">Data requirements</a></li>
<li><a href="#example-data">Example data</a></li>
<li><a href="#reducing-multicollinearity-in-the-predictors">Reducing multicollinearity in the predictors</a></li>
<li><a href="#finding-promising-variable-interactions">Finding promising variable interactions</a></li>
<li>
<a href="#fitting-a-non-spatial-random-forest-model-with-rf">Fitting a non-spatial Random Forest model with <code><a href="reference/rf.html">rf()</a></code></a>
<ul>
<li><a href="#residuals">Residuals</a></li>
<li><a href="#variable-importance">Variable importance</a></li>
<li><a href="#response-curves-and-surfaces">Response curves and surfaces</a></li>
<li><a href="#model-performance">Model performance</a></li>
<li><a href="#spatial-cross-validation">Spatial cross-validation</a></li>
<li><a href="#other-important-things-stored-in-the-model">Other important things stored in the model</a></li>
</ul>
</li>
<li><a href="#fitting-a-spatial-model-with-rf_spatial">Fitting a spatial model with <code><a href="reference/rf_spatial.html">rf_spatial()</a></code></a></li>
<li><a href="#tuning-random-forest-hyperparameters">Tuning Random Forest hyperparameters</a></li>
<li><a href="#repeating-a-model-execution">Repeating a model execution</a></li>
<li><a href="#taking-advantage-of-the--pipe">Taking advantage of the <code><a href="https://rdrr.io/pkg/kableExtra/man/reexports.html">%&gt;%</a></code> pipe</a></li>
<li><a href="#comparing-several-models">Comparing several models</a></li>
<li><a href="#working-with-a-binomial-response">Working with a binomial response</a></li>
<li><a href="#generating-spatial-predictors-for-other-modelling-methods">Generating spatial predictors for other modelling methods</a></li>
</ul>
<!---
[![R-CMD-check](https://github.com/BlasBenito/spatialRF/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/BlasBenito/spatialRF/actions/workflows/R-CMD-check.yaml)
--><!-- badges: start -->
<!-- badges: end -->
</div>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>The package <strong>spatialRF</strong> facilitates fitting spatial regression models on regular or irregular data with Random Forest. It does so by generating <em>spatial predictors</em> that help the model “understand” the spatial structure of the training data with the end goal of minimizing the spatial autocorrelation of the model residuals and offering honest variable importance scores.</p>
<p>Two main methods to generate <em>spatial predictors</em> from the distance matrix of the data points are implemented in the package:</p>
<ul>
<li>Moran’s Eigenvector Maps <a href="https://www.sciencedirect.com/science/article/abs/pii/S0304380006000925">(Dray, Legendre, and Peres-Neto 2006)</a>.</li>
<li>Distance matrix columns as explanatory variables <a href="https://peerj.com/articles/5518/">(Hengl et al. 2018)</a>.</li>
</ul>
<p>The package is designed to minimize the code required to fit a spatial model from a training dataset, the names of the response and the predictors, and a distance matrix, as shown below.</p>
<div class="sourceCode" id="cb1"><pre class="r"><span class="no">spatial.model</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/rf_spatial.html">rf_spatial</a></span>(
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">your_dataframe</span>,
  <span class="kw">dependent.variable.name</span> <span class="kw">=</span> <span class="st">"your_response_variable"</span>,
  <span class="kw">predictor.variable.names</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"predictor1"</span>, <span class="st">"predictor2"</span>, <span class="no">...</span>, <span class="st">"predictorN"</span>),
  <span class="kw">distance.matrix</span> <span class="kw">=</span> <span class="no">your_distance_matrix</span>
  )</pre></div>
<p><strong>spatialRF</strong> uses the fast and efficient <code>ranger</code> package under the hood <a href="https://arxiv.org/abs/1508.04409">(Wright and Ziegler 2017)</a>, so please, cite the <code>ranger</code> package when using <code>spatialRF</code>!</p>
<p>This pacakge also provides tools to identify potentially interesting variable interactions, tune random forest hyperparameters, assess model performance on spatially independent data folds, and examine the resulting models via importance plots, response curves, and response surfaces.</p>
</div>
<div id="development" class="section level1">
<h1 class="hasAnchor">
<a href="#development" class="anchor"></a>Development</h1>
<p>This package is reaching its final form, and big changes are not expected at this stage. However, it has many functions, and even though all them have been tested, only one dataset has been used for those tests. You will find bugs, and something will go wrong almost surely. If you have time to report bugs, please, do so in any of the following ways:</p>
<ul>
<li>Open a new issue in the <a href="https://github.com/BlasBenito/spatialRF/issues">Issues GitHub page of the package</a>.</li>
<li>Send me an email explaining the issue and the error messages with enough detail at blasbenito at gmail dot com.</li>
<li>Send a direct message to <a href="https://twitter.com/blasbenito">my twitter account</a> explaining the issue.</li>
</ul>
<p>I will do my best to solve any issues ASAP!</p>
</div>
<div id="applications" class="section level1">
<h1 class="hasAnchor">
<a href="#applications" class="anchor"></a>Applications</h1>
<p>The goal of <code>spatialRF</code> is to help fitting <em>explanatory spatial regression</em>, where the target is to understand how a set of predictors and the spatial structure of the data influences response variable. Therefore, the spatial analyses implemented in the package can be applied to any spatial dataset, regular or irregular, with a sample size between ~100 and ~5000 cases (the higher end will depend on the RAM memory available), a quantitative or binary (values 0 and 1) response variable, and a more or less large set of predictive variables.</p>
<p>All functions but <code><a href="reference/rf_spatial.html">rf_spatial()</a></code> work with non-spatial data as well if the arguments <code>distance.matrix</code> and <code>distance.thresholds</code> are not provided In such case, the number of training cases is no longer limited by the size of the distance matrix, and models can be trained with hundreds of thousands of rows. In such case, the spatial autocorrelation of the model’s residuals is not assessed.</p>
<p>However, <strong>when the focus is on fitting spatial models</strong>, and due to the nature of the <em>spatial predictors</em> used to represent the spatial structure of the training data, <strong>there are many things this package cannot do</strong>:</p>
<ul>
<li><p>Predict model results over raster data.</p></li>
<li><p>Predict a model result over another region with a different spatial structure.</p></li>
<li><p>Work with “big data”, whatever that means.</p></li>
<li><p>Imputation or extrapolation (it can be done, but models based on spatial predictors are hardly transferable).</p></li>
<li><p>Take temporal autocorrelation into account (but this is something that might be implemented later on).</p></li>
</ul>
<p>If after considering these limitations you are still interested, follow me, I will show you how it works.</p>
</div>
<div id="citation" class="section level1">
<h1 class="hasAnchor">
<a href="#citation" class="anchor"></a>Citation</h1>
<p>There is a paper in the making about this package. In the meantime, if you find it useful for your academic work, please cite the <code>ranger</code> package as well, it is the true core of <code>spatialRF</code>!</p>
<p><em>Marvin N. Wright, Andreas Ziegler (2017). ranger: A Fast Implementation of Random Forests for High Dimensional Data in C++ and R. Journal of Statistical Software, 77(1), 1-17. <a href="doi:10.18637/jss.v077.i01" class="uri">doi:10.18637/jss.v077.i01</a></em></p>
<p><em>Blas M. Benito (2021). spatialRF: Easy Spatial Regression with Random Forest. R package version 1.1.0. doi: 10.5281/zenodo.4745208. url: <a href="https://blasbenito.github.io/spatialRF/" class="uri">https://blasbenito.github.io/spatialRF/</a></em></p>
</div>
<div id="install" class="section level1">
<h1 class="hasAnchor">
<a href="#install" class="anchor"></a>Install</h1>
<p>The version 1.1.3 can be installed from CRAN:</p>
<div class="sourceCode" id="cb2"><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">"spatialRF"</span>)</pre></div>
<p>The package can also be installed from GitHub as follows. There are several branches in the repository:</p>
<ul>
<li>
<code>main</code>: latest stable version (1.1.0 currently).</li>
<li>
<code>development</code>: development version, usually very broken.</li>
<li>
<code>v.1.0.9</code> to <code>v.1.1.2</code>: archived versions.</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="r"><span class="kw pkg">remotes</span><span class="kw ns">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span>(
  <span class="kw">repo</span> <span class="kw">=</span> <span class="st">"blasbenito/spatialRF"</span>,
  <span class="kw">ref</span> <span class="kw">=</span> <span class="st">"main"</span>,
  <span class="kw">force</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
  <span class="kw">quiet</span> <span class="kw">=</span> <span class="fl">TRUE</span>
  )</pre></div>
<p>There are a few other libraries that will be useful during this tutorial.</p>
<div class="sourceCode" id="cb4"><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">spatialRF</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">kableExtra</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">rnaturalearth</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">rnaturalearthdata</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyverse</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">randomForestExplainer</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">pdp</span>)</pre></div>
</div>
<div id="data-requirements" class="section level1">
<h1 class="hasAnchor">
<a href="#data-requirements" class="anchor"></a>Data requirements</h1>
<p>The data required to fit random forest models with <code>spatialRF</code> must fulfill several conditions:</p>
<ul>
<li>
<strong>The input format is data.frame</strong>. At the moment, tibbles are not fully supported.</li>
<li>
<strong>The number of rows must be somewhere between 100 and ~5000</strong>, at least if your target is fitting spatial models. This limitation comes from the fact that the distance matrix grows very fast with an increasing number of training records, so for large datasets, there might not be enough RAM in your machine.</li>
<li>
<strong>The number of predictors should be larger than 3</strong>. Fitting a Random Forest model is moot otherwise.</li>
<li>
<strong>Factors in the response or the predictors are not explicitly supported in the package</strong>. They may work, or they won’t, but in any case, I designed this package for quantitative data alone. However, binary responses with values 0 and 1 are partially supported.</li>
<li>
<strong>Must be free of <code>NA</code></strong>. You can check if there are NA records with <code><a href="https://rdrr.io/r/base/sum.html">sum(apply(df, 2, is.na))</a></code>. If the result is larger than 0, then just execute <code>df &lt;- na.omit(df)</code> to remove rows with empty cells.</li>
<li>
<strong>Columns cannot have zero variance</strong>. This condition can be checked with <code>apply(df, 2, var) == 0</code>. Columns yielding TRUE should be removed.</li>
<li>
<strong>Columns must not yield <code>NaN</code> or <code>Inf</code> when scaled</strong>. You can check each condition with <code><a href="https://rdrr.io/r/base/sum.html">sum(apply(scale(df), 2, is.nan))</a></code> and <code><a href="https://rdrr.io/r/base/sum.html">sum(apply(scale(df), 2, is.infinite))</a></code>. If higher than 0, you can find what columns are giving issues with <code><a href="https://rdrr.io/r/base/lapply.html">sapply(as.data.frame(scale(df)), function(x)any(is.nan(x)))</a></code> and <code><a href="https://rdrr.io/r/base/lapply.html">sapply(as.data.frame(scale(df)), function(x)any(is.infinite(x)))</a></code>. Any column yielding <code>TRUE</code> will generate issues while trying to fit models with <code>spatialRF</code>.</li>
</ul>
</div>
<div id="example-data" class="section level1">
<h1 class="hasAnchor">
<a href="#example-data" class="anchor"></a>Example data</h1>
<p>The package includes an example dataset that fulfills the conditions mentioned above, named <a href="https://blasbenito.github.io/spatialRF/reference/plant_richness_df.html"><code>plant_richness_df</code></a>. It is a data frame with plant species richness and predictors for 227 ecoregions in the Americas, and a distance matrix among the ecoregion edges named, well, <a href="https://blasbenito.github.io/spatialRF/reference/distance_matrix.html"><code>distance_matrix</code></a>.</p>
<p>The package follows a convention throughout functions:</p>
<ul>
<li>The argument <code>data</code> requires a training data frame.</li>
<li>The argument <code>dependent.variable.name</code> is the column name of the response variable.</li>
<li>The argument <code>predictor.variable.names</code> contains the column names of the predictors.</li>
<li>The argument <code>xy</code> takes a data frame or matrix with two columns named “x” and “y”, in that order, with the case coordinates.</li>
<li>The argument <code>distance.matrix</code> requires a matrix of distances between the cases in <code>data</code>.</li>
<li>The argument <code>distance.thresholds</code> is a numeric vector of distances at with spatial autocorrelation wants to be computed.</li>
</ul>
<p>It is therefore convenient to define these arguments at the beginning of the workflow.</p>
<div class="sourceCode" id="cb5"><pre class="r"><span class="co">#loading training data and distance matrix from the package</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="no">plant_richness_df</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="no">distance_matrix</span>)

<span class="co">#names of the response variable and the predictors</span>
<span class="no">dependent.variable.name</span> <span class="kw">&lt;-</span> <span class="st">"richness_species_vascular"</span>
<span class="no">predictor.variable.names</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">plant_richness_df</span>)[<span class="fl">5</span>:<span class="fl">21</span>]

<span class="co">#coordinates of the cases</span>
<span class="no">xy</span> <span class="kw">&lt;-</span> <span class="no">plant_richness_df</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"x"</span>, <span class="st">"y"</span>)]

<span class="co">#distance matrix</span>
<span class="no">distance.matrix</span> <span class="kw">&lt;-</span> <span class="no">distance_matrix</span>

<span class="co">#distance thresholds (same units as distance_matrix)</span>
<span class="no">distance.thresholds</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">1000</span>, <span class="fl">2000</span>, <span class="fl">4000</span>, <span class="fl">8000</span>)

<span class="co">#random seed for reproducibility</span>
<span class="no">random.seed</span> <span class="kw">&lt;-</span> <span class="fl">1</span></pre></div>
<p>The response variable of <code>plant_richness_df</code> is “richness_species_vascular”, that represents the total count of vascular plant species found on each ecoregion. The figure below shows the centroids of each ecoregion along with their associated value of the response variable.</p>
<div class="sourceCode" id="cb6"><pre class="r"><span class="no">world</span> <span class="kw">&lt;-</span> <span class="kw pkg">rnaturalearth</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/rnaturalearth/man/ne_countries.html">ne_countries</a></span>(
  <span class="kw">scale</span> <span class="kw">=</span> <span class="st">"medium"</span>,
  <span class="kw">returnclass</span> <span class="kw">=</span> <span class="st">"sf"</span>
  )

<span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(
    <span class="kw">data</span> <span class="kw">=</span> <span class="no">world</span>,
    <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"white"</span>
    ) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(
    <span class="kw">data</span> <span class="kw">=</span> <span class="no">plant_richness_df</span>,
    <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(
      <span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>,
      <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>,
      <span class="kw">color</span> <span class="kw">=</span> <span class="no">richness_species_vascular</span>
    ),
    <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2.5</span>
  ) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_color_viridis_c</a></span>(
    <span class="kw">direction</span> <span class="kw">=</span> -<span class="fl">1</span>,
    <span class="kw">option</span> <span class="kw">=</span> <span class="st">"F"</span>
    ) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>() +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">color</span> <span class="kw">=</span> <span class="st">"Plant richness"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">170</span>, -<span class="fl">30</span>)) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">58</span>, <span class="fl">80</span>))  +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Plant richness of the American ecoregions"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Longitude"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Latitude"</span>)</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-6-1.png"><!-- --></p>
<p>The predictors (columns 5 to 21) represent diverse factors that may influence plant richness such as sampling bias, the area of the ecoregion, climatic variables, human presence and impact, topography, geographical fragmentation, and features of the neighbors of each ecoregion. The figure below shows the scatterplots of the response variable (y axis) against each predictor (x axis).</p>
<p><strong>Note:</strong> Every plotting function in the package now allows changing the colors of their main features via specific arguments such as <code>point.color</code>, <code>line.color</code>, or <code>fill.color</code>.</p>
<div class="sourceCode" id="cb7"><pre class="r"><span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/plot_training_df.html">plot_training_df</a></span>(
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">plant_richness_df</span>,
  <span class="kw">dependent.variable.name</span> <span class="kw">=</span> <span class="no">dependent.variable.name</span>,
  <span class="kw">predictor.variable.names</span> <span class="kw">=</span> <span class="no">predictor.variable.names</span>,
  <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">3</span>,
  <span class="kw">point.color</span> <span class="kw">=</span> <span class="kw pkg">viridis</span><span class="kw ns">::</span><span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/reexports.html">viridis</a></span>(<span class="fl">100</span>, <span class="kw">option</span> <span class="kw">=</span> <span class="st">"F"</span>),
  <span class="kw">line.color</span> <span class="kw">=</span> <span class="st">"gray30"</span>
  )</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-7-1.png"><!-- --></p>
<p>The function <a href="https://blasbenito.github.io/spatialRF/reference/plot_training_df_moran.html"><code><a href="reference/plot_training_df_moran.html">plot_training_df_moran()</a></code></a> helps assessing the spatial autocorrelation of the response variable and the predictors across different distance thresholds. Low Moran’s I and p-values equal or larger than 0.05 indicate that there is no spatial autocorrelation for the given variable and distance threshold.</p>
<div class="sourceCode" id="cb8"><pre class="r"><span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/plot_training_df_moran.html">plot_training_df_moran</a></span>(
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">plant_richness_df</span>,
  <span class="kw">dependent.variable.name</span> <span class="kw">=</span> <span class="no">dependent.variable.name</span>,
  <span class="kw">predictor.variable.names</span> <span class="kw">=</span> <span class="no">predictor.variable.names</span>,
  <span class="kw">distance.matrix</span> <span class="kw">=</span> <span class="no">distance.matrix</span>,
  <span class="kw">distance.thresholds</span> <span class="kw">=</span> <span class="no">distance.thresholds</span>,
  <span class="kw">fill.color</span> <span class="kw">=</span> <span class="kw pkg">viridis</span><span class="kw ns">::</span><span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/reexports.html">viridis</a></span>(
    <span class="fl">100</span>,
    <span class="kw">option</span> <span class="kw">=</span> <span class="st">"F"</span>,
    <span class="kw">direction</span> <span class="kw">=</span> -<span class="fl">1</span>
    ),
  <span class="kw">point.color</span> <span class="kw">=</span> <span class="st">"gray40"</span>
)</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-8-1.png"><!-- --></p>
</div>
<div id="reducing-multicollinearity-in-the-predictors" class="section level1">
<h1 class="hasAnchor">
<a href="#reducing-multicollinearity-in-the-predictors" class="anchor"></a>Reducing multicollinearity in the predictors</h1>
<p>The functions <a href="https://blasbenito.github.io/spatialRF/reference/auto_cor.html"><code><a href="reference/auto_cor.html">auto_cor()</a></code></a> and <a href="https://blasbenito.github.io/spatialRF/reference/auto_vif.html"><code><a href="reference/auto_vif.html">auto_vif()</a></code></a> help reduce redundancy in the predictors by using different criteria (bivariate R squared vs. <a href="https://www.statisticshowto.com/variance-inflation-factor/">variance inflation factor</a>), while allowing the user to define an <em>order of preference</em>, which can be based either on domain expertise or on a quantitative assessment (e.g., order of preference based on variable importance scores or model coefficients). The preference order is defined as a character vector in the <code>preference.order</code> argument of both functions, and does not need to include the names of all predictors, but just the ones the user would like to keep in the analysis.</p>
<p>Notice that I have set <code>cor.threshold</code> and <code>vif.threshold</code> to low values because the predictors in <code>plant_richness_df</code> already have little multicollinearity,. The default values (<code>cor.threshold = 0.75</code> and <code>vif.threshold = 5</code>) should work well when combined together for any other set of predictors.</p>
<div class="sourceCode" id="cb9"><pre class="r"><span class="no">preference.order</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(
    <span class="st">"climate_bio1_average_X_bias_area_km2"</span>,
    <span class="st">"climate_aridity_index_average"</span>,
    <span class="st">"climate_hypervolume"</span>,
    <span class="st">"climate_bio1_average"</span>,
    <span class="st">"climate_bio15_minimum"</span>,
    <span class="st">"bias_area_km2"</span>
  )

<span class="no">predictor.variable.names</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/auto_cor.html">auto_cor</a></span>(
  <span class="kw">x</span> <span class="kw">=</span> <span class="no">plant_richness_df</span>[, <span class="no">predictor.variable.names</span>],
  <span class="kw">cor.threshold</span> <span class="kw">=</span> <span class="fl">0.6</span>,
  <span class="kw">preference.order</span> <span class="kw">=</span> <span class="no">preference.order</span>
) <span class="kw">%&gt;%</span>
  <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/auto_vif.html">auto_vif</a></span>(
    <span class="kw">vif.threshold</span> <span class="kw">=</span> <span class="fl">2.5</span>,
    <span class="kw">preference.order</span> <span class="kw">=</span> <span class="no">preference.order</span>
  )</pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="do">## [auto_cor()]: Removed variables: human_footprint_average</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="do">## [auto_vif()]: Variables are not collinear.</span></span></code></pre></div>
<p>The output of <code><a href="reference/auto_cor.html">auto_cor()</a></code> or <code><a href="reference/auto_vif.html">auto_vif()</a></code> has the class “variable_selection”, which can be used as input in every function having the argument <code>predictor.variable.names</code>.</p>
<div class="sourceCode" id="cb11"><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">predictor.variable.names</span>)</pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] "vif"                   "selected.variables"    "selected.variables.df"</span></span></code></pre></div>
<p>The slot <code>selected.variables</code> contains the names of the selected predictors.</p>
<div class="sourceCode" id="cb13"><pre class="r"><span class="no">predictor.variable.names</span>$<span class="no">selected.variables</span></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="do">##  [1] "climate_aridity_index_average"   "climate_hypervolume"            </span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="do">##  [3] "climate_bio1_average"            "climate_bio15_minimum"          </span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="do">##  [5] "bias_area_km2"                   "bias_species_per_record"        </span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="do">##  [7] "climate_velocity_lgm_average"    "neighbors_count"                </span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="do">##  [9] "neighbors_percent_shared_edge"   "human_population_density"       </span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="do">## [11] "topography_elevation_average"    "landcover_herbs_percent_average"</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="do">## [13] "fragmentation_cohesion"          "fragmentation_division"         </span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="do">## [15] "neighbors_area"                  "human_population"</span></span></code></pre></div>
</div>
<div id="finding-promising-variable-interactions" class="section level1">
<h1 class="hasAnchor">
<a href="#finding-promising-variable-interactions" class="anchor"></a>Finding promising variable interactions</h1>
<p>Random Forests already takes into account variable interactions of the form “variable <code>a</code> becomes important when <code>b</code> is higher than x”. However, Random Forest can also take advantage of variable interactions of the form <code>a * b</code>, across the complete ranges of the predictors, as they are commonly defined in regression models, and “interactions” (not the proper name, but used here for simplicity) represented by the first component of a PCA on the predictors <code>a</code> and <code>b</code>.</p>
<p>The function <a href="https://blasbenito.github.io/spatialRF/reference/the_feature_engineer.html"><code><a href="reference/the_feature_engineer.html">the_feature_engineer()</a></code></a> tests all possible interactions of both types among the most important predictors, and suggesting the ones not correlated among themselves and with the other predictors inducing an increase in the model’s R squared (or AUC when the response is binary) on independent data via spatial cross-validation (see <code><a href="reference/rf_evaluate.html">rf_evaluate()</a></code>).</p>
<div class="sourceCode" id="cb15"><pre class="r"><span class="no">interactions</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/the_feature_engineer.html">the_feature_engineer</a></span>(
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">plant_richness_df</span>,
  <span class="kw">dependent.variable.name</span> <span class="kw">=</span> <span class="no">dependent.variable.name</span>,
  <span class="kw">predictor.variable.names</span> <span class="kw">=</span> <span class="no">predictor.variable.names</span>,
  <span class="kw">xy</span> <span class="kw">=</span> <span class="no">xy</span>,
  <span class="kw">importance.threshold</span> <span class="kw">=</span> <span class="fl">0.50</span>, <span class="co">#uses 50% best predictors</span>
  <span class="kw">cor.threshold</span> <span class="kw">=</span> <span class="fl">0.60</span>, <span class="co">#max corr between interactions and predictors</span>
  <span class="kw">seed</span> <span class="kw">=</span> <span class="no">random.seed</span>,
  <span class="kw">repetitions</span> <span class="kw">=</span> <span class="fl">100</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">TRUE</span>
  )</pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Fitting and evaluating a model without interactions.</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Testing 28 candidate interactions.</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Interactions identified: 5</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="do">##  ┌──────────────────┬──────────────────┬──────────────────┬──────────────────┐</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="do">##  │ Interaction      │ Importance (% of │        R-squared │     Max cor with │</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="do">##  │                  │             max) │      improvement │       predictors │</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="do">##  ├──────────────────┼──────────────────┼──────────────────┼──────────────────┤</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="do">##  │ bias_area_km2..x │             59.5 │            0.096 │            0.60  │</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="do">##  │ ..bias_species_p │                  │                  │                  │</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="do">##  │ er_record        │                  │                  │                  │</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="do">##  ├──────────────────┼──────────────────┼──────────────────┼──────────────────┤</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="do">##  │ climate_bio1_ave │             97.6 │            0.067 │            0.34  │</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="do">##  │ rage..pca..human │                  │                  │                  │</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="do">##  │ _population_dens │                  │                  │                  │</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="do">##  │ ity              │                  │                  │                  │</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="do">##  ├──────────────────┼──────────────────┼──────────────────┼──────────────────┤</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="do">##  │ climate_bio1_ave │             96.3 │            0.049 │            0.24  │</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="do">##  │ rage..pca..neigh │                  │                  │                  │</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="do">##  │ bors_count       │                  │                  │                  │</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="do">##  ├──────────────────┼──────────────────┼──────────────────┼──────────────────┤</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="do">##  │ human_population │             68.8 │            0.021 │            0.55  │</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="do">##  │ ..x..bias_specie │                  │                  │                  │</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="do">##  │ s_per_record     │                  │                  │                  │</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="do">##  ├──────────────────┼──────────────────┼──────────────────┼──────────────────┤</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="do">##  │ bias_area_km2..p │             63.4 │            0.029 │            0.305 │</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a><span class="do">##  │ ca..neighbors_pe │                  │                  │                  │</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="do">##  │ rcent_shared_edg │                  │                  │                  │</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a><span class="do">##  │ e                │                  │                  │                  │</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a><span class="do">##  └──────────────────┴──────────────────┴──────────────────┴──────────────────┘</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a><span class="do">## Comparing models with and without interactions via spatial cross-validation.</span></span></code></pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-12-1.png"><!-- --></p>
<p>The upper panel in the plot plot above shows the relationship between the interaction and the response variable. It also indicates the gain in R squared (+R2), the importance, in percentage, when used in a model along the other predictors (Imp. (%)), and the maximum Pearson correlation of the interaction with the predictors. The violin-plot shows a comparison of the model with and without the selected interaction made via spatial cross-validation using 100 repetitions (see <a href="https://blasbenito.github.io/spatialRF/reference/rf_evaluate.html"><code><a href="reference/rf_evaluate.html">rf_evaluate()</a></code></a> and <a href="https://blasbenito.github.io/spatialRF/reference/rf_compare.html"><code><a href="reference/rf_compare.html">rf_compare()</a></code></a> for further details).</p>
<p>The function also returns a data frame with all the interactions considered. The columns are:</p>
<ul>
<li>
<code>interaction.name</code>: Interactions computed via multiplication are named <code>a..x..b</code>, while interactions computed via PCA are named <code>a..pca..b</code>.</li>
<li>
<code>interaction.importance</code>: Importance of the interaction expressed as a percentage. If <code>interaction.importance == 100</code>, that means that the interaction is the most important predictor in the model fitted with the interaction and the predictors named in <code>predictor.variable.names</code>.</li>
<li>
<code>interaction.metric.gain</code>: Difference in R squared (or AUC for models fitting a binary response) between a model with and a model without the interaction.</li>
<li>
<code>max.cor.with.predictors</code>: The maximum Pearson correlation of the interaction with the predictors named in <code>predictor.variable.names</code>. Gives an idea of the amount of multicollinearity the interaction introduces in the model.</li>
<li>
<code>variable.a.name</code> and <code>variable.b.name</code>: Names of the predictors involved in the interaction.</li>
<li>
<code>selected</code>: <code>TRUE</code> if the interaction fulfills the selection criteria (importance higher than a threshold, positive gain in R squared or AUC, and Pearson correlation with other predictors lower than a threshold). The selected interactions have a correlation among themselves always lower than the value of the argument <code>cor.threshold</code>.</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="r"><span class="kw pkg">kableExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kbl.html">kbl</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">interactions</span>$<span class="no">screening</span>, <span class="fl">10</span>),
  <span class="kw">format</span> <span class="kw">=</span> <span class="st">"html"</span>
) <span class="kw">%&gt;%</span>
  <span class="kw pkg">kableExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_classic.html">kable_paper</a></span>(<span class="st">"hover"</span>, <span class="kw">full_width</span> <span class="kw">=</span> <span class="no">F</span>)</pre></div>
<table class="table  lightable-paper lightable-hover">
<thead><tr>
<th style="text-align:left;">
interaction.name
</th>
<th style="text-align:right;">
interaction.importance
</th>
<th style="text-align:right;">
interaction.metric.gain
</th>
<th style="text-align:right;">
max.cor.with.predictors
</th>
<th style="text-align:left;">
variable.a.name
</th>
<th style="text-align:left;">
variable.b.name
</th>
<th style="text-align:left;">
selected
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
bias_area_km2..x..bias_species_per_record
</td>
<td style="text-align:right;">
59.547
</td>
<td style="text-align:right;">
0.096
</td>
<td style="text-align:right;">
0.5962899
</td>
<td style="text-align:left;">
bias_area_km2
</td>
<td style="text-align:left;">
bias_species_per_record
</td>
<td style="text-align:left;">
TRUE
</td>
</tr>
<tr>
<td style="text-align:left;">
climate_bio1_average..pca..human_population_density
</td>
<td style="text-align:right;">
97.590
</td>
<td style="text-align:right;">
0.067
</td>
<td style="text-align:right;">
0.3369664
</td>
<td style="text-align:left;">
climate_bio1_average
</td>
<td style="text-align:left;">
human_population_density
</td>
<td style="text-align:left;">
TRUE
</td>
</tr>
<tr>
<td style="text-align:left;">
climate_bio1_average..pca..neighbors_count
</td>
<td style="text-align:right;">
96.310
</td>
<td style="text-align:right;">
0.049
</td>
<td style="text-align:right;">
0.2441858
</td>
<td style="text-align:left;">
climate_bio1_average
</td>
<td style="text-align:left;">
neighbors_count
</td>
<td style="text-align:left;">
TRUE
</td>
</tr>
<tr>
<td style="text-align:left;">
climate_bio1_average..pca..neighbors_percent_shared_edge
</td>
<td style="text-align:right;">
85.298
</td>
<td style="text-align:right;">
0.066
</td>
<td style="text-align:right;">
0.2215337
</td>
<td style="text-align:left;">
climate_bio1_average
</td>
<td style="text-align:left;">
neighbors_percent_shared_edge
</td>
<td style="text-align:left;">
TRUE
</td>
</tr>
<tr>
<td style="text-align:left;">
human_population..x..bias_species_per_record
</td>
<td style="text-align:right;">
68.786
</td>
<td style="text-align:right;">
0.021
</td>
<td style="text-align:right;">
0.5462406
</td>
<td style="text-align:left;">
human_population
</td>
<td style="text-align:left;">
bias_species_per_record
</td>
<td style="text-align:left;">
TRUE
</td>
</tr>
<tr>
<td style="text-align:left;">
climate_bio1_average..pca..bias_species_per_record
</td>
<td style="text-align:right;">
70.269
</td>
<td style="text-align:right;">
0.018
</td>
<td style="text-align:right;">
0.3469834
</td>
<td style="text-align:left;">
climate_bio1_average
</td>
<td style="text-align:left;">
bias_species_per_record
</td>
<td style="text-align:left;">
TRUE
</td>
</tr>
<tr>
<td style="text-align:left;">
bias_area_km2..pca..neighbors_percent_shared_edge
</td>
<td style="text-align:right;">
63.380
</td>
<td style="text-align:right;">
0.029
</td>
<td style="text-align:right;">
0.3046471
</td>
<td style="text-align:left;">
bias_area_km2
</td>
<td style="text-align:left;">
neighbors_percent_shared_edge
</td>
<td style="text-align:left;">
TRUE
</td>
</tr>
<tr>
<td style="text-align:left;">
climate_hypervolume..x..human_population_density
</td>
<td style="text-align:right;">
48.192
</td>
<td style="text-align:right;">
-0.006
</td>
<td style="text-align:right;">
0.5599486
</td>
<td style="text-align:left;">
climate_hypervolume
</td>
<td style="text-align:left;">
human_population_density
</td>
<td style="text-align:left;">
FALSE
</td>
</tr>
<tr>
<td style="text-align:left;">
neighbors_count..pca..neighbors_percent_shared_edge
</td>
<td style="text-align:right;">
63.965
</td>
<td style="text-align:right;">
0.016
</td>
<td style="text-align:right;">
0.1584006
</td>
<td style="text-align:left;">
neighbors_count
</td>
<td style="text-align:left;">
neighbors_percent_shared_edge
</td>
<td style="text-align:left;">
TRUE
</td>
</tr>
<tr>
<td style="text-align:left;">
bias_area_km2..pca..neighbors_count
</td>
<td style="text-align:right;">
56.843
</td>
<td style="text-align:right;">
0.012
</td>
<td style="text-align:right;">
0.2166191
</td>
<td style="text-align:left;">
bias_area_km2
</td>
<td style="text-align:left;">
neighbors_count
</td>
<td style="text-align:left;">
TRUE
</td>
</tr>
</tbody>
</table>
<p>The function returns a data frame with the response variables, the predictors, and the selected interactions that can be used right away as a training data frame. However, the function cannot say whether an interaction <em>makes sense</em>, and it is up to the user to choose wisely whether to select an interaction or not. In this particular case, and just for the sake of simplicity, we will be using the resulting data frame as training data.</p>
<div class="sourceCode" id="cb18"><pre class="r"><span class="co">#adding interaction column to the training data</span>
<span class="no">plant_richness_df</span> <span class="kw">&lt;-</span> <span class="no">interactions</span>$<span class="no">data</span>

<span class="co">#adding interaction name to predictor.variable.names</span>
<span class="no">predictor.variable.names</span> <span class="kw">&lt;-</span> <span class="no">interactions</span>$<span class="no">predictor.variable.names</span></pre></div>
</div>
<div id="fitting-a-non-spatial-random-forest-model-with-rf" class="section level1">
<h1 class="hasAnchor">
<a href="#fitting-a-non-spatial-random-forest-model-with-rf" class="anchor"></a>Fitting a non-spatial Random Forest model with <code>rf()</code>
</h1>
<p>The function <a href="https://blasbenito.github.io/spatialRF/reference/rf.html"><code><a href="reference/rf.html">rf()</a></code></a> is a convenient wrapper for <code><a href="https://rdrr.io/pkg/ranger/man/ranger.html">ranger::ranger()</a></code> used in every modelling function of the <em>spatialRF</em> package. It takes the training data, the names of the response and the predictors, and optionally (to assess the spatial autocorrelation of the residuals), the distance matrix, and a vector of distance thresholds (in the same units as the distances in <strong>distance_matrix</strong>).</p>
<p>These distance thresholds are the neighborhoods at which the model will check the spatial autocorrelation of the residuals. Their values may depend on the spatial scale of the data, and the ecological system under study.</p>
<p>Notice that here I plug the object <code>predictor.variable.names</code>, output of <code><a href="reference/auto_cor.html">auto_cor()</a></code> and <code><a href="reference/auto_vif.html">auto_vif()</a></code>, directly into the <code>predictor.variable.names</code> argument of the <code><a href="reference/rf.html">rf()</a></code> function to fit a random forest model.</p>
<div class="sourceCode" id="cb19"><pre class="r"><span class="no">model.non.spatial</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/rf.html">rf</a></span>(
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">plant_richness_df</span>,
  <span class="kw">dependent.variable.name</span> <span class="kw">=</span> <span class="no">dependent.variable.name</span>,
  <span class="kw">predictor.variable.names</span> <span class="kw">=</span> <span class="no">predictor.variable.names</span>,
  <span class="kw">distance.matrix</span> <span class="kw">=</span> <span class="no">distance.matrix</span>,
  <span class="kw">distance.thresholds</span> <span class="kw">=</span> <span class="no">distance.thresholds</span>,
  <span class="kw">xy</span> <span class="kw">=</span> <span class="no">xy</span>, <span class="co">#not needed by rf, but other functions read it from the model</span>
  <span class="kw">seed</span> <span class="kw">=</span> <span class="no">random.seed</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>
)</pre></div>
<p>The output is a list with several slots containing the information required to interpret the model. The information available in these slots can be plotted (functions named <code>plot_...()</code>), printed to screen (<code>print_...()</code>) and captured for further analyses (<code>get_...()</code>).</p>
<div id="residuals" class="section level2">
<h2 class="hasAnchor">
<a href="#residuals" class="anchor"></a>Residuals</h2>
<p>The slot <strong>residuals</strong> (<code>model.non.spatial$residuals</code>) stores the values of the residuals and the results of the normality and spatial autocorrelation tests, and its content can be plotted with <a href="https://blasbenito.github.io/spatialRF/reference/plot_residuals_diagnostics.html"><code><a href="reference/plot_residuals_diagnostics.html">plot_residuals_diagnostics()</a></code></a>.</p>
<div class="sourceCode" id="cb20"><pre class="r"><span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/plot_residuals_diagnostics.html">plot_residuals_diagnostics</a></span>(
  <span class="no">model.non.spatial</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>
  )</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-16-1.png"><!-- --></p>
<p>The upper panels show the results of the normality test (interpretation in the title), the middle panel shows the relationship between the residuals and the fitted values, important to understand the behavior of the residuals, and the lower panel shows the Moran’s I of the residuals across distance thresholds and their respective p-values (positive for 0 and 1000 km).</p>
</div>
<div id="variable-importance" class="section level2">
<h2 class="hasAnchor">
<a href="#variable-importance" class="anchor"></a>Variable importance</h2>
<div id="global-variable-importance" class="section level3">
<h3 class="hasAnchor">
<a href="#global-variable-importance" class="anchor"></a>Global variable importance</h3>
<p>The slot <strong>importance</strong> (<code>model.non.spatial$variable.importance</code>) contains the variable importance scores. These can be plotted with <a href="https://blasbenito.github.io/spatialRF/reference/plot_importance.html"><code><a href="reference/plot_importance.html">plot_importance()</a></code></a>, printed with <a href="https://blasbenito.github.io/spatialRF/reference/print_importance.html"><code><a href="reference/print_importance.html">print_importance()</a></code></a>, and the dataframe retrieved with <a href="https://blasbenito.github.io/spatialRF/reference/get_importance.html"><code><a href="reference/get_importance.html">get_importance()</a></code></a></p>
<div class="sourceCode" id="cb21"><pre class="r"><span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/plot_importance.html">plot_importance</a></span>(
  <span class="no">model.non.spatial</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>
  )</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-17-1.png"><!-- --></p>
<p>Variable importance represents the increase in mean error (computed on the out-of-bag data) across trees when a predictor is permuted. Values lower than zero would indicate that the variable performs worse than a random one.</p>
<p>If the argument <code>scaled.importance = TRUE</code> is used, the variable importance scores are computed from the scaled data, making the importance scores easier to compare across different models.</p>
<p>The package <a href="https://github.com/ModelOriented/randomForestExplainer"><code>randomForestExplainer</code></a> offers a couple of interesting options to deepen our understanding on variable importance scores. The first one is <code><a href="https://rdrr.io/pkg/randomForestExplainer/man/measure_importance.html">measure_importance()</a></code>, which analyzes the forest to find out the average minimum tree depth at which each variable can be found (<code>mean_min_depth</code>), the number of nodes in which a variable was selected to make a split (<code>no_of_nodes</code>), the number of times the variable was selected as the first one to start a tree (<code>times_a_root</code>), and the probability of a variable to be in more nodes than what it would be expected by chance (<code>p_value</code>).</p>
<div class="sourceCode" id="cb22"><pre class="r"><span class="no">importance.df</span> <span class="kw">&lt;-</span> <span class="kw pkg">randomForestExplainer</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/randomForestExplainer/man/measure_importance.html">measure_importance</a></span>(
  <span class="no">model.non.spatial</span>,
  <span class="kw">measures</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"mean_min_depth"</span>, <span class="st">"no_of_nodes"</span>, <span class="st">"times_a_root"</span>, <span class="st">"p_value"</span>)
  )</pre></div>
<div class="sourceCode" id="cb23"><pre class="r"><span class="kw pkg">kableExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kbl.html">kbl</a></span>(
  <span class="no">importance.df</span> <span class="kw">%&gt;%</span>
    <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(<span class="no">mean_min_depth</span>) <span class="kw">%&gt;%</span>
    <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">p_value</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="no">p_value</span>, <span class="fl">4</span>)),
  <span class="kw">format</span> <span class="kw">=</span> <span class="st">"html"</span>
) <span class="kw">%&gt;%</span>
  <span class="kw pkg">kableExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_classic.html">kable_paper</a></span>(<span class="st">"hover"</span>, <span class="kw">full_width</span> <span class="kw">=</span> <span class="no">F</span>)</pre></div>
<table class="table  lightable-paper lightable-hover">
<thead><tr>
<th style="text-align:left;">
variable
</th>
<th style="text-align:right;">
mean_min_depth
</th>
<th style="text-align:right;">
no_of_nodes
</th>
<th style="text-align:right;">
times_a_root
</th>
<th style="text-align:right;">
p_value
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
climate_bio1_average..pca..neighbors_count
</td>
<td style="text-align:right;">
2.811087
</td>
<td style="text-align:right;">
2098
</td>
<td style="text-align:right;">
86
</td>
<td style="text-align:right;">
0.0000
</td>
</tr>
<tr>
<td style="text-align:left;">
human_population
</td>
<td style="text-align:right;">
2.989940
</td>
<td style="text-align:right;">
2222
</td>
<td style="text-align:right;">
51
</td>
<td style="text-align:right;">
0.0000
</td>
</tr>
<tr>
<td style="text-align:left;">
climate_bio1_average
</td>
<td style="text-align:right;">
3.117996
</td>
<td style="text-align:right;">
1979
</td>
<td style="text-align:right;">
57
</td>
<td style="text-align:right;">
0.0000
</td>
</tr>
<tr>
<td style="text-align:left;">
climate_hypervolume
</td>
<td style="text-align:right;">
3.200133
</td>
<td style="text-align:right;">
2072
</td>
<td style="text-align:right;">
44
</td>
<td style="text-align:right;">
0.0000
</td>
</tr>
<tr>
<td style="text-align:left;">
climate_bio1_average..pca..human_population_density
</td>
<td style="text-align:right;">
3.201070
</td>
<td style="text-align:right;">
1781
</td>
<td style="text-align:right;">
64
</td>
<td style="text-align:right;">
0.4909
</td>
</tr>
<tr>
<td style="text-align:left;">
bias_area_km2..x..bias_species_per_record
</td>
<td style="text-align:right;">
3.379787
</td>
<td style="text-align:right;">
1797
</td>
<td style="text-align:right;">
46
</td>
<td style="text-align:right;">
0.3406
</td>
</tr>
<tr>
<td style="text-align:left;">
human_population_density
</td>
<td style="text-align:right;">
3.454233
</td>
<td style="text-align:right;">
1900
</td>
<td style="text-align:right;">
23
</td>
<td style="text-align:right;">
0.0020
</td>
</tr>
<tr>
<td style="text-align:left;">
bias_species_per_record
</td>
<td style="text-align:right;">
3.564676
</td>
<td style="text-align:right;">
2321
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0.0000
</td>
</tr>
<tr>
<td style="text-align:left;">
bias_area_km2..pca..neighbors_percent_shared_edge
</td>
<td style="text-align:right;">
3.959485
</td>
<td style="text-align:right;">
1712
</td>
<td style="text-align:right;">
33
</td>
<td style="text-align:right;">
0.9519
</td>
</tr>
<tr>
<td style="text-align:left;">
human_population..x..bias_species_per_record
</td>
<td style="text-align:right;">
3.977952
</td>
<td style="text-align:right;">
1780
</td>
<td style="text-align:right;">
32
</td>
<td style="text-align:right;">
0.5006
</td>
</tr>
<tr>
<td style="text-align:left;">
bias_area_km2
</td>
<td style="text-align:right;">
4.186849
</td>
<td style="text-align:right;">
1800
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.3144
</td>
</tr>
<tr>
<td style="text-align:left;">
neighbors_count
</td>
<td style="text-align:right;">
4.204326
</td>
<td style="text-align:right;">
1325
</td>
<td style="text-align:right;">
29
</td>
<td style="text-align:right;">
1.0000
</td>
</tr>
<tr>
<td style="text-align:left;">
topography_elevation_average
</td>
<td style="text-align:right;">
4.306636
</td>
<td style="text-align:right;">
1732
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.8795
</td>
</tr>
<tr>
<td style="text-align:left;">
neighbors_percent_shared_edge
</td>
<td style="text-align:right;">
4.409251
</td>
<td style="text-align:right;">
1700
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
0.9749
</td>
</tr>
<tr>
<td style="text-align:left;">
neighbors_area
</td>
<td style="text-align:right;">
4.643590
</td>
<td style="text-align:right;">
1621
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
1.0000
</td>
</tr>
<tr>
<td style="text-align:left;">
fragmentation_cohesion
</td>
<td style="text-align:right;">
4.770930
</td>
<td style="text-align:right;">
1518
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
1.0000
</td>
</tr>
<tr>
<td style="text-align:left;">
climate_velocity_lgm_average
</td>
<td style="text-align:right;">
4.845155
</td>
<td style="text-align:right;">
1658
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
0.9986
</td>
</tr>
<tr>
<td style="text-align:left;">
climate_aridity_index_average
</td>
<td style="text-align:right;">
4.858302
</td>
<td style="text-align:right;">
1682
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
0.9919
</td>
</tr>
<tr>
<td style="text-align:left;">
landcover_herbs_percent_average
</td>
<td style="text-align:right;">
4.984346
</td>
<td style="text-align:right;">
1656
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.9988
</td>
</tr>
<tr>
<td style="text-align:left;">
climate_bio15_minimum
</td>
<td style="text-align:right;">
5.057002
</td>
<td style="text-align:right;">
1552
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
1.0000
</td>
</tr>
<tr>
<td style="text-align:left;">
fragmentation_division
</td>
<td style="text-align:right;">
5.229187
</td>
<td style="text-align:right;">
1468
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.0000
</td>
</tr>
</tbody>
</table>
</div>
<div id="contribution-of-predictors-to-model-transferability" class="section level3">
<h3 class="hasAnchor">
<a href="#contribution-of-predictors-to-model-transferability" class="anchor"></a>Contribution of predictors to model transferability</h3>
<p>The new function <code><a href="reference/rf_importance.html">rf_importance()</a></code> offers a way to assess to what extent each predictor contributes to model transferability (predictive ability on independent spatial folds measured with <code><a href="reference/rf_evaluate.html">rf_evaluate()</a></code>, see below). It does so by comparing the performance of the full model with models fitted without each one of the predictors. The difference in performance between the full model and a model without a given predictor represents the contribution of such predictor to model transferability.</p>
<div class="sourceCode" id="cb24"><pre class="r"><span class="no">model.non.spatial</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/rf_importance.html">rf_importance</a></span>(
  <span class="kw">model</span> <span class="kw">=</span> <span class="no">model.non.spatial</span>
  )</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-20-1.png"><!-- --></p>
<p>The function results are added to the “importance” slot of the model.</p>
<div class="sourceCode" id="cb25"><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">model.non.spatial</span>$<span class="no">importance</span>)</pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] "per.variable"          "local"                 "oob.per.variable.plot"</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [4] "cv.per.variable.plot"</span></span></code></pre></div>
<p>The data frame “per.variable” contains the columns “importance.cv” (median importance), “importance.cv.mad” (median absolute deviation), “importance.cv.percent” (median importance in percentage), and “importance.cv.percent.mad” (median absolute deviation of the importance in percent). The ggplot object “cv.per.variable.plot” contains the importance plot with the median and the median absolute deviation shown above.</p>
<p>The importance computed by random forest on the out-of-bag data by permutating each predictor (as computed by <code><a href="reference/rf.html">rf()</a></code>) and the contribution of each predictor to model transferability (as computed by <code><a href="reference/rf_importance.html">rf_importance()</a></code>) show a moderate correlation, indicating that both importance measures capture different aspects of the effect of the variables on the model results.</p>
<div class="sourceCode" id="cb27"><pre class="r"><span class="no">model.non.spatial</span>$<span class="no">importance</span>$<span class="no">per.variable</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(
    <span class="kw">x</span> <span class="kw">=</span> <span class="no">importance.oob</span>,
    <span class="kw">y</span> <span class="kw">=</span> <span class="no">importance.cv</span>
  ) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw">size</span> <span class="kw">=</span> <span class="fl">3</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>() +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Importance (out-of-bag)"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Contribution to transferability"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span>(<span class="kw">method</span> <span class="kw">=</span> <span class="st">"lm"</span>, <span class="kw">formula</span> <span class="kw">=</span> <span class="no">y</span> ~ <span class="no">x</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="st">"red4"</span>)</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-22-1.png"><!-- --></p>
</div>
<div id="local-variable-importance" class="section level3">
<h3 class="hasAnchor">
<a href="#local-variable-importance" class="anchor"></a>Local variable importance</h3>
<p>Random forest also computes the average increase in error when a variable is permuted for each case. This is named “local importance”, is stored in <code>model.non.spatial$importance$local</code> as a data frame, and can be retrieved with <a href="https://blasbenito.github.io/spatialRF/reference/get_importance_local.html"><code><a href="reference/get_importance_local.html">get_importance_local()</a></code></a>.</p>
<div class="sourceCode" id="cb28"><pre class="r"><span class="no">local.importance</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/get_importance_local.html">get_importance_local</a></span>(<span class="no">model.non.spatial</span>)</pre></div>
<p>The table below shows the first few records and columns. Larger values indicate larger average errors when estimating a case with the permuted version of the variable, so more important variables will show larger values.</p>
<div class="sourceCode" id="cb29"><pre class="r"><span class="kw pkg">kableExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kbl.html">kbl</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="no">local.importance</span>[<span class="fl">1</span>:<span class="fl">10</span>, <span class="fl">1</span>:<span class="fl">5</span>], <span class="fl">0</span>),
  <span class="kw">format</span> <span class="kw">=</span> <span class="st">"html"</span>
) <span class="kw">%&gt;%</span>
  <span class="kw pkg">kableExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_classic.html">kable_paper</a></span>(<span class="st">"hover"</span>, <span class="kw">full_width</span> <span class="kw">=</span> <span class="no">F</span>)</pre></div>
<table class="table  lightable-paper lightable-hover">
<thead><tr>
<th style="text-align:right;">
climate_aridity_index_average
</th>
<th style="text-align:right;">
climate_hypervolume
</th>
<th style="text-align:right;">
climate_bio1_average
</th>
<th style="text-align:right;">
climate_bio15_minimum
</th>
<th style="text-align:right;">
bias_area_km2
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
-120
</td>
<td style="text-align:right;">
705
</td>
<td style="text-align:right;">
214
</td>
<td style="text-align:right;">
231
</td>
<td style="text-align:right;">
-274
</td>
</tr>
<tr>
<td style="text-align:right;">
502
</td>
<td style="text-align:right;">
-400
</td>
<td style="text-align:right;">
-431
</td>
<td style="text-align:right;">
375
</td>
<td style="text-align:right;">
489
</td>
</tr>
<tr>
<td style="text-align:right;">
-182
</td>
<td style="text-align:right;">
-155
</td>
<td style="text-align:right;">
1152
</td>
<td style="text-align:right;">
46
</td>
<td style="text-align:right;">
-81
</td>
</tr>
<tr>
<td style="text-align:right;">
384
</td>
<td style="text-align:right;">
769
</td>
<td style="text-align:right;">
695
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
-538
</td>
</tr>
<tr>
<td style="text-align:right;">
-399
</td>
<td style="text-align:right;">
-706
</td>
<td style="text-align:right;">
-669
</td>
<td style="text-align:right;">
350
</td>
<td style="text-align:right;">
-627
</td>
</tr>
<tr>
<td style="text-align:right;">
248
</td>
<td style="text-align:right;">
1113
</td>
<td style="text-align:right;">
715
</td>
<td style="text-align:right;">
483
</td>
<td style="text-align:right;">
416
</td>
</tr>
<tr>
<td style="text-align:right;">
195
</td>
<td style="text-align:right;">
705
</td>
<td style="text-align:right;">
513
</td>
<td style="text-align:right;">
286
</td>
<td style="text-align:right;">
332
</td>
</tr>
<tr>
<td style="text-align:right;">
-247
</td>
<td style="text-align:right;">
-629
</td>
<td style="text-align:right;">
506
</td>
<td style="text-align:right;">
-332
</td>
<td style="text-align:right;">
98
</td>
</tr>
<tr>
<td style="text-align:right;">
335
</td>
<td style="text-align:right;">
-519
</td>
<td style="text-align:right;">
1016
</td>
<td style="text-align:right;">
95
</td>
<td style="text-align:right;">
-246
</td>
</tr>
<tr>
<td style="text-align:right;">
275
</td>
<td style="text-align:right;">
1154
</td>
<td style="text-align:right;">
430
</td>
<td style="text-align:right;">
71
</td>
<td style="text-align:right;">
251
</td>
</tr>
</tbody>
</table>
<p>When case coordinates are joined with the local importance scores, it is possible to draw maps showing how variable importance changes over space.</p>
<div class="sourceCode" id="cb30"><pre class="r"><span class="co">#adding coordinates</span>
<span class="no">local.importance</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(
  <span class="no">xy</span>,
  <span class="no">local.importance</span>
  )</pre></div>
<div class="sourceCode" id="cb31"><pre class="r"><span class="co">#colors</span>
<span class="no">color.low</span> <span class="kw">&lt;-</span> <span class="kw pkg">viridis</span><span class="kw ns">::</span><span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/reexports.html">viridis</a></span>(
    <span class="fl">3</span>,
    <span class="kw">option</span> <span class="kw">=</span> <span class="st">"F"</span>
    )[<span class="fl">2</span>]
<span class="no">color.high</span> <span class="kw">&lt;-</span> <span class="kw pkg">viridis</span><span class="kw ns">::</span><span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/reexports.html">viridis</a></span>(
    <span class="fl">3</span>,
    <span class="kw">option</span> <span class="kw">=</span> <span class="st">"F"</span>
    )[<span class="fl">1</span>]

<span class="co">#plot of climate_bio1_average</span>
<span class="no">p1</span> <span class="kw">&lt;-</span> <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(
    <span class="kw">data</span> <span class="kw">=</span> <span class="no">world</span>,
    <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"white"</span>
  ) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(
    <span class="kw">data</span> <span class="kw">=</span> <span class="no">local.importance</span>,
    <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(
      <span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>,
      <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>,
      <span class="kw">color</span> <span class="kw">=</span> <span class="no">climate_bio1_average</span>
    )
  ) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">170</span>, -<span class="fl">30</span>)) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">58</span>, <span class="fl">80</span>)) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_color_gradient2</a></span>(
    <span class="kw">low</span> <span class="kw">=</span> <span class="no">color.low</span>,
    <span class="kw">high</span> <span class="kw">=</span> <span class="no">color.high</span>
    ) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>() +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"climate_bio1_average"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(
    <span class="kw">plot.title</span> <span class="kw">=</span> <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0.5</span>),
    <span class="kw">legend.key.width</span> <span class="kw">=</span> <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/reexports.html">unit</a></span>(<span class="fl">1</span>,<span class="st">"cm"</span>)
    ) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">color</span> <span class="kw">=</span> <span class="st">"Importance"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Longitude"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Latitude"</span>)

<span class="no">p2</span> <span class="kw">&lt;-</span> <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(
    <span class="kw">data</span> <span class="kw">=</span> <span class="no">world</span>,
    <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"white"</span>
  ) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(
    <span class="kw">data</span> <span class="kw">=</span> <span class="no">local.importance</span>,
    <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(
      <span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>,
      <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>,
      <span class="kw">color</span> <span class="kw">=</span> <span class="no">human_population</span>
    )
  ) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">170</span>, -<span class="fl">30</span>)) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">58</span>, <span class="fl">80</span>)) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_color_gradient2</a></span>(
    <span class="kw">low</span> <span class="kw">=</span> <span class="no">color.low</span>,
    <span class="kw">high</span> <span class="kw">=</span> <span class="no">color.high</span>
    ) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>() +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"human_population"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(
    <span class="kw">plot.title</span> <span class="kw">=</span> <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0.5</span>),
    <span class="kw">legend.key.width</span> <span class="kw">=</span> <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/reexports.html">unit</a></span>(<span class="fl">1</span>,<span class="st">"cm"</span>)
    ) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">color</span> <span class="kw">=</span> <span class="st">"Importance"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Longitude"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Latitude"</span>)

<span class="no">p1</span> + <span class="no">p2</span></pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-26-1.png"><!-- --></p>
<p>In these maps, values lower than 0 indicate that for a given record, the permuted version of the variable led to an accuracy score even higher than the one of the non-permuted variable, so again these negative values can be interpreted as “worse than chance”.</p>
</div>
</div>
<div id="response-curves-and-surfaces" class="section level2">
<h2 class="hasAnchor">
<a href="#response-curves-and-surfaces" class="anchor"></a>Response curves and surfaces</h2>
<p>The variable importance scores are also used by the function <a href="https://blasbenito.github.io/spatialRF/reference/plot_response_curves.html"><code><a href="reference/plot_response_curves.html">plot_response_curves()</a></code></a> to plot partial dependence curves for the predictors (by default, only the ones with an importance score above the median). Building the partial dependency curve of a predictor requires setting the other predictors to their quantiles (0.1, 0.5, and 0.9 by default). This helps to understand how the response curve of a variable changes when all the other variables have low, centered, or high values. The function also allows to see the training data</p>
<div class="sourceCode" id="cb32"><pre class="r"><span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/plot_response_curves.html">plot_response_curves</a></span>(
  <span class="no">model.non.spatial</span>,
  <span class="kw">quantiles</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.9</span>),
  <span class="kw">line.color</span> <span class="kw">=</span> <span class="kw pkg">viridis</span><span class="kw ns">::</span><span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/reexports.html">viridis</a></span>(
    <span class="fl">3</span>, <span class="co">#same number of colors as quantiles</span>
    <span class="kw">option</span> <span class="kw">=</span> <span class="st">"F"</span>,
    <span class="kw">end</span> <span class="kw">=</span> <span class="fl">0.9</span>
    ),
  <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">3</span>,
  <span class="kw">show.data</span> <span class="kw">=</span> <span class="fl">TRUE</span>
  )</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-27-1.png"><!-- --></p>
<p>Setting the argument <code>quantiles</code> to 0.5 and setting <code>show.data</code> to <code>FALSE</code> (default optioin) accentuates the shape of the response curves.</p>
<div class="sourceCode" id="cb33"><pre class="r"><span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/plot_response_curves.html">plot_response_curves</a></span>(
  <span class="no">model.non.spatial</span>,
  <span class="kw">quantiles</span> <span class="kw">=</span> <span class="fl">0.5</span>,
  <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">3</span>
  )</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-28-1.png"><!-- --></p>
<p>The package <a href="https://bgreenwell.github.io/pdp/index.html"><code>pdp</code></a> provides a general way to plot partial dependence plots.</p>
<div class="sourceCode" id="cb34"><pre class="r"><span class="kw pkg">pdp</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/pdp/man/partial.html">partial</a></span>(
  <span class="no">model.non.spatial</span>,
  <span class="kw">train</span> <span class="kw">=</span> <span class="no">plant_richness_df</span>,
  <span class="kw">pred.var</span> <span class="kw">=</span> <span class="st">"climate_bio1_average"</span>,
  <span class="kw">plot</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
  <span class="kw">grid.resolution</span> <span class="kw">=</span> <span class="fl">200</span>
  )</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-29-1.png"><!-- --></p>
<p>If you need to do your own plots in a different way, the function <a href="https://blasbenito.github.io/spatialRF/reference/get_response_curves.html"><code><a href="reference/get_response_curves.html">get_response_curves()</a></code></a> returns a data frame with the required data.</p>
<div class="sourceCode" id="cb35"><pre class="r"><span class="no">reponse.curves.df</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/get_response_curves.html">get_response_curves</a></span>(<span class="no">model.non.spatial</span>)</pre></div>
<div class="sourceCode" id="cb36"><pre class="r"><span class="kw pkg">kableExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kbl.html">kbl</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">reponse.curves.df</span>, <span class="kw">n</span> <span class="kw">=</span> <span class="fl">10</span>),
  <span class="kw">format</span> <span class="kw">=</span> <span class="st">"html"</span>
) <span class="kw">%&gt;%</span>
  <span class="kw pkg">kableExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_classic.html">kable_paper</a></span>(<span class="st">"hover"</span>, <span class="kw">full_width</span> <span class="kw">=</span> <span class="no">F</span>)</pre></div>
<table class="table  lightable-paper lightable-hover">
<thead><tr>
<th style="text-align:right;">
response
</th>
<th style="text-align:right;">
predictor
</th>
<th style="text-align:left;">
quantile
</th>
<th style="text-align:right;">
model
</th>
<th style="text-align:left;">
predictor.name
</th>
<th style="text-align:left;">
response.name
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
3081.941
</td>
<td style="text-align:right;">
-4.428994
</td>
<td style="text-align:left;">
0.1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
climate_bio1_average..pca..human_population_density
</td>
<td style="text-align:left;">
richness_species_vascular
</td>
</tr>
<tr>
<td style="text-align:right;">
3081.941
</td>
<td style="text-align:right;">
-4.393562
</td>
<td style="text-align:left;">
0.1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
climate_bio1_average..pca..human_population_density
</td>
<td style="text-align:left;">
richness_species_vascular
</td>
</tr>
<tr>
<td style="text-align:right;">
3081.941
</td>
<td style="text-align:right;">
-4.358129
</td>
<td style="text-align:left;">
0.1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
climate_bio1_average..pca..human_population_density
</td>
<td style="text-align:left;">
richness_species_vascular
</td>
</tr>
<tr>
<td style="text-align:right;">
3081.941
</td>
<td style="text-align:right;">
-4.322697
</td>
<td style="text-align:left;">
0.1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
climate_bio1_average..pca..human_population_density
</td>
<td style="text-align:left;">
richness_species_vascular
</td>
</tr>
<tr>
<td style="text-align:right;">
3081.941
</td>
<td style="text-align:right;">
-4.287265
</td>
<td style="text-align:left;">
0.1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
climate_bio1_average..pca..human_population_density
</td>
<td style="text-align:left;">
richness_species_vascular
</td>
</tr>
<tr>
<td style="text-align:right;">
3081.941
</td>
<td style="text-align:right;">
-4.251833
</td>
<td style="text-align:left;">
0.1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
climate_bio1_average..pca..human_population_density
</td>
<td style="text-align:left;">
richness_species_vascular
</td>
</tr>
<tr>
<td style="text-align:right;">
3081.941
</td>
<td style="text-align:right;">
-4.216400
</td>
<td style="text-align:left;">
0.1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
climate_bio1_average..pca..human_population_density
</td>
<td style="text-align:left;">
richness_species_vascular
</td>
</tr>
<tr>
<td style="text-align:right;">
3081.941
</td>
<td style="text-align:right;">
-4.180968
</td>
<td style="text-align:left;">
0.1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
climate_bio1_average..pca..human_population_density
</td>
<td style="text-align:left;">
richness_species_vascular
</td>
</tr>
<tr>
<td style="text-align:right;">
3081.941
</td>
<td style="text-align:right;">
-4.145536
</td>
<td style="text-align:left;">
0.1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
climate_bio1_average..pca..human_population_density
</td>
<td style="text-align:left;">
richness_species_vascular
</td>
</tr>
<tr>
<td style="text-align:right;">
3081.941
</td>
<td style="text-align:right;">
-4.110104
</td>
<td style="text-align:left;">
0.1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
climate_bio1_average..pca..human_population_density
</td>
<td style="text-align:left;">
richness_species_vascular
</td>
</tr>
</tbody>
</table>
<p>Interactions between two variables can be plotted with <a href="https://blasbenito.github.io/spatialRF/reference/plot_response_surface.html"><code><a href="reference/plot_response_surface.html">plot_response_surface()</a></code></a></p>
<div class="sourceCode" id="cb37"><pre class="r"><span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/plot_response_surface.html">plot_response_surface</a></span>(
  <span class="no">model.non.spatial</span>,
  <span class="kw">a</span> <span class="kw">=</span> <span class="st">"climate_bio1_average"</span>,
  <span class="kw">b</span> <span class="kw">=</span> <span class="st">"neighbors_count"</span>
  )</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-32-1.png"><!-- --></p>
<p>This can be done as well with the <code>pdp</code> package, that uses a slightly different algorithm to plot interaction surfaces.</p>
<div class="sourceCode" id="cb38"><pre class="r"><span class="kw pkg">pdp</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/pdp/man/partial.html">partial</a></span>(
  <span class="no">model.non.spatial</span>,
  <span class="kw">train</span> <span class="kw">=</span> <span class="no">plant_richness_df</span>,
  <span class="kw">pred.var</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"climate_bio1_average"</span>, <span class="st">"neighbors_count"</span>),
  <span class="kw">plot</span> <span class="kw">=</span> <span class="fl">TRUE</span>
  )</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-33-1.png"><!-- --></p>
</div>
<div id="model-performance" class="section level2">
<h2 class="hasAnchor">
<a href="#model-performance" class="anchor"></a>Model performance</h2>
<p>The <strong>performance</strong> slot (in <code>model.non.spatial$performance</code>) contains the values of several performance measures. It be printed via the function <a href="https://blasbenito.github.io/spatialRF/reference/print_performance.html"><code><a href="reference/print_performance.html">print_performance()</a></code></a>.</p>
<div class="sourceCode" id="cb39"><pre class="r"><span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/print_performance.html">print_performance</a></span>(<span class="no">model.non.spatial</span>)</pre></div>
<div class="sourceCode" id="cb40"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Model performance </span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="do">##   - R squared (oob):                  0.6075314</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="do">##   - R squared (cor(obs, pred)^2):     0.9543769</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="do">##   - Pseudo R squared (cor(obs, pred)):0.9769221</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="do">##   - RMSE (oob):                       2111.241</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="do">##   - RMSE:                             902.1424</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="do">##   - Normalized RMSE:                  0.2604337</span></span></code></pre></div>
<ul>
<li>
<code>R squared (oob)</code> and <code>RMSE (oob)</code> are the R squared of the model and its root mean squared error when predicting the out-of-bag data (fraction of data not used to train individual trees). From all the values available in the <code>performance</code> slot, probably these the most honest ones, as it is the closer trying to get a performance estimate on independent data. However, out-of-bag data is not fully independent, and therefore will still be inflated, especially if the data is highly aggregated in space.</li>
<li>
<code>R squared</code> and <code>pseudo R squared</code> are computed from the observations and the predictions, and indicate to what extent model outcomes represent the input data. These values will usually be high the data is highly aggregated in space.</li>
<li>The <code>RMSE</code> and its normalized version are computed via <a href="https://blasbenito.github.io/spatialRF/reference/root_mean_squared_error.html"><code><a href="reference/root_mean_squared_error.html">root_mean_squared_error()</a></code></a>, and are linear with <code>R squared</code> and <code>pseudo R squared</code>.</li>
</ul>
</div>
<div id="spatial-cross-validation" class="section level2">
<h2 class="hasAnchor">
<a href="#spatial-cross-validation" class="anchor"></a>Spatial cross-validation</h2>
<p>The function <a href="https://blasbenito.github.io/spatialRF/reference/rf_evaluate.html">rf_evaluate()</a> overcomes the limitations of the performance scores explained above by providing honest performance based on <em>spatial cross-validation</em>. The function separates the data into a number of spatially independent training and testing folds. Then, it fits a model on each training fold, predicts over each testing fold, and computes statistics of performance measures across folds. Let’s see how it works.</p>
<div class="sourceCode" id="cb41"><pre class="r"><span class="no">model.non.spatial</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/rf_evaluate.html">rf_evaluate</a></span>(
  <span class="kw">model</span> <span class="kw">=</span> <span class="no">model.non.spatial</span>,
  <span class="kw">xy</span> <span class="kw">=</span> <span class="no">xy</span>,                  <span class="co">#data coordinates</span>
  <span class="kw">repetitions</span> <span class="kw">=</span> <span class="fl">30</span>,         <span class="co">#number of spatial folds</span>
  <span class="kw">training.fraction</span> <span class="kw">=</span> <span class="fl">0.75</span>, <span class="co">#training data fraction on each fold</span>
  <span class="kw">metrics</span> <span class="kw">=</span> <span class="st">"r.squared"</span>,
  <span class="kw">seed</span> <span class="kw">=</span> <span class="no">random.seed</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>
)</pre></div>
<p>The function generates a new slot in the model named <strong>evaluation</strong> (<code>model.non.spatial$evaluation</code>) with several objects that summarize the spatial cross-validation results.</p>
<div class="sourceCode" id="cb42"><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">model.non.spatial</span>$<span class="no">evaluation</span>)</pre></div>
<div class="sourceCode" id="cb43"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] "metrics"           "training.fraction" "spatial.folds"    </span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [4] "per.fold"          "per.fold.long"     "per.model"        </span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="do">## [7] "aggregated"</span></span></code></pre></div>
<p>The slot “spatial.folds”, produced by <a href="https://blasbenito.github.io/spatialRF/reference/make_spatial_folds.html"><code><a href="reference/make_spatial_folds.html">make_spatial_folds()</a></code></a>, contains the indices of the training and testing cases for each cross-validation repetition. The maps below show two sets of training and testing folds.</p>
<div class="sourceCode" id="cb44"><pre class="r"><span class="no">pr</span> <span class="kw">&lt;-</span> <span class="no">plant_richness_df</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"x"</span>, <span class="st">"y"</span>)]
<span class="no">pr</span>$<span class="no">group.2</span> <span class="kw">&lt;-</span> <span class="no">pr</span>$<span class="no">group.1</span> <span class="kw">&lt;-</span> <span class="st">"Training"</span>
<span class="no">pr</span>[<span class="no">model.non.spatial</span>$<span class="no">evaluation</span>$<span class="no">spatial.folds</span><span class="kw">[[</span><span class="fl">1</span>]]$<span class="no">testing</span>, <span class="st">"group.1"</span>] <span class="kw">&lt;-</span> <span class="st">"Testing"</span>
<span class="no">pr</span>[<span class="no">model.non.spatial</span>$<span class="no">evaluation</span>$<span class="no">spatial.folds</span><span class="kw">[[</span><span class="fl">25</span>]]$<span class="no">testing</span>, <span class="st">"group.2"</span>] <span class="kw">&lt;-</span> <span class="st">"Testing"</span>

<span class="no">p1</span> <span class="kw">&lt;-</span> <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">world</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"white"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">pr</span>,
          <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(
            <span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>,
            <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>,
            <span class="kw">color</span> <span class="kw">=</span> <span class="no">group.1</span>
            ),
          <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>
          ) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_color_viridis_d</a></span>(
    <span class="kw">direction</span> <span class="kw">=</span> -<span class="fl">1</span>,
    <span class="kw">end</span> <span class="kw">=</span> <span class="fl">0.5</span>,
    <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.8</span>,
    <span class="kw">option</span> <span class="kw">=</span> <span class="st">"F"</span>
    ) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>() +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">color</span> <span class="kw">=</span> <span class="st">"Group"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">170</span>, -<span class="fl">30</span>)) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">58</span>, <span class="fl">80</span>))  +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Spatial fold 1"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(
    <span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"none"</span>,
    <span class="kw">plot.title</span> <span class="kw">=</span> <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0.5</span>)
  ) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Longitude"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Latitude"</span>)

<span class="no">p2</span> <span class="kw">&lt;-</span> <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">world</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"white"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">pr</span>,
          <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(
            <span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>,
            <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>,
            <span class="kw">color</span> <span class="kw">=</span> <span class="no">group.2</span>
            ),
          <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>
          ) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_color_viridis_d</a></span>(
    <span class="kw">direction</span> <span class="kw">=</span> -<span class="fl">1</span>,
    <span class="kw">end</span> <span class="kw">=</span> <span class="fl">0.5</span>,
    <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.8</span>,
    <span class="kw">option</span> <span class="kw">=</span> <span class="st">"F"</span>
    ) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>() +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">color</span> <span class="kw">=</span> <span class="st">"Group"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">170</span>, -<span class="fl">30</span>)) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">58</span>, <span class="fl">80</span>)) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(
    <span class="kw">plot.title</span> <span class="kw">=</span> <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0.5</span>)
  ) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Spatial fold 25"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Longitude"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">""</span>)

<span class="no">p1</span> <span class="kw">|</span> <span class="no">p2</span></pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-37-1.png"><!-- --></p>
<p>The information available in this new slot can be accessed with the functions <a href="https://blasbenito.github.io/spatialRF/reference/print_evaluation.html"><code><a href="reference/print_evaluation.html">print_evaluation()</a></code></a>, <a href="https://blasbenito.github.io/spatialRF/reference/plot_evaluation.html"><code><a href="reference/plot_evaluation.html">plot_evaluation()</a></code></a>, and <a href="https://blasbenito.github.io/spatialRF/reference/get_evaluation.html"><code><a href="reference/get_evaluation.html">get_evaluation()</a></code></a>.</p>
<div class="sourceCode" id="cb45"><pre class="r"><span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/plot_evaluation.html">plot_evaluation</a></span>(<span class="no">model.non.spatial</span>)</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-38-1.png"><!-- --></p>
<p><code>Full</code> represents the R squared of the model trained on the full dataset. <code>Training</code> are the R-squared of the models fitted on the spatial folds (named <code>Training</code> in the maps above), and <code>Testing</code> are the R-squared of the same models on “unseen” data (data not used to train the model, named <code>Testing</code> in the maps above). The median, median absolute deviation (MAD), minimum, and maximum R-squared values on the testing folds can be printed with <code><a href="reference/print_evaluation.html">print_evaluation()</a></code>.</p>
<div class="sourceCode" id="cb46"><pre class="r"><span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/print_evaluation.html">print_evaluation</a></span>(<span class="no">model.non.spatial</span>)</pre></div>
<div class="sourceCode" id="cb47"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Spatial evaluation </span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="do">##   - Training fraction:             0.75</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="do">##   - Spatial folds:                 29</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="do">##     Metric Median   MAD Minimum Maximum</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="do">##  r.squared  0.517 0.085   0.122   0.781</span></span></code></pre></div>
</div>
<div id="other-important-things-stored-in-the-model" class="section level2">
<h2 class="hasAnchor">
<a href="#other-important-things-stored-in-the-model" class="anchor"></a>Other important things stored in the model</h2>
<p>The model predictions are stored in the slot <strong>predictions</strong>, the arguments used to fit the model in <strong>ranger.arguments</strong>, and the model itself, used to predict new values (see code chunk below), is in the <strong>forest</strong> slot.</p>
<div class="sourceCode" id="cb48"><pre class="r"><span class="no">predicted</span> <span class="kw">&lt;-</span> <span class="kw pkg">stats</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(
  <span class="kw">object</span> <span class="kw">=</span> <span class="no">model.non.spatial</span>,
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">plant_richness_df</span>,
  <span class="kw">type</span> <span class="kw">=</span> <span class="st">"response"</span>
  )$<span class="no">predictions</span></pre></div>
</div>
</div>
<div id="fitting-a-spatial-model-with-rf_spatial" class="section level1">
<h1 class="hasAnchor">
<a href="#fitting-a-spatial-model-with-rf_spatial" class="anchor"></a>Fitting a spatial model with <code>rf_spatial()</code>
</h1>
<p>The spatial autocorrelation of the residuals of a model like <code>model.non.spatial</code>, measured with <a href="https://en.wikipedia.org/wiki/Moran%27s_I">Moran’s I</a>, can be plotted with <a href="https://blasbenito.github.io/spatialRF/reference/plot_moran.html"><code><a href="reference/plot_moran.html">plot_moran()</a></code></a>.</p>
<div class="sourceCode" id="cb49"><pre class="r"><span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/plot_moran.html">plot_moran</a></span>(
  <span class="no">model.non.spatial</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>
  )</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-41-1.png"><!-- --> According to the plot, the spatial autocorrelation of the residuals of <code>model.non.spatial</code> is highly positive for a neighborhood of 0 and 1000 km, while it becomes non-significant (p-value &gt; 0.05) at 2000, 4000, and 8000 km. To reduce the spatial autocorrelation of the residuals as much as possible, the non-spatial model can be transformed into a <em>spatial model</em> very easily with the function <a href="https://blasbenito.github.io/spatialRF/reference/rf_spatial.html"><code><a href="reference/rf_spatial.html">rf_spatial()</a></code></a>. This function is the true core of the package!</p>
<div class="sourceCode" id="cb50"><pre class="r"><span class="no">model.spatial</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/rf_spatial.html">rf_spatial</a></span>(
  <span class="kw">model</span> <span class="kw">=</span> <span class="no">model.non.spatial</span>,
  <span class="kw">method</span> <span class="kw">=</span> <span class="st">"mem.moran.sequential"</span>, <span class="co">#default method</span>
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
  <span class="kw">seed</span> <span class="kw">=</span> <span class="no">random.seed</span>
  )</pre></div>
<p>The plot below shows the Moran’s I of the residuals of the spatial model, and indicates that the residuals are not autocorrelated at any distance.</p>
<div class="sourceCode" id="cb51"><pre class="r"><span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/plot_moran.html">plot_moran</a></span>(
  <span class="no">model.spatial</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>
  )</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-43-1.png"><!-- --></p>
<p>If we compare the variable importance plots of both models, we can see that the spatial model has an additional set of dots under the name “spatial_predictors”, and that the maximum importance of a few of these <em>spatial predictors</em> matches the importance of the most relevant non-spatial predictors.</p>
<div class="sourceCode" id="cb52"><pre class="r"><span class="no">p1</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/plot_importance.html">plot_importance</a></span>(
  <span class="no">model.non.spatial</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Non-spatial model"</span>)

<span class="no">p2</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/plot_importance.html">plot_importance</a></span>(
  <span class="no">model.spatial</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Spatial model"</span>)

<span class="no">p1</span> <span class="kw">|</span> <span class="no">p2</span></pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-44-1.png"><!-- --></p>
<p>If we look at the ten most important variables in <code>model.spatial</code> we will see that a few of them are <em>spatial predictors</em>. Spatial predictors are named <code>spatial_predictor_X_Y</code>, where <code>X</code> is the neighborhood distance at which the predictor has been generated, and <code>Y</code> is the index of the predictor.</p>
<div class="sourceCode" id="cb53"><pre class="r"><span class="kw pkg">kableExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kbl.html">kbl</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">model.spatial</span>$<span class="no">importance</span>$<span class="no">per.variable</span>, <span class="kw">n</span> <span class="kw">=</span> <span class="fl">10</span>),
  <span class="kw">format</span> <span class="kw">=</span> <span class="st">"html"</span>
) <span class="kw">%&gt;%</span>
  <span class="kw pkg">kableExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_classic.html">kable_paper</a></span>(<span class="st">"hover"</span>, <span class="kw">full_width</span> <span class="kw">=</span> <span class="no">F</span>)</pre></div>
<table class="table  lightable-paper lightable-hover">
<thead><tr>
<th style="text-align:left;">
variable
</th>
<th style="text-align:right;">
importance
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
spatial_predictor_0_2
</td>
<td style="text-align:right;">
1069.763
</td>
</tr>
<tr>
<td style="text-align:left;">
human_population
</td>
<td style="text-align:right;">
1013.699
</td>
</tr>
<tr>
<td style="text-align:left;">
climate_bio1_average..pca..neighbors_count
</td>
<td style="text-align:right;">
999.135
</td>
</tr>
<tr>
<td style="text-align:left;">
climate_hypervolume
</td>
<td style="text-align:right;">
990.940
</td>
</tr>
<tr>
<td style="text-align:left;">
climate_bio1_average
</td>
<td style="text-align:right;">
943.800
</td>
</tr>
<tr>
<td style="text-align:left;">
climate_bio1_average..pca..human_population_density
</td>
<td style="text-align:right;">
931.109
</td>
</tr>
<tr>
<td style="text-align:left;">
bias_area_km2
</td>
<td style="text-align:right;">
796.926
</td>
</tr>
<tr>
<td style="text-align:left;">
bias_species_per_record
</td>
<td style="text-align:right;">
730.700
</td>
</tr>
<tr>
<td style="text-align:left;">
spatial_predictor_0_1
</td>
<td style="text-align:right;">
700.458
</td>
</tr>
<tr>
<td style="text-align:left;">
bias_area_km2..pca..neighbors_percent_shared_edge
</td>
<td style="text-align:right;">
692.798
</td>
</tr>
</tbody>
</table>
<p>But what are spatial predictors? Spatial predictors, as shown below, are smooth surfaces representing neighborhood among records at different spatial scales. They are computed from the distance matrix in different ways. The ones below are the eigenvectors of the double-centered distance matrix of weights (a.k.a, Moran’s Eigenvector Maps). They represent the effect of spatial proximity among records, helping to represent biogeographic and spatial processes not considered by the non-spatial predictors.</p>
<div class="sourceCode" id="cb54"><pre class="r"><span class="no">spatial.predictors</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/get_spatial_predictors.html">get_spatial_predictors</a></span>(<span class="no">model.spatial</span>)
<span class="no">pr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="no">spatial.predictors</span>, <span class="no">plant_richness_df</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"x"</span>, <span class="st">"y"</span>)])

<span class="no">p1</span> <span class="kw">&lt;-</span> <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">world</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"white"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(
    <span class="kw">data</span> <span class="kw">=</span> <span class="no">pr</span>,
    <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(
      <span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>,
      <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>,
      <span class="kw">color</span> <span class="kw">=</span> <span class="no">spatial_predictor_0_2</span>
    ),
    <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2.5</span>
  ) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_color_viridis_c</a></span>(<span class="kw">option</span> <span class="kw">=</span> <span class="st">"F"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>() +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">color</span> <span class="kw">=</span> <span class="st">"Eigenvalue"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">170</span>, -<span class="fl">30</span>)) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">58</span>, <span class="fl">80</span>))  +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Variable: spatial_predictor_0_2"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>)+
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Longitude"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Latitude"</span>)

<span class="no">p2</span> <span class="kw">&lt;-</span> <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">world</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"white"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(
    <span class="kw">data</span> <span class="kw">=</span> <span class="no">pr</span>,
    <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(
      <span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>,
      <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>,
      <span class="kw">color</span> <span class="kw">=</span> <span class="no">spatial_predictor_0_5</span>,
    ),
    <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2.5</span>
  ) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_color_viridis_c</a></span>(<span class="kw">option</span> <span class="kw">=</span> <span class="st">"F"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>() +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">color</span> <span class="kw">=</span> <span class="st">"Eigenvalue"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">170</span>, -<span class="fl">30</span>)) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">58</span>, <span class="fl">80</span>))  +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Variable: spatial_predictor_0_5"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Longitude"</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">""</span>)

<span class="no">p1</span> <span class="kw">|</span> <span class="no">p2</span></pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-46-1.png"><!-- --></p>
<p>The spatial predictors are included in the model one by one, in the order of their Moran’s I (spatial predictors with Moran’s I lower than 0 are removed). The selection procedure is performed by the function <a href="https://blasbenito.github.io/spatialRF/reference/select_spatial_predictors_sequential.html"><code><a href="reference/select_spatial_predictors_sequential.html">select_spatial_predictors_sequential()</a></code></a>, which finds the smaller subset of spatial predictors maximizing the model’s R squared, and minimizing the Moran’s I of the residuals. This is shown in the optimization plot below (dots linked by lines represent the selected spatial predictors).</p>
<div class="sourceCode" id="cb55"><pre class="r"><span class="no">p</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/plot_optimization.html">plot_optimization</a></span>(<span class="no">model.spatial</span>)</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-47-1.png"><!-- --></p>
</div>
<div id="tuning-random-forest-hyperparameters" class="section level1">
<h1 class="hasAnchor">
<a href="#tuning-random-forest-hyperparameters" class="anchor"></a>Tuning Random Forest hyperparameters</h1>
<p>The model fitted above was based on the default random forest hyperparameters of <code>ranger()</code>, and those might not be the most adequate ones for a given dataset. The function <a href="https://blasbenito.github.io/spatialRF/reference/rf_tuning.html"><code><a href="reference/rf_tuning.html">rf_tuning()</a></code></a> helps the user to choose sensible values for three Random Forest hyperparameters that are critical to model performance:</p>
<ul>
<li>
<code>num.trees</code>: number of regression trees in the forest.</li>
<li>
<code>mtry</code>: number of variables to choose from on each tree split.</li>
<li>
<code>min.node.size</code>: minimum number of cases on a terminal node.</li>
</ul>
<p>These values can be modified in any model fitted with the package using the <code>ranger.arguments</code> argument. The example below shows how to fit a spatial model with a given set of hyperparameters.</p>
<div class="sourceCode" id="cb56"><pre class="r"><span class="no">model.spatial</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/rf_spatial.html">rf_spatial</a></span>(
  <span class="kw">model</span> <span class="kw">=</span> <span class="no">model.non.spatial</span>,
  <span class="kw">method</span> <span class="kw">=</span> <span class="st">"mem.moran.sequential"</span>, <span class="co">#default method</span>
  <span class="kw">ranger.arguments</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    <span class="kw">mtry</span> <span class="kw">=</span> <span class="fl">5</span>,
    <span class="kw">min.node.size</span> <span class="kw">=</span> <span class="fl">20</span>,
    <span class="kw">num.trees</span> <span class="kw">=</span> <span class="fl">1000</span>
  ),
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
  <span class="kw">seed</span> <span class="kw">=</span> <span class="no">random.seed</span>
  )</pre></div>
<p>The usual method for model tuning relies on a grid search exploring the results of all the combinations of hyperparameters selected by the user. In <code>spatialRF</code>, model tuning is done via spatial cross-validation, to ensure that the selected combination of hyperparameters maximizes the ability of the model to predict over data not used to train it. <strong>Warning</strong>: model tuning consumes a lot of computational resources, using it on large datasets might freeze your computer.</p>
<p><strong>WARNING</strong>: model tunning is very RAM-hungry, but you can control RAM usage by defining a lower value for the argument <code>n.cores</code>.</p>
<div class="sourceCode" id="cb57"><pre class="r"><span class="no">model.spatial</span> <span class="kw">&lt;-</span> <span class="fu"><a href="reference/rf_tuning.html">rf_tuning</a></span>(
  <span class="kw">model</span> <span class="kw">=</span> <span class="no">model.spatial</span>,
  <span class="kw">xy</span> <span class="kw">=</span> <span class="no">xy</span>,
  <span class="kw">repetitions</span> <span class="kw">=</span> <span class="fl">30</span>,
  <span class="kw">num.trees</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">500</span>, <span class="fl">1000</span>),
  <span class="kw">mtry</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(
    <span class="fl">2</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">model.spatial</span>$<span class="no">ranger.arguments</span>$<span class="no">predictor.variable.names</span>), <span class="co">#number of predictors</span>
    <span class="kw">by</span> <span class="kw">=</span> <span class="fl">9</span>),
  <span class="kw">min.node.size</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">5</span>, <span class="fl">15</span>),
  <span class="kw">seed</span> <span class="kw">=</span> <span class="no">random.seed</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>
)</pre></div>
<p>The function returns a tuned model only if the tuning finds a solution better than the original model. Otherwise the original model is returned. The results of the tuning are stored in the model under the name “tuning”.</p>
</div>
<div id="repeating-a-model-execution" class="section level1">
<h1 class="hasAnchor">
<a href="#repeating-a-model-execution" class="anchor"></a>Repeating a model execution</h1>
<p>Random Forest is an stochastic algorithm that yields slightly different results on each run unless a random seed is set. This particularity has implications for the interpretation of variable importance scores and response curves. The function <a href="https://blasbenito.github.io/spatialRF/reference/rf_repeat.html"><code><a href="reference/rf_repeat.html">rf_repeat()</a></code></a> repeats a model execution and yields the distribution of importance scores of the predictors across executions. <strong>NOTE</strong>: this function works better when used at the end of a workflow</p>
<div class="sourceCode" id="cb58"><pre class="r"><span class="no">model.spatial.repeat</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/rf_repeat.html">rf_repeat</a></span>(
  <span class="kw">model</span> <span class="kw">=</span> <span class="no">model.spatial</span>,
  <span class="kw">repetitions</span> <span class="kw">=</span> <span class="fl">30</span>,
  <span class="kw">seed</span> <span class="kw">=</span> <span class="no">random.seed</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>
)</pre></div>
<p>The importance scores of a model fitted with <code><a href="reference/rf_repeat.html">rf_repeat()</a></code> are plotted as a violin plot, with the distribution of the importance scores of each predictor across repetitions.</p>
<div class="sourceCode" id="cb59"><pre class="r"><span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/plot_importance.html">plot_importance</a></span>(
  <span class="no">model.spatial.repeat</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>
  )</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-51-1.png"><!-- --></p>
<p>The response curves of models fitted with <code><a href="reference/rf_repeat.html">rf_repeat()</a></code> can be plotted with <code><a href="reference/plot_response_curves.html">plot_response_curves()</a></code> as well. The median prediction is shown with a thicker line.</p>
<div class="sourceCode" id="cb60"><pre class="r"><span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/plot_response_curves.html">plot_response_curves</a></span>(
  <span class="no">model.spatial.repeat</span>,
  <span class="kw">quantiles</span> <span class="kw">=</span> <span class="fl">0.5</span>,
  <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">3</span>
  )</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-52-1.png"><!-- --></p>
<p>The function <code><a href="reference/print_performance.html">print_performance()</a></code> generates a summary of the performance scores across model repetitions. As every other function of the package involving repetitions, the provided stats are the median, and the median absolute deviation (mad).</p>
<div class="sourceCode" id="cb61"><pre class="r"><span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/print_performance.html">print_performance</a></span>(<span class="no">model.spatial.repeat</span>)</pre></div>
<div class="sourceCode" id="cb62"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Model performance (median +/- mad) </span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="do">##   - R squared (oob):              0.577 +/- 0.0079</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="do">##   - R squared (cor(obs, pred)^2): 0.958 +/- 0.002</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="do">##   - Pseudo R squared:             0.979 +/- 0.001</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="do">##   - RMSE (oob):                   2192.425 +/- 20.3572</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="do">##   - RMSE:                         919.711 +/- 10.1341</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="do">##   - Normalized RMSE:              0.266 +/- 0.0029</span></span></code></pre></div>
</div>
<div id="taking-advantage-of-the--pipe" class="section level1">
<h1 class="hasAnchor">
<a href="#taking-advantage-of-the--pipe" class="anchor"></a>Taking advantage of the <code>%&gt;%</code> pipe</h1>
<p>The modeling functions of <code>spatialRF</code> are designed to facilitate using the pipe to combine them. The code below fits a spatial model, tunes its hyperparameters, evaluates it using spatial cross-validation, and repeats the execution several times, just by passing the model from one function to another. Replace <code>eval = FALSE</code> with <code>eval = TRUE</code> if you want to execute the code chunk.</p>
<div class="sourceCode" id="cb63"><pre class="r"><span class="no">model.full</span> <span class="kw">&lt;-</span> <span class="fu"><a href="reference/rf_spatial.html">rf_spatial</a></span>(
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">plant_richness_df</span>,
  <span class="kw">dependent.variable.name</span> <span class="kw">=</span> <span class="no">dependent.variable.name</span>,
  <span class="kw">predictor.variable.names</span> <span class="kw">=</span> <span class="no">predictor.variable.names</span>,
  <span class="kw">distance.matrix</span> <span class="kw">=</span> <span class="no">distance_matrix</span>,
  <span class="kw">distance.thresholds</span> <span class="kw">=</span> <span class="no">distance.thresholds</span>,
  <span class="kw">xy</span> <span class="kw">=</span> <span class="no">xy</span>
) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="reference/rf_tuning.html">rf_tuning</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="reference/rf_evaluate.html">rf_evaluate</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="reference/rf_repeat.html">rf_repeat</a></span>()</pre></div>
<p>The code structure shown above can also be used to take advantage of a custom cluster, either defined in the local host, or a Beowulf cluster.</p>
<p>When working with a single machine, a cluster can be defined and used as follows:</p>
<div class="sourceCode" id="cb64"><pre class="r"><span class="co">#creating and registering the cluster</span>
<span class="no">local.cluster</span> <span class="kw">&lt;-</span> <span class="kw pkg">parallel</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">makeCluster</a></span>(
  <span class="kw pkg">parallel</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span>() - <span class="fl">1</span>,
  <span class="kw">type</span> <span class="kw">=</span> <span class="st">"PSOCK"</span>
)
<span class="kw pkg">doParallel</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span>(<span class="kw">cl</span> <span class="kw">=</span> <span class="no">local.cluster</span>)

<span class="co">#fitting, tuning, evaluating, and repeating a model</span>
<span class="no">model.full</span> <span class="kw">&lt;-</span> <span class="fu"><a href="reference/rf_spatial.html">rf_spatial</a></span>(
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">plant_richness_df</span>,
  <span class="kw">dependent.variable.name</span> <span class="kw">=</span> <span class="no">dependent.variable.name</span>,
  <span class="kw">predictor.variable.names</span> <span class="kw">=</span> <span class="no">predictor.variable.names</span>,
  <span class="kw">distance.matrix</span> <span class="kw">=</span> <span class="no">distance_matrix</span>,
  <span class="kw">distance.thresholds</span> <span class="kw">=</span> <span class="no">distance.thresholds</span>,
  <span class="kw">xy</span> <span class="kw">=</span> <span class="no">xy</span>,
  <span class="kw">cluster</span> <span class="kw">=</span> <span class="no">local.cluster</span> <span class="co">#is passed via pipe to the other functions</span>
) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="reference/rf_tuning.html">rf_tuning</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="reference/rf_evaluate.html">rf_evaluate</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="reference/rf_repeat.html">rf_repeat</a></span>()

<span class="co">#stopping the cluster</span>
<span class="kw pkg">parallel</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">stopCluster</a></span>(<span class="kw">cl</span> <span class="kw">=</span> <span class="no">local.cluster</span>)</pre></div>
<p>To facilitate working with Beowulf clusters (<a href="https://www.blasbenito.com/post/01_home_cluster/">just several computers connected via SSH</a>), the package provides the function <code><a href="reference/beowulf_cluster.html">beowulf_cluster()</a></code>, that generates the cluster definition from details such as the IPs of the machines, the number of cores to be used on each machine, the user name, and the connection port.</p>
<div class="sourceCode" id="cb65"><pre class="r"><span class="co">#creating and registering the cluster</span>
<span class="no">beowulf.cluster</span> <span class="kw">&lt;-</span> <span class="fu"><a href="reference/beowulf_cluster.html">beowulf_cluster</a></span>(
  <span class="kw">cluster.ips</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(
    <span class="st">"10.42.0.1"</span>,
    <span class="st">"10.42.0.34"</span>,
    <span class="st">"10.42.0.104"</span>
  ),
  <span class="kw">cluster.cores</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">7</span>, <span class="fl">4</span>, <span class="fl">4</span>),
  <span class="kw">cluster.user</span> <span class="kw">=</span> <span class="st">"blas"</span>,
  <span class="kw">cluster.port</span> <span class="kw">=</span> <span class="st">"11000"</span>
)

<span class="co">#fitting, tuning, evaluating, and repeating a model</span>
<span class="no">model.full</span> <span class="kw">&lt;-</span> <span class="fu"><a href="reference/rf_spatial.html">rf_spatial</a></span>(
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">plant_richness_df</span>,
  <span class="kw">dependent.variable.name</span> <span class="kw">=</span> <span class="no">dependent.variable.name</span>,
  <span class="kw">predictor.variable.names</span> <span class="kw">=</span> <span class="no">predictor.variable.names</span>,
  <span class="kw">distance.matrix</span> <span class="kw">=</span> <span class="no">distance_matrix</span>,
  <span class="kw">distance.thresholds</span> <span class="kw">=</span> <span class="no">distance.thresholds</span>,
  <span class="kw">xy</span> <span class="kw">=</span> <span class="no">xy</span>,
  <span class="kw">cluster</span> <span class="kw">=</span> <span class="no">beowulf.cluster</span>
) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="reference/rf_tuning.html">rf_tuning</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="reference/rf_evaluate.html">rf_evaluate</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="reference/rf_repeat.html">rf_repeat</a></span>()

<span class="kw pkg">doParallel</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span>(<span class="kw">cl</span> <span class="kw">=</span> <span class="no">beowulf.cluster</span>)</pre></div>
</div>
<div id="comparing-several-models" class="section level1">
<h1 class="hasAnchor">
<a href="#comparing-several-models" class="anchor"></a>Comparing several models</h1>
<p>The function <a href="https://blasbenito.github.io/spatialRF/reference/rf_compare.html"><code><a href="reference/rf_compare.html">rf_compare()</a></code></a> takes named list with as many models as the user needs to compare, and applies <code><a href="reference/rf_evaluate.html">rf_evaluate()</a></code> to each one of them to compare their predictive performances across spatial folds.</p>
<div class="sourceCode" id="cb66"><pre class="r"><span class="no">comparison</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/rf_compare.html">rf_compare</a></span>(
  <span class="kw">models</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    <span class="kw">`Non-spatial`</span> <span class="kw">=</span> <span class="no">model.non.spatial</span>,
    <span class="kw">`Spatial`</span> <span class="kw">=</span> <span class="no">model.spatial</span>
  ),
  <span class="kw">xy</span> <span class="kw">=</span> <span class="no">xy</span>,
  <span class="kw">repetitions</span> <span class="kw">=</span> <span class="fl">30</span>,
  <span class="kw">training.fraction</span> <span class="kw">=</span> <span class="fl">0.8</span>,
  <span class="kw">metrics</span> <span class="kw">=</span> <span class="st">"r.squared"</span>,
  <span class="kw">seed</span> <span class="kw">=</span> <span class="no">random.seed</span>
  )</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-57-1.png"><!-- --></p>
<div class="sourceCode" id="cb67"><pre class="r"><span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">comparison</span>$<span class="no">comparison.df</span> <span class="kw">%&gt;%</span>
    <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">model</span>, <span class="no">metric</span>) <span class="kw">%&gt;%</span>
    <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="kw">value</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span>(<span class="no">value</span>), <span class="fl">3</span>)) <span class="kw">%&gt;%</span>
    <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(<span class="no">metric</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>()
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">x</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Model"</span>, <span class="st">"Metric"</span>, <span class="st">"Median"</span>)
<span class="kw pkg">kableExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kbl.html">kbl</a></span>(
  <span class="no">x</span>,
  <span class="kw">format</span> <span class="kw">=</span> <span class="st">"html"</span>
  ) <span class="kw">%&gt;%</span>
  <span class="kw pkg">kableExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_classic.html">kable_paper</a></span>(<span class="st">"hover"</span>, <span class="kw">full_width</span> <span class="kw">=</span> <span class="no">F</span>)</pre></div>
<table class="table  lightable-paper lightable-hover">
<thead><tr>
<th style="text-align:left;">
Model
</th>
<th style="text-align:left;">
Metric
</th>
<th style="text-align:right;">
Median
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
Non-spatial
</td>
<td style="text-align:left;">
r.squared
</td>
<td style="text-align:right;">
0.494
</td>
</tr>
<tr>
<td style="text-align:left;">
Spatial
</td>
<td style="text-align:left;">
r.squared
</td>
<td style="text-align:right;">
0.302
</td>
</tr>
</tbody>
</table>
</div>
<div id="working-with-a-binomial-response" class="section level1">
<h1 class="hasAnchor">
<a href="#working-with-a-binomial-response" class="anchor"></a>Working with a binomial response</h1>
<p>This package can also perform binomial regression on response variables with zeros and ones. Let’s work on a quick example by turning the response variable of the previous models into a binomial one.</p>
<div class="sourceCode" id="cb68"><pre class="r"><span class="no">plant_richness_df</span>$<span class="no">response_binomial</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(
  <span class="no">plant_richness_df</span>$<span class="no">richness_species_vascular</span> <span class="kw">&gt;</span> <span class="fl">5000</span>,
  <span class="fl">1</span>,
  <span class="fl">0</span>
)</pre></div>
<p>The new response variable, <code>response_binomial</code>, will have ones where <code>richness_species_vascular &gt; 5000</code>, and zeros otherwise. This would be equivalent to having the classes “high richness” (represented by the ones) and “low richness”, represented by the zeros. The binomial regression model would then have as objective to compute the probability of each ecoregion to belong to the “high richness” class.</p>
<p>There is something important to notice before moving forward though. The number of zeros in the new response variable is larger than the number of ones.</p>
<div class="sourceCode" id="cb69"><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">plant_richness_df</span>$<span class="no">response_binomial</span>)</pre></div>
<div class="sourceCode" id="cb70"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="do">##   0   1 </span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 165  62</span></span></code></pre></div>
<p>This means that there is <strong>class imbalance</strong>, and under this scenario, any random forest model is going to get better at predicting the most abundant class, while in our case the “target” is the less abundant one. But the function <code><a href="reference/rf.html">rf()</a></code> is ready to deal with this issue. Let’s fit a model to see what am I talking about.</p>
<div class="sourceCode" id="cb71"><pre class="r"><span class="no">model.non.spatial</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/rf.html">rf</a></span>(
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">plant_richness_df</span>,
  <span class="kw">dependent.variable.name</span> <span class="kw">=</span> <span class="st">"response_binomial"</span>,
  <span class="kw">predictor.variable.names</span> <span class="kw">=</span> <span class="no">predictor.variable.names</span>,
  <span class="kw">distance.matrix</span> <span class="kw">=</span> <span class="no">distance.matrix</span>,
  <span class="kw">distance.thresholds</span> <span class="kw">=</span> <span class="no">distance.thresholds</span>,
  <span class="kw">seed</span> <span class="kw">=</span> <span class="no">random.seed</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>
)</pre></div>
<p>The function detects that the response variable is binary (using the function <a href="https://blasbenito.github.io/spatialRF/reference/is_binary.html"><code><a href="reference/is_binary.html">is_binary()</a></code></a>), and computes <em>case weights</em> for the ones and the zeros. These case weights are stored in the <code>ranger.arguments</code> slot of the model, and are used to give preference to the cases with larger weights during the selection of the out-of-bag data (check the <code>case.weights</code> argument in <code><a href="https://rdrr.io/pkg/ranger/man/ranger.html">ranger::ranger()</a></code>). As a result, each individual tree in the forest is trained with a similar proportion of zeros and ones, which helps mitigate the class imbalance issue. This method is named <em>weighted Random Forest</em>, and is very well explained in this <a href="https://statistics.berkeley.edu/sites/default/files/tech-reports/666.pdf">white paper</a> that includes the father of Random Forest, Leo Breiman, as coauthor.</p>
<div class="sourceCode" id="cb72"><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="no">model.non.spatial</span>$<span class="no">ranger.arguments</span>$<span class="no">case.weights</span>)</pre></div>
<div class="sourceCode" id="cb73"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.006060606 0.016129032</span></span></code></pre></div>
<p>This model could be projected right away onto a raster stack with maps of the predictors, so, in fact, <code>spatialRF</code> can be used to fit Species Distribution Models, when it actually wasn’t really designed with such a purpose in mind. And as an additional advantage, the model can be evaluated with <code><a href="reference/rf_evaluate.html">rf_evaluate()</a></code>, which is way better than cross-validation via random data-splitting (<a href="https://methodsblog.com/2018/11/29/blockcv-english/">this blog post</a> explains explains why).</p>
<div class="sourceCode" id="cb74"><pre class="r"><span class="no">model.non.spatial</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/rf_evaluate.html">rf_evaluate</a></span>(
  <span class="no">model.non.spatial</span>,
  <span class="kw">xy</span> <span class="kw">=</span> <span class="no">xy</span>,
  <span class="kw">metrics</span> <span class="kw">=</span> <span class="st">"auc"</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>
)

<span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/print_evaluation.html">print_evaluation</a></span>(<span class="no">model.non.spatial</span>)</pre></div>
<div class="sourceCode" id="cb75"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Spatial evaluation </span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="do">##   - Training fraction:             0.75</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="do">##   - Spatial folds:                 29</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="do">##  Metric Median   MAD Minimum Maximum</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="do">##     auc  0.932 0.024    0.83   0.977</span></span></code></pre></div>
<p>The <strong>take away message</strong> here is that you can work with a binomial response with <code>spatialRF</code>, just as you would do with a continuous response, as long as it is represented with zeros and ones. Just remember that the class imbalance problem is tackled via case weights, and that predictive performance is also measured using the Area Under the ROC Curve (AUC).</p>
</div>
<div id="generating-spatial-predictors-for-other-modelling-methods" class="section level1">
<h1 class="hasAnchor">
<a href="#generating-spatial-predictors-for-other-modelling-methods" class="anchor"></a>Generating spatial predictors for other modelling methods</h1>
<p>You might not love Random Forest, but <code>spatialRF</code> loves you, and as such, it gives you tools to generate spatial predictors for other models anyway.</p>
<p>The first step requires generating Moran’s Eigenvector Maps (MEMs) from the distance matrix. Here there are two options, computing MEMs for a single neighborhood distance with <a href="https://blasbenito.github.io/spatialRF/reference/mem.html"><code><a href="reference/mem.html">mem()</a></code></a>, and computing MEMs for several neighborhood distances at once with <a href="https://blasbenito.github.io/spatialRF/reference/mem_multithreshold.html"><code><a href="reference/mem_multithreshold.html">mem_multithreshold()</a></code></a>.</p>
<div class="sourceCode" id="cb76"><pre class="r"><span class="co">#single distance (0km by default)</span>
<span class="no">mems</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/mem.html">mem</a></span>(<span class="kw">distance.matrix</span> <span class="kw">=</span> <span class="no">distance_matrix</span>)

<span class="co">#several distances</span>
<span class="no">mems</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/mem_multithreshold.html">mem_multithreshold</a></span>(
  <span class="kw">distance.matrix</span> <span class="kw">=</span> <span class="no">distance.matrix</span>,
  <span class="kw">distance.thresholds</span> <span class="kw">=</span> <span class="no">distance.thresholds</span>
)</pre></div>
<p>In either case the result is a data frame with Moran’s Eigenvector Maps (“just” the positive eigenvectors of the double-centered distance matrix).</p>
<div class="sourceCode" id="cb77"><pre class="r"><span class="kw pkg">kableExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kbl.html">kbl</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">mems</span>[, <span class="fl">1</span>:<span class="fl">4</span>], <span class="kw">n</span> <span class="kw">=</span> <span class="fl">10</span>),
  <span class="kw">format</span> <span class="kw">=</span> <span class="st">"html"</span>
) <span class="kw">%&gt;%</span>
  <span class="kw pkg">kableExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_classic.html">kable_paper</a></span>(<span class="st">"hover"</span>, <span class="kw">full_width</span> <span class="kw">=</span> <span class="no">F</span>)</pre></div>
<table class="table  lightable-paper lightable-hover">
<thead><tr>
<th style="text-align:right;">
spatial_predictor_0_1
</th>
<th style="text-align:right;">
spatial_predictor_0_2
</th>
<th style="text-align:right;">
spatial_predictor_0_3
</th>
<th style="text-align:right;">
spatial_predictor_0_4
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
0.0259217
</td>
<td style="text-align:right;">
0.0052203
</td>
<td style="text-align:right;">
0.0416969
</td>
<td style="text-align:right;">
-0.0363324
</td>
</tr>
<tr>
<td style="text-align:right;">
0.0996679
</td>
<td style="text-align:right;">
0.0539713
</td>
<td style="text-align:right;">
0.1324480
</td>
<td style="text-align:right;">
0.3826928
</td>
</tr>
<tr>
<td style="text-align:right;">
0.0010477
</td>
<td style="text-align:right;">
-0.0143046
</td>
<td style="text-align:right;">
-0.0443602
</td>
<td style="text-align:right;">
-0.0031386
</td>
</tr>
<tr>
<td style="text-align:right;">
0.0165695
</td>
<td style="text-align:right;">
0.0047991
</td>
<td style="text-align:right;">
0.0307457
</td>
<td style="text-align:right;">
0.0005170
</td>
</tr>
<tr>
<td style="text-align:right;">
0.0225761
</td>
<td style="text-align:right;">
0.0019595
</td>
<td style="text-align:right;">
0.0230368
</td>
<td style="text-align:right;">
-0.0524239
</td>
</tr>
<tr>
<td style="text-align:right;">
0.0155252
</td>
<td style="text-align:right;">
0.0023742
</td>
<td style="text-align:right;">
0.0197953
</td>
<td style="text-align:right;">
-0.0338956
</td>
</tr>
<tr>
<td style="text-align:right;">
0.0229197
</td>
<td style="text-align:right;">
0.0039860
</td>
<td style="text-align:right;">
0.0312561
</td>
<td style="text-align:right;">
-0.0416697
</td>
</tr>
<tr>
<td style="text-align:right;">
-0.2436009
</td>
<td style="text-align:right;">
-0.1155295
</td>
<td style="text-align:right;">
0.0791452
</td>
<td style="text-align:right;">
0.0189996
</td>
</tr>
<tr>
<td style="text-align:right;">
0.0150725
</td>
<td style="text-align:right;">
-0.0158684
</td>
<td style="text-align:right;">
-0.1010284
</td>
<td style="text-align:right;">
0.0095590
</td>
</tr>
<tr>
<td style="text-align:right;">
-0.1187381
</td>
<td style="text-align:right;">
-0.0471879
</td>
<td style="text-align:right;">
0.0359881
</td>
<td style="text-align:right;">
0.0065211
</td>
</tr>
</tbody>
</table>
<p>But not all MEMs are made equal, and you will need to rank them by their Moran’s I. The function <a href="https://blasbenito.github.io/spatialRF/reference/rank_spatial_predictors.html"><code><a href="reference/rank_spatial_predictors.html">rank_spatial_predictors()</a></code></a> will help you do so.</p>
<div class="sourceCode" id="cb78"><pre class="r"><span class="no">mem.rank</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/rank_spatial_predictors.html">rank_spatial_predictors</a></span>(
  <span class="kw">distance.matrix</span> <span class="kw">=</span> <span class="no">distance_matrix</span>,
  <span class="kw">spatial.predictors.df</span> <span class="kw">=</span> <span class="no">mems</span>,
  <span class="kw">ranking.method</span> <span class="kw">=</span> <span class="st">"moran"</span>
)</pre></div>
<p>The output of <code><a href="reference/rank_spatial_predictors.html">rank_spatial_predictors()</a></code> is a list with three slots: “method”, a character string with the name of the ranking method; “criteria”, an ordered data frame with the criteria used to rank the spatial predictors; and “ranking”, a character vector with the names of the spatial predictors in the order of their ranking (it is just the first column of the “criteria” data frame). We can use this “ranking” object to reorder or <code>mems</code> data frame.</p>
<div class="sourceCode" id="cb79"><pre class="r"><span class="no">mems</span> <span class="kw">&lt;-</span> <span class="no">mems</span>[, <span class="no">mem.rank</span>$<span class="no">ranking</span>]

<span class="co">#also:</span>
<span class="co">#mems &lt;- mem.rank$spatial.predictors.df</span></pre></div>
<p>From here, spatial predictors can be included in any model one by one, in the order of the ranking, until the spatial autocorrelation of the residuals becomes neutral, if possible. A little example with a linear model follows.</p>
<div class="sourceCode" id="cb80"><pre class="r"><span class="co">#model definition</span>
<span class="no">predictors</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(
  <span class="st">"climate_aridity_index_average "</span>,
  <span class="st">"climate_bio1_average"</span>,
  <span class="st">"bias_species_per_record"</span>,
  <span class="st">"human_population_density"</span>,
  <span class="st">"topography_elevation_average"</span>,
  <span class="st">"fragmentation_division"</span>
)
<span class="no">model.formula</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(
    <span class="no">dependent.variable.name</span>,
    <span class="st">" ~ "</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(
      <span class="no">predictors</span>,
      <span class="kw">collapse</span> <span class="kw">=</span> <span class="st">" + "</span>
    )
  )
)

<span class="co">#scaling the data</span>
<span class="no">model.data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span>(<span class="no">plant_richness_df</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>()

<span class="co">#fitting the model</span>
<span class="no">m</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(<span class="no">model.formula</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">model.data</span>)

<span class="co">#Moran's I test of the residuals</span>
<span class="no">moran.test</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/moran.html">moran</a></span>(
  <span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">m</span>),
  <span class="kw">distance.matrix</span> <span class="kw">=</span> <span class="no">distance_matrix</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>
)
<span class="no">moran.test</span>$<span class="no">plot</span></pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-68-1.png"><!-- --></p>
<p>According to the Moran’s I test, the model residuals show spatial autocorrelation. Let’s introduce MEMs one by one until the problem is solved.</p>
<div class="sourceCode" id="cb81"><pre class="r"><span class="co">#add mems to the data and applies scale()</span>
<span class="no">model.data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="no">plant_richness_df</span>,
  <span class="no">mems</span>
) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>()

<span class="co">#initialize predictors.i</span>
<span class="no">predictors.i</span> <span class="kw">&lt;-</span> <span class="no">predictors</span>

<span class="co">#iterating through MEMs</span>
<span class="kw">for</span>(<span class="no">mem.i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">mems</span>)){

  <span class="co">#add mem name to model definintion</span>
  <span class="no">predictors.i</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">predictors.i</span>, <span class="no">mem.i</span>)

  <span class="co">#generate model formula with the new spatial predictor</span>
  <span class="no">model.formula.i</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(
      <span class="no">dependent.variable.name</span>,
      <span class="st">" ~ "</span>,
      <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(
        <span class="no">predictors.i</span>,
        <span class="kw">collapse</span> <span class="kw">=</span> <span class="st">" + "</span>
      )
    )
  )

  <span class="co">#fit model</span>
  <span class="no">m.i</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(<span class="no">model.formula.i</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">model.data</span>)

  <span class="co">#Moran's I test</span>
  <span class="no">moran.test.i</span> <span class="kw">&lt;-</span> <span class="fu"><a href="reference/moran.html">moran</a></span>(
    <span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">m.i</span>),
    <span class="kw">distance.matrix</span> <span class="kw">=</span> <span class="no">distance_matrix</span>,
    <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>
  )

  <span class="co">#stop if no autocorrelation</span>
  <span class="kw">if</span>(<span class="no">moran.test.i</span>$<span class="no">test</span>$<span class="no">interpretation</span> <span class="kw">==</span> <span class="st">"No spatial correlation"</span>){
    <span class="kw">break</span>
  }

}<span class="co">#end of loop</span>

<span class="co">#last moran test</span>
<span class="no">moran.test.i</span>$<span class="no">plot</span></pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-69-1.png"><!-- --></p>
<p>Now we can compare the model without spatial predictors <code>m</code> and the model with spatial predictors <code>m.i</code>.</p>
<div class="sourceCode" id="cb82"><pre class="r"><span class="no">comparison.df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">Model</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Non-spatial"</span>, <span class="st">"Spatial"</span>),
  <span class="kw">Predictors</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">predictors</span>), <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">predictors.i</span>)),
  <span class="kw">R_squared</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">m</span>)$<span class="no">r.squared</span>, <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">m.i</span>)$<span class="no">r.squared</span>), <span class="fl">2</span>),
  <span class="kw">AIC</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/AIC.html">AIC</a></span>(<span class="no">m</span>), <span class="fu"><a href="https://rdrr.io/r/stats/AIC.html">AIC</a></span>(<span class="no">m.i</span>)), <span class="fl">0</span>),
  <span class="kw">BIC</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/AIC.html">BIC</a></span>(<span class="no">m</span>), <span class="fu"><a href="https://rdrr.io/r/stats/AIC.html">BIC</a></span>(<span class="no">m.i</span>)), <span class="fl">0</span>),
  <span class="kw">`Moran I`</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">moran.test</span>$<span class="no">test</span>$<span class="no">moran.i</span>, <span class="no">moran.test.i</span>$<span class="no">test</span>$<span class="no">moran.i</span>), <span class="fl">2</span>)
)

<span class="kw pkg">kableExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kbl.html">kbl</a></span>(
  <span class="no">comparison.df</span>,
  <span class="kw">format</span> <span class="kw">=</span> <span class="st">"html"</span>
) <span class="kw">%&gt;%</span>
  <span class="kw pkg">kableExtra</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_classic.html">kable_paper</a></span>(<span class="st">"hover"</span>, <span class="kw">full_width</span> <span class="kw">=</span> <span class="no">F</span>)</pre></div>
<table class="table  lightable-paper lightable-hover">
<thead><tr>
<th style="text-align:left;">
Model
</th>
<th style="text-align:right;">
Predictors
</th>
<th style="text-align:right;">
R_squared
</th>
<th style="text-align:right;">
AIC
</th>
<th style="text-align:right;">
BIC
</th>
<th style="text-align:right;">
Moran.I
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
Non-spatial
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
0.38
</td>
<td style="text-align:right;">
551
</td>
<td style="text-align:right;">
578
</td>
<td style="text-align:right;">
0.21
</td>
</tr>
<tr>
<td style="text-align:left;">
Spatial
</td>
<td style="text-align:right;">
22
</td>
<td style="text-align:right;">
0.50
</td>
<td style="text-align:right;">
533
</td>
<td style="text-align:right;">
615
</td>
<td style="text-align:right;">
0.06
</td>
</tr>
</tbody>
</table>
<p>According to the model comparison, it can be concluded that the addition of spatial predictors, in spite of the increase in complexity, has improved the model. In any case, this is just a simple demonstration of how spatial predictors generated with functions of the <code>spatialRF</code> package can still help you fit spatial models with other modeling methods.</p>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Download from CRAN at <br><a href="https://cloud.r-project.org/package=spatialRF">https://​cloud.r-project.org/​package=spatialRF</a>
</li>
<li>Browse source code at <br><a href="https://github.com/BlasBenito/spatialRF/">https://​github.com/​BlasBenito/​spatialRF/​</a>
</li>
<li>Report a bug at <br><a href="https://github.com/BlasBenito/spatialRF/issues/">https://​github.com/​BlasBenito/​spatialRF/​issues/​</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://www.r-project.org/Licenses/GPL-3">GPL-3</a></small></li>
</ul>
</div>
<div class="citation">
<h2>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html">Citing spatialRF</a></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Blas M. Benito <br><small class="roles"> Author, maintainer, copyright holder </small> <a href="https://orcid.org/0000-0001-5105-7232" target="orcid.widget" aria-label="ORCID"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>

  <div class="dev-status">
<h2>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/blasbenito/spatialRF"><img src="https://img.shields.io/badge/devel%20version-1.1.3-blue.svg" alt="Devel-version"></a></li>
<li><a href="https://lifecycle.r-lib.org/articles/stages.html"><img src="https://img.shields.io/badge/lifecycle-stable-green.svg" alt="lifecycle"></a></li>
<li><a href="https://www.gnu.org/licenses/gpl-3.0.en.html"><img src="https://img.shields.io/badge/license-GPL--3-blue.svg" alt="License"></a></li>
<li><a href="https://zenodo.org/badge/latestdoi/330962704"><img src="https://zenodo.org/badge/330962704.svg" alt="DOI"></a></li>
<li><a href="https://cran.r-project.org/package=spatialRF"><img src="https://www.r-pkg.org/badges/version/spatialRF" alt="CRAN status"></a></li>
<li><a href="https://CRAN.R-project.org/package=spatialRF"><img src="http://cranlogs.r-pkg.org/badges/spatialRF" alt="CRAN_Download_Badge"></a></li>
</ul>
</div>
</div>
</div>


      <footer><div class="copyright">
  <p>Developed by Blas M. Benito.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
