<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="Selects spatial predictors following these steps:
Gets the spatial predictors ranked by rank_spatial_predictors() and fits a model of the form y ~ predictors + best_spatial_predictor_1. The Moran's I of the residuals of this model is used as reference value for the next step.
The remaining spatial predictors are introduced again into rank_spatial_predictors(), and the spatial predictor with the highest ranking is introduced in a new model of the form y ~  predictors + best_spatial_predictor_1 + best_spatial_predictor_2.
Steps 1 and 2 are repeated until the Moran's I doesn't improve for a number of repetitions equal to the 20 percent of the total number of spatial predictors introduced in the function.
This method allows to select the smallest set of spatial predictors that have the largest joint effect in reducing the spatial correlation of the model residuals, while maintaining the model's R-squared as high as possible. As a consequence of running rank_spatial_predictors() on each iteration, this method includes less spatial predictors in the final model than the sequential method implemented in select_spatial_predictors_sequential() would do, while minimizing spatial correlation and maximizing the R squared of the model as much as possible."><title>Finds optimal combinations of spatial predictors — select_spatial_predictors_recursive • spatialRF</title><script src="../deps/jquery-3.6.1/jquery-3.6.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Finds optimal combinations of spatial predictors — select_spatial_predictors_recursive"><meta property="og:description" content="Selects spatial predictors following these steps:
Gets the spatial predictors ranked by rank_spatial_predictors() and fits a model of the form y ~ predictors + best_spatial_predictor_1. The Moran's I of the residuals of this model is used as reference value for the next step.
The remaining spatial predictors are introduced again into rank_spatial_predictors(), and the spatial predictor with the highest ranking is introduced in a new model of the form y ~  predictors + best_spatial_predictor_1 + best_spatial_predictor_2.
Steps 1 and 2 are repeated until the Moran's I doesn't improve for a number of repetitions equal to the 20 percent of the total number of spatial predictors introduced in the function.
This method allows to select the smallest set of spatial predictors that have the largest joint effect in reducing the spatial correlation of the model residuals, while maintaining the model's R-squared as high as possible. As a consequence of running rank_spatial_predictors() on each iteration, this method includes less spatial predictors in the final model than the sequential method implemented in select_spatial_predictors_sequential() would do, while minimizing spatial correlation and maximizing the R squared of the model as much as possible."><!-- mathjax --><script src="file:///usr/share/javascript/mathjax/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><link rel="stylesheet" href="extra.css"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">spatialRF</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.5</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>Tutorials</h6>
    <a class="dropdown-item" href="../articles/non_spatial_models.html">Non-Spatial Random Forest Models</a>
    <a class="dropdown-item" href="../articles/spatial_models.html">Spatial Random Forest Models</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Development</h6>
    <a class="dropdown-item" href="../articles/development_roadmap.html">Development Roadmap</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/BlasBenito/spatialRF/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Finds optimal combinations of spatial predictors</h1>
      <small class="dont-index">Source: <a href="https://github.com/BlasBenito/spatialRF/blob/HEAD/R/select_spatial_predictors_recursive.R" class="external-link"><code>R/select_spatial_predictors_recursive.R</code></a></small>
      <div class="d-none name"><code>select_spatial_predictors_recursive.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Selects spatial predictors following these steps:</p><ol><li><p>Gets the spatial predictors ranked by <code><a href="rank_spatial_predictors.html">rank_spatial_predictors()</a></code> and fits a model of the form <code>y ~ predictors + best_spatial_predictor_1</code>. The Moran's I of the residuals of this model is used as reference value for the next step.</p></li>
<li><p>The remaining spatial predictors are introduced again into <code><a href="rank_spatial_predictors.html">rank_spatial_predictors()</a></code>, and the spatial predictor with the highest ranking is introduced in a new model of the form <code>y ~  predictors + best_spatial_predictor_1 + best_spatial_predictor_2</code>.</p></li>
<li><p>Steps 1 and 2 are repeated until the Moran's I doesn't improve for a number of repetitions equal to the 20 percent of the total number of spatial predictors introduced in the function.</p></li>
</ol><p>This method allows to select the smallest set of spatial predictors that have the largest joint effect in reducing the spatial correlation of the model residuals, while maintaining the model's R-squared as high as possible. As a consequence of running <code><a href="rank_spatial_predictors.html">rank_spatial_predictors()</a></code> on each iteration, this method includes less spatial predictors in the final model than the sequential method implemented in <code><a href="select_spatial_predictors_sequential.html">select_spatial_predictors_sequential()</a></code> would do, while minimizing spatial correlation and maximizing the R squared of the model as much as possible.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">select_spatial_predictors_recursive</span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  dependent.variable.name <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  predictor.variable.names <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  distance.matrix <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  distance.thresholds <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  ranger.arguments <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  spatial.predictors.df <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  spatial.predictors.ranking <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  weight.r.squared <span class="op">=</span> <span class="fl">0.25</span>,</span>
<span>  weight.penalization.n.predictors <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  n.cores <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>,</span>
<span>  cluster <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>data</dt>
<dd><p>Data frame with a response variable and a set of predictors. Default: <code>NULL</code></p></dd>


<dt>dependent.variable.name</dt>
<dd><p>Character string with the name of the response variable. Must be in the column names of <code>data</code>. Default: <code>NULL</code></p></dd>


<dt>predictor.variable.names</dt>
<dd><p>Character vector with the names of the predictive variables. Every element of this vector must be in the column names of <code>data</code>. Default: <code>NULL</code></p></dd>


<dt>distance.matrix</dt>
<dd><p>Squared matrix with the distances among the records in <code>data</code>. The number of rows of <code>distance.matrix</code> and <code>data</code> must be the same. If not provided, the computation of the Moran's I of the residuals is omitted. Default: <code>NULL</code></p></dd>


<dt>distance.thresholds</dt>
<dd><p>Numeric vector with neighborhood distances. All distances in the distance matrix below each value in <code>dustance.thresholds</code> are set to 0 for the computation of Moran's I. If <code>NULL</code>, it defaults to seq(0, max(distance.matrix), length.out = 4). Default: <code>NULL</code></p></dd>


<dt>ranger.arguments</dt>
<dd><p>Named list with <a href="http://imbs-hl.github.io/ranger/reference/ranger.html" class="external-link">ranger</a> arguments (other arguments of this function can also go here). All <a href="http://imbs-hl.github.io/ranger/reference/ranger.html" class="external-link">ranger</a> arguments are set to their default values except for 'importance', that is set to 'permutation' rather than 'none'. Please, consult the help file of <a href="http://imbs-hl.github.io/ranger/reference/ranger.html" class="external-link">ranger</a> if you are not familiar with the arguments of this function.</p></dd>


<dt>spatial.predictors.df</dt>
<dd><p>Data frame of spatial predictors.</p></dd>


<dt>spatial.predictors.ranking</dt>
<dd><p>Ranking of predictors returned by <code><a href="rank_spatial_predictors.html">rank_spatial_predictors()</a></code>.</p></dd>


<dt>weight.r.squared</dt>
<dd><p>Numeric between 0 and 1, weight of R-squared in the optimization index. Default: <code>0.25</code></p></dd>


<dt>weight.penalization.n.predictors</dt>
<dd><p>Numeric between 0 and 1, weight of the penalization for the number of spatial predictors added in the optimization index. Default: <code>0</code></p></dd>


<dt>n.cores</dt>
<dd><p>Integer, number of cores to use. Default: <code>parallel::detectCores() - 1</code></p></dd>


<dt>cluster</dt>
<dd><p>A cluster definition generated by <code><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">parallel::makeCluster()</a></code>. Default: <code>NULL</code></p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>A list with two slots: <code>optimization</code>, a data frame with the index of the spatial predictor added on each iteration, the spatial correlation of the model residuals, and the R-squared of the model, and <code>best.spatial.predictors</code>, that is a character vector with the names of the spatial predictors that minimize the Moran's I of the residuals and maximize the R-squared of the model.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The algorithm works as follows. If the function <code><a href="rank_spatial_predictors.html">rank_spatial_predictors()</a></code> returns 10 ranked spatial predictors (sp1 to sp10, being sp7 the best one), <code>select_spatial_predictors_recursive()</code> is going to first fit the model <code>y ~ predictors + sp7</code>. Then, the spatial predictors sp2 to sp9 are again ranked with <code><a href="rank_spatial_predictors.html">rank_spatial_predictors()</a></code> using the model <code>y ~ predictors + sp7</code> as reference (at this stage, some of the spatial predictors might be dropped due to lack of effect). When the new ranking of spatial predictors is ready (let's say they are sp5, sp3, and sp4), the best one (sp5) is included in the model <code>y ~ predictors + sp7 + sp5</code>, and the remaining ones go again to <code><a href="rank_spatial_predictors.html">rank_spatial_predictors()</a></code> to repeat the process until spatial predictors are depleted.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p>Other spatial_analysis: 
<code><a href="filter_spatial_predictors.html">filter_spatial_predictors</a>()</code>,
<code><a href="mem.html">mem</a>()</code>,
<code><a href="mem_multithreshold.html">mem_multithreshold</a>()</code>,
<code><a href="moran.html">moran</a>()</code>,
<code><a href="moran_multithreshold.html">moran_multithreshold</a>()</code>,
<code><a href="pca.html">pca</a>()</code>,
<code><a href="pca_multithreshold.html">pca_multithreshold</a>()</code>,
<code><a href="rank_spatial_predictors.html">rank_spatial_predictors</a>()</code>,
<code><a href="residuals_diagnostics.html">residuals_diagnostics</a>()</code>,
<code><a href="normality.html">residuals_test</a>()</code>,
<code><a href="select_spatial_predictors_sequential.html">select_spatial_predictors_sequential</a>()</code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/interactive.html" class="external-link">interactive</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    <span class="va">plants_df</span>,</span></span>
<span class="r-in"><span>    <span class="va">plants_response</span>,</span></span>
<span class="r-in"><span>    <span class="va">plants_predictors</span>,</span></span>
<span class="r-in"><span>    <span class="va">plants_distance</span>,</span></span>
<span class="r-in"><span>    <span class="va">plants_rf</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co">#subset to speed up example</span></span></span>
<span class="r-in"><span>  <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">20</span></span></span>
<span class="r-in"><span>  <span class="va">plants_df</span> <span class="op">&lt;-</span> <span class="va">plants_df</span><span class="op">[</span><span class="va">idx</span>, <span class="op">]</span></span></span>
<span class="r-in"><span>  <span class="va">plants_distance</span> <span class="op">&lt;-</span> <span class="va">plants_distance</span><span class="op">[</span><span class="va">idx</span>, <span class="va">idx</span><span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co">#generate spatial predictors</span></span></span>
<span class="r-in"><span>  <span class="va">mems</span> <span class="op">&lt;-</span> <span class="fu"><a href="mem_multithreshold.html">mem_multithreshold</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    distance.matrix <span class="op">=</span> <span class="va">plants_distance</span>,</span></span>
<span class="r-in"><span>    distance.thresholds <span class="op">=</span> <span class="fl">100</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co">#rank them from higher to lower moran</span></span></span>
<span class="r-in"><span>  <span class="va">mems.rank</span> <span class="op">&lt;-</span> <span class="fu"><a href="rank_spatial_predictors.html">rank_spatial_predictors</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    ranking.method <span class="op">=</span> <span class="st">"moran"</span>,</span></span>
<span class="r-in"><span>    spatial.predictors.df <span class="op">=</span> <span class="va">mems</span>,</span></span>
<span class="r-in"><span>    reference.moran.i <span class="op">=</span> <span class="va">plants_rf</span><span class="op">$</span><span class="va">residuals</span><span class="op">$</span><span class="va">autocorrelation</span><span class="op">$</span><span class="va">max.moran</span>,</span></span>
<span class="r-in"><span>    distance.matrix <span class="op">=</span> <span class="va">plants_distance</span>,</span></span>
<span class="r-in"><span>    distance.thresholds <span class="op">=</span> <span class="fl">100</span>,</span></span>
<span class="r-in"><span>    n.cores <span class="op">=</span> <span class="fl">1</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co">#select best subset via sequential addition</span></span></span>
<span class="r-in"><span>  <span class="va">selection</span> <span class="op">&lt;-</span> <span class="fu">select_spatial_predictors_recursive</span><span class="op">(</span></span></span>
<span class="r-in"><span>    data <span class="op">=</span> <span class="va">plants_df</span>,</span></span>
<span class="r-in"><span>    dependent.variable.name <span class="op">=</span> <span class="va">plants_response</span>,</span></span>
<span class="r-in"><span>    predictor.variable.names <span class="op">=</span> <span class="va">plants_predictors</span>,</span></span>
<span class="r-in"><span>    distance.matrix <span class="op">=</span> <span class="va">plants_distance</span>,</span></span>
<span class="r-in"><span>    distance.thresholds <span class="op">=</span> <span class="fl">0</span>,</span></span>
<span class="r-in"><span>    spatial.predictors.df <span class="op">=</span> <span class="va">mems</span>,</span></span>
<span class="r-in"><span>    spatial.predictors.ranking <span class="op">=</span> <span class="va">mems.rank</span>,</span></span>
<span class="r-in"><span>    ranger.arguments <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>num.trees <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    n.cores <span class="op">=</span> <span class="fl">1</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co">#names of selected spatial predictors</span></span></span>
<span class="r-in"><span>  <span class="va">selection</span><span class="op">$</span><span class="va">best.spatial.predictors</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co">#optimization plot</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="plot_optimization.html">plot_optimization</a></span><span class="op">(</span><span class="va">selection</span><span class="op">$</span><span class="va">optimization</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by <a href="https://blasbenito.com" class="external-link">Blas M. Benito</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  

  </body></html>

