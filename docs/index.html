<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Easy Spatial Modeling with Random Forest • spatialRF</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Easy Spatial Modeling with Random Forest">
<meta property="og:description" content="Spatial regression modeling on regular or irregular point data with random forest via generation of spatial predictors from a distance matrix using three different methods: Morans Eigenvector Maps and PCA factors of the distance matrix (Dray, Legendre, and Peres-Neto 2006 &lt;DOI:10.1016/j.ecolmodel.2006.02.015&gt;), and distance matrix columns as explanatory variables (Hengl et al. &lt;DOI:10.7717/peerj.5518&gt;). The spatial predictors allow the model to take into account the spatial structure of the training data and minimize spatial autocorrelation in the model residuals, and provide context to better assess the importance of non-spatial predictors when compared to the importance of the spatial ones. The modelling functions are built around the highly efficient ranger' package (Wright and Ziegler 2017 &lt;DOI:10.18637/jss.v077.i01&gt;), and are designed to run in parallel in a single machine or a Beowulf cluster. The package provides as well tools to reduce multicollinearity, identify important variable interactions, tune random forest hyperparameters, assess model performance on spatially independent data folds, and examine the resulting models via importance plots and response curves and surfaces. ">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">spatialRF</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.7</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/BlasBenito/spatialRF/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">

<div id="spatialrf-easy-spatial-regression-with-random-forest" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#spatialrf-easy-spatial-regression-with-random-forest" class="anchor"></a><code>spatialRF</code>: Easy Spatial Regression with Random Forest</h1></div>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#development">Development</a></li>
<li><a href="#applications">Applications</a></li>
<li><a href="#install">Install</a></li>
<li><a href="#data-requirements">Data requirements</a></li>
<li><a href="#example-data">Example data</a></li>
<li><a href="#finding-promising-variable-interactions">Finding promising variable interactions</a></li>
<li><a href="#reducing-multicollinearity-in-the-predictors">Reducing multicollinearity in the predictors</a></li>
<li><a href="#fitting-a-non-spatial-random-forest-model">Fitting a non-spatial Random Forest model</a></li>
<li><a href="#tuning-random-forest-hyperparameters">Tuning Random Forest hyperparameters</a></li>
<li><a href="#fitting-a-spatial-model">Fitting a spatial model</a></li>
<li><a href="#assessing-model-performance-on-spatially-independent-folds">Assessing model performance on spatially independent folds</a></li>
<li><a href="#comparing-several-models">Comparing several models</a></li>
<li><a href="#generating-spatial-predictors-for-other-models">Generating spatial predictors for other models</a></li>
</ul>
<!---
[![R-CMD-check](https://github.com/BlasBenito/spatialRF/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/BlasBenito/spatialRF/actions/workflows/R-CMD-check.yaml)
--><!-- badges: start -->
<!-- badges: end -->
</div>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>The package <strong>spatialRF</strong> facilitates fitting spatial regression models on regular or irregular data with Random Forest by generating <em>spatial predictors</em> that allow the model to take into account the spatial structure of the training data. The end goal is minimizing the spatial autocorrelation of the model residuals as much as possible.</p>
<p>Two main methods to generate <em>spatial predictors</em> from the distance matrix of the data points are implemented in the package:</p>
<ul>
<li>Moran’s Eigenvector Maps <a href="https://www.sciencedirect.com/science/article/abs/pii/S0304380006000925">(Dray, Legendre, and Peres-Neto 2006)</a>.</li>
<li>Distance matrix columns as explanatory variables <a href="https://peerj.com/articles/5518/">(Hengl et al. 2018)</a>.</li>
</ul>
<p>The package is designed to minimize the amount of code required to fit a spatial model from a training dataset, the names of the response and the predictors, and a distance matrix, as the example below shows.</p>
<div class="sourceCode" id="cb1"><pre class="r"><span class="no">spatial.model</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/rf_spatial.html">rf_spatial</a></span>(
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">your_dataframe</span>,
  <span class="kw">dependent.variable.name</span> <span class="kw">=</span> <span class="st">"your_response_variable"</span>,
  <span class="kw">predictor.variable.names</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"predictor1"</span>, <span class="st">"predictor2"</span>, <span class="no">...</span>, <span class="st">"predictorN"</span>),
  <span class="kw">distance.matrix</span> <span class="kw">=</span> <span class="no">your_distance_matrix</span>
  )</pre></div>
<p>The package, that uses the <code>ranger</code> package under the hood <a href="https://arxiv.org/abs/1508.04409">(Wright and Ziegler 2017)</a>, also provides tools to identify potentially interesting variable interactions, tune random forest hyperparameters, assess model performance on spatially independent data folds, and examine the resulting models via importance plots, response curves, and response surfaces.</p>
</div>
<div id="development" class="section level1">
<h1 class="hasAnchor">
<a href="#development" class="anchor"></a>Development</h1>
<p>This package is reaching its final form, and big changes are not expected at this stage. However, it has many functions, and even though all them have been tested, only one dataset has been used for those tests. You will find bugs, and something will go wrong almost surely. If you have time to report bugs, please, do so in any of the following ways:</p>
<ul>
<li>Open a new issue in the <a href="https://github.com/BlasBenito/spatialRF/issues">Issues GitHub page of the package</a>.</li>
<li>Send me an email explaining the issue and the error messages with enough detail at blasbenito at gmail dot com.</li>
<li>Send a direct message to <a href="https://twitter.com/blasbenito">my twitter account</a> explaining the issue.</li>
</ul>
<p>I will do my best to solve any issues ASAP!</p>
</div>
<div id="applications" class="section level1">
<h1 class="hasAnchor">
<a href="#applications" class="anchor"></a>Applications</h1>
<p>The goal of <code>spatialRF</code> is to help fitting <em>explanatory spatial regression</em>, where the target is to understand how a set of predictors and the spatial structure of the data influences response variable. Therefore, the spatial analyses implemented in the package can be applied to any spatial dataset, regular or irregular, with a sample size between ~100 and ~5000 cases (the higher end will depend on the RAM memory available), a quantitative or binary (values 0 and 1) response variable, and a more or less large set of predictive variables.</p>
<p>All functions but <code><a href="reference/rf_spatial.html">rf_spatial()</a></code> work with non-spatial data as well if the arguments <code>distance.matrix</code> and <code>distance.thresholds</code> are ignored. In such case, the number of cases is no longer limited by the size of the distance matrix, and models can be trained with hundreds of thousands of rows.</p>
<p>However, <strong>when the focus is on fitting spatial models</strong>, and due to the nature of the <em>spatial predictors</em> used to represent the spatial structure of the training data, <strong>there are many things this package cannot do</strong>:</p>
<ul>
<li><p>Predict model results over raster data.</p></li>
<li><p>Predict a model result over another region with a different spatial structure.</p></li>
<li><p>Work with “big data”, whatever that means.</p></li>
<li><p>Imputation or extrapolation (it can be done, but models based on spatial predictors are hardly transferable).</p></li>
<li><p>Take temporal autocorrelation into account (but this is something that might be implemented later on).</p></li>
</ul>
<p>If after considering these limitations you are still interested, follow me, I will show you how it works.</p>
</div>
<div id="install" class="section level1">
<h1 class="hasAnchor">
<a href="#install" class="anchor"></a>Install</h1>
<p>The package is not yet in the CRAN repositories, so at the moment it must be installed from GitHub as follows.</p>
<div class="sourceCode" id="cb2"><pre class="r"><span class="kw pkg">remotes</span><span class="kw ns">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span>(
  <span class="kw">repo</span> <span class="kw">=</span> <span class="st">"blasbenito/spatialRF"</span>,
  <span class="kw">ref</span> <span class="kw">=</span> <span class="st">"development"</span>,
  <span class="kw">force</span> <span class="kw">=</span> <span class="fl">TRUE</span>
  )</pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">##      checking for file ‘/tmp/RtmpLOVV1E/remotes6f8cf2cb93a29/BlasBenito-spatialRF-55b7656/DESCRIPTION’ ...  ✓  checking for file ‘/tmp/RtmpLOVV1E/remotes6f8cf2cb93a29/BlasBenito-spatialRF-55b7656/DESCRIPTION’</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="do">##   ─  preparing ‘spatialRF’:</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="do">##    checking DESCRIPTION meta-information ...  ✓  checking DESCRIPTION meta-information</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="do">##   ─  checking for LF line-endings in source and make files and shell scripts</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="do">##   ─  checking for empty or unneeded directories</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="do">##   ─  building ‘spatialRF_1.0.7.tar.gz’</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="do">##      </span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">spatialRF</span>)</pre></div>
<p>There are a few other libraries that will be useful during this tutorial.</p>
<div class="sourceCode" id="cb5"><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">kableExtra</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">rnaturalearth</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">rnaturalearthdata</span>)</pre></div>
</div>
<div id="data-requirements" class="section level1">
<h1 class="hasAnchor">
<a href="#data-requirements" class="anchor"></a>Data requirements</h1>
<p>The data required to fit random forest models with <code>spatialRF</code> must fulfill several conditions:</p>
<ul>
<li>
<strong>The input format is data.frame</strong>. At the moment, tibbles are not fully supported.</li>
<li>
<strong>The number of rows must be somewhere between 100 and ~5000</strong>, but that will depend on the RAM available in your system. However, this limitation only affects spatial analyses performed with <code><a href="reference/rf_spatial.html">rf_spatial()</a></code>, while all other modeling and plotting functions should work without a distance matrix (if they don’t tell me, that’d be a bug!), and therefore analyses in large datasets can still be done with the package.</li>
<li>
<strong>The number of predictors should be larger than 3</strong>, fitting a Random Forest model is moot otherwise.</li>
<li>
<strong>Factors in the response or the predictors are not explicitly supported in the package</strong>, they may work, or they won’t, but in any case, I designed this package for quantitative data alone. However, binary data with values 0 and 1 in the response variable are supported.</li>
<li>
<strong>Must be free of <code>NA</code></strong>. You can check if there are NA records with <code><a href="https://rdrr.io/r/base/sum.html">sum(apply(df, 2, is.na))</a></code>. If the result is larger than 0, then just execute <code>df &lt;- na.omit(df)</code> to remove rows with empty cells.</li>
<li>
<strong>Columns cannot have zero variance</strong>. This condition can be checked with <code>apply(df, 2, var) == 0</code>. Columns yielding TRUE should be removed.</li>
<li>
<strong>Columns must not yield <code>NaN</code> or <code>Inf</code> when scaled</strong>. You can check each condition with <code><a href="https://rdrr.io/r/base/sum.html">sum(apply(scale(df), 2, is.nan))</a></code> and <code><a href="https://rdrr.io/r/base/sum.html">sum(apply(scale(df), 2, is.infinite))</a></code>. If higher than 0, you can find what columns are giving issues with <code><a href="https://rdrr.io/r/base/lapply.html">sapply(as.data.frame(scale(df)), function(x)any(is.nan(x)))</a></code> and <code><a href="https://rdrr.io/r/base/lapply.html">sapply(as.data.frame(scale(df)), function(x)any(is.infinite(x)))</a></code>. Any column yielding <code>TRUE</code> will generate issues while trying to fit models with <code>spatialRF</code>.</li>
</ul>
</div>
<div id="example-data" class="section level1">
<h1 class="hasAnchor">
<a href="#example-data" class="anchor"></a>Example data</h1>
<p>The package includes an example dataset that fulfills the conditions mentioned above, named <a href="https://blasbenito.github.io/spatialRF/reference/plant_richness_df.html"><code>plant_richness_df</code></a>. It is a data frame with plant species richness and predictors for 227 ecoregions in the Americas, and a distance matrix among the ecoregion edges named, well, <a href="https://blasbenito.github.io/spatialRF/reference/distance_matrix.html"><code>distance_matrix</code></a>.</p>
<div class="sourceCode" id="cb6"><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="no">plant_richness_df</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="no">distance_matrix</span>)

<span class="co">#names of the response variable and the predictors</span>
<span class="no">dependent.variable.name</span> <span class="kw">&lt;-</span> <span class="st">"richness_species_vascular"</span>
<span class="no">predictor.variable.names</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">plant_richness_df</span>)[<span class="fl">5</span>:<span class="fl">21</span>]

<span class="co">#random seed for reproducibility</span>
<span class="no">random.seed</span> <span class="kw">&lt;-</span> <span class="fl">100</span></pre></div>
<p>The response variable of <code>plant_richness_df</code> is “richness_species_vascular”, with the total count of vascular plant species found on each ecoregion. The figure below shows the centroids of each ecoregion along with their associated value of the response variable.</p>
<p><img src="README_files/figure-gfm/unnamed-chunk-22-1.png"><!-- --></p>
<p>The predictors (columns 5 to 21) represent diverse factors that may influence plant richness such as sampling bias, the area of the ecoregion, climatic variables, human presence and impact, topography, geographical fragmentation, and features of the neighbors of each ecoregion. The figure below shows the scatterplots of the response variable (y axis) against each predictor (x axis).</p>
<p><img src="README_files/figure-gfm/unnamed-chunk-23-1.png"><!-- --></p>
<p>The function <code><a href="reference/plot_training_df_moran.html">plot_training_df_moran()</a></code> helps to check the spatial autocorrelation of the response variable and the predictors.</p>
<p><img src="README_files/figure-gfm/unnamed-chunk-24-1.png"><!-- --></p>
</div>
<div id="finding-promising-variable-interactions" class="section level1">
<h1 class="hasAnchor">
<a href="#finding-promising-variable-interactions" class="anchor"></a>Finding promising variable interactions</h1>
<p>Random Forests already takes into account variable interactions of the form “variable <code>a</code> becomes important when <code>b</code> is higher than x”. However, Random Forest can also take advantage of variable interactions of the form <code>a * b</code>, as they are commonly defined in regression models.</p>
<p>The function <a href="https://blasbenito.github.io/spatialRF/reference/rf_interactions.html"><code><a href="reference/rf_interactions.html">rf_interactions()</a></code></a> tests all possible interactions among predictors by using each one of them in a separate model, and suggesting the ones with the higher potential contribution to the model’s R squared and the higher relative importance (presented as a percentage of the maximum importance of a variable in the model).</p>
<div class="sourceCode" id="cb7"><pre class="r"><span class="no">interactions</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/rf_interactions.html">rf_interactions</a></span>(
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">plant_richness_df</span>,
  <span class="kw">dependent.variable.name</span> <span class="kw">=</span> <span class="no">dependent.variable.name</span>,
  <span class="kw">predictor.variable.names</span> <span class="kw">=</span> <span class="no">predictor.variable.names</span>,
  <span class="kw">seed</span> <span class="kw">=</span> <span class="no">random.seed</span>
  )</pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Testing 10 candidate interactions.</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 potential interactions identified.</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="do">## ┌────────────┬────────────┬────────────┐</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="do">## │ Interactio │ Importance │         R2 │</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="do">## │ n          │ (% of max) │ improvemen │</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="do">## │            │            │          t │</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="do">## ├────────────┼────────────┼────────────┤</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="do">## │ human_popu │       93.2 │      0.002 │</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="do">## │ lation_X_b │            │            │</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="do">## │ ias_area_k │            │            │</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="do">## │ m2         │            │            │</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="do">## ├────────────┼────────────┼────────────┤</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="do">## │ human_popu │       82.8 │      0.000 │</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="do">## │ lation_X_h │            │            │</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="do">## │ uman_popul │            │            │</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="do">## │ ation_dens │            │            │</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="do">## │ ity        │            │            │</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="do">## ├────────────┼────────────┼────────────┤</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="do">## │ climate_bi │       77.9 │      0     │</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="do">## │ o1_average │            │            │</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="do">## │ _X_bias_ar │            │            │</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="do">## │ ea_km2     │            │            │</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="do">## └────────────┴────────────┴────────────┘</span></span></code></pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-25-1.png"><!-- --></p>
<p>Here <code><a href="reference/rf_interactions.html">rf_interactions()</a></code> suggests several candidate interactions ordered by their impact on the model. The function cannot say whether an interaction <em>makes sense</em>, and it is up to the user to choose wisely whether to select an interaction or not.</p>
<p>For the sake of the example, I will choose <code>climate_bio1_average_X_bias_area_km2</code>, hypothesizing that ecoregions with higher area (bias_area_km2) and energy (represented by the annual temperature, climate_bio1_average) will have more species of vascular plants (this is just an example, many other rationales are possible when choosing between candidate interactions). The data required to add the interaction to the training data is in the output of <code><a href="reference/rf_interactions.html">rf_interactions()</a></code>.</p>
<div class="sourceCode" id="cb9"><pre class="r"><span class="co">#adding interaction column to the training data</span>
<span class="no">plant_richness_df</span>[, <span class="st">"climate_bio1_average_X_bias_area_km2"</span>] <span class="kw">&lt;-</span> <span class="no">interactions</span>$<span class="no">columns</span>[, <span class="st">"climate_bio1_average_X_bias_area_km2"</span>]

<span class="co">#adding interaction name to predictor.variable.names</span>
<span class="no">predictor.variable.names</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">predictor.variable.names</span>, <span class="st">"climate_bio1_average_X_bias_area_km2"</span>)</pre></div>
</div>
<div id="reducing-multicollinearity-in-the-predictors" class="section level1">
<h1 class="hasAnchor">
<a href="#reducing-multicollinearity-in-the-predictors" class="anchor"></a>Reducing multicollinearity in the predictors</h1>
<p>The functions <a href="https://blasbenito.github.io/spatialRF/reference/auto_cor.html"><code><a href="reference/auto_cor.html">auto_cor()</a></code></a> and <a href="https://blasbenito.github.io/spatialRF/reference/auto_vif.html"><code><a href="reference/auto_vif.html">auto_vif()</a></code></a> help reduce redundancy in the predictors by using different criteria (bivariate R squared vs. <a href="https://www.statisticshowto.com/variance-inflation-factor/">variance inflation factor</a>), while allowing the user to define an <em>order of preference</em>, which can be based either on domain expertise or on a quantitative assessment. The preference order is defined as a character vector in the <code>preference.order</code> argument of both functions, and does not need to include the names of all predictors, but just the ones the user would like to keep in the analysis.</p>
<p>In the example below I give preference to the interaction suggested by <code><a href="reference/rf_interactions.html">rf_interactions()</a></code> over it’s two components, and prioritize climate over other types of predictors (any other choice would be valid, it just depends on the scope of the study). These rules are applied to both <code><a href="reference/auto_cor.html">auto_cor()</a></code> and <code><a href="reference/auto_vif.html">auto_vif()</a></code>, that are executed sequentially by using the <code><a href="https://rdrr.io/pkg/kableExtra/man/reexports.html">%&gt;%</a></code> pipe from the <a href="https://magrittr.tidyverse.org/">magrittr</a> package.</p>
<p>Notice that I have set <code>cor.threshold</code> and <code>vif.threshold</code> to low values because the predictors in <code>plant_richness_df</code> already have little multicollinearity,. The default values (<code>cor.threshold = 0.75</code> and <code>vif.threshold = 5</code>) should work well when combined together for any other set of predictors.</p>
<div class="sourceCode" id="cb10"><pre class="r"><span class="no">preference.order</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(
    <span class="st">"climate_bio1_average_X_bias_area_km2"</span>,
    <span class="st">"climate_aridity_index_average"</span>,
    <span class="st">"climate_hypervolume"</span>,
    <span class="st">"climate_bio1_average"</span>,
    <span class="st">"climate_bio15_minimum"</span>,
    <span class="st">"bias_area_km2"</span>
  )

<span class="no">predictor.variable.names</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/auto_cor.html">auto_cor</a></span>(
  <span class="kw">x</span> <span class="kw">=</span> <span class="no">plant_richness_df</span>[, <span class="no">predictor.variable.names</span>],
  <span class="kw">cor.threshold</span> <span class="kw">=</span> <span class="fl">0.6</span>,
  <span class="kw">preference.order</span> <span class="kw">=</span> <span class="no">preference.order</span>
) <span class="kw">%&gt;%</span>
  <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/auto_vif.html">auto_vif</a></span>(
    <span class="kw">vif.threshold</span> <span class="kw">=</span> <span class="fl">2.5</span>,
    <span class="kw">preference.order</span> <span class="kw">=</span> <span class="no">preference.order</span>
  )</pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="do">## [auto_cor()]: Removed variables: bias_area_km2, human_footprint_average</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="do">## [auto_vif()]: Removed variables: human_population</span></span></code></pre></div>
<p>The output of <code><a href="reference/auto_cor.html">auto_cor()</a></code> or <code><a href="reference/auto_vif.html">auto_vif()</a></code> is of the class “variable_selection”, that can be used as input for the argument <code>predictor.variable.names</code> of any modeling function within the package. An example is shown in the next section.</p>
<div class="sourceCode" id="cb12"><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">predictor.variable.names</span>)</pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] "vif"                  </span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [2] "selected.variables"   </span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="do">## [3] "selected.variables.df"</span></span></code></pre></div>
<p>The slot <code>selected.variables</code> contains the names of the selected predictors.</p>
<div class="sourceCode" id="cb14"><pre class="r"><span class="no">predictor.variable.names</span>$<span class="no">selected.variables</span></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="do">##  [1] "climate_bio1_average_X_bias_area_km2"</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="do">##  [2] "climate_aridity_index_average"       </span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="do">##  [3] "climate_hypervolume"                 </span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="do">##  [4] "climate_bio1_average"                </span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="do">##  [5] "climate_bio15_minimum"               </span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="do">##  [6] "bias_species_per_record"             </span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="do">##  [7] "climate_velocity_lgm_average"        </span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="do">##  [8] "neighbors_count"                     </span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="do">##  [9] "neighbors_percent_shared_edge"       </span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="do">## [10] "human_population_density"            </span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="do">## [11] "topography_elevation_average"        </span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="do">## [12] "landcover_herbs_percent_average"     </span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="do">## [13] "fragmentation_cohesion"              </span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="do">## [14] "fragmentation_division"              </span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="do">## [15] "neighbors_area"</span></span></code></pre></div>
</div>
<div id="fitting-a-non-spatial-random-forest-model" class="section level1">
<h1 class="hasAnchor">
<a href="#fitting-a-non-spatial-random-forest-model" class="anchor"></a>Fitting a non-spatial Random Forest model</h1>
<p>To fit basic Random Forest models <code>spatialRF</code> provides the <a href="https://blasbenito.github.io/spatialRF/reference/rf.html"><code><a href="reference/rf.html">rf()</a></code></a> function. It takes the training data, the names of the response and the predictors, and optionally (to assess the spatial autocorrelation of the residuals), the distance matrix, and a vector of distance thresholds (in the same units as the distances in <strong>distance_matrix</strong>).</p>
<p>These distance thresholds are the neighborhoods at which the model will check the spatial autocorrelation of the residuals. Their values may depend on the spatial scale of the data, and the ecological system under study.</p>
<p>Notice that here I plug the object <code>predictor.variable.names</code>, output of <code><a href="reference/auto_cor.html">auto_cor()</a></code> and <code><a href="reference/auto_vif.html">auto_vif()</a></code>, directly into the <code>predictor.variable.names</code> argument.</p>
<div class="sourceCode" id="cb16"><pre class="r"><span class="no">model.non.spatial</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/rf.html">rf</a></span>(
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">plant_richness_df</span>,
  <span class="kw">dependent.variable.name</span> <span class="kw">=</span> <span class="no">dependent.variable.name</span>,
  <span class="kw">predictor.variable.names</span> <span class="kw">=</span> <span class="no">predictor.variable.names</span>,
  <span class="kw">distance.matrix</span> <span class="kw">=</span> <span class="no">distance_matrix</span>,
  <span class="kw">distance.thresholds</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">1500</span>, <span class="fl">3000</span>),
  <span class="kw">seed</span> <span class="kw">=</span> <span class="no">random.seed</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>
)</pre></div>
<p>The model output can be printed or plotted with a plethora of functions such as <a href="https://blasbenito.github.io/spatialRF/reference/print.html"><code><a href="https://rdrr.io/r/base/print.html">print()</a></code></a>, <a href="https://blasbenito.github.io/spatialRF/reference/print_importance.html"><code><a href="reference/print_importance.html">print_importance()</a></code></a>, <a href="https://blasbenito.github.io/spatialRF/reference/print_performance.html"><code><a href="reference/print_performance.html">print_performance()</a></code></a>, <a href="https://blasbenito.github.io/spatialRF/reference/plot_importance.html"><code><a href="reference/plot_importance.html">plot_importance()</a></code></a>, <a href="https://blasbenito.github.io/spatialRF/reference/print_moran.html"><code><a href="reference/print_moran.html">print_moran()</a></code></a>, <a href="https://blasbenito.github.io/spatialRF/reference/plot_moran.html"><code><a href="reference/plot_moran.html">plot_moran()</a></code></a>, <a href="https://blasbenito.github.io/spatialRF/reference/plot_response_curves.html"><code><a href="reference/plot_response_curves.html">plot_response_curves()</a></code></a>, or <a href="https://blasbenito.github.io/spatialRF/reference/plot_response_surfaces.html"><code>plot_response_surfaces)</code></a>, among many others.</p>
<div class="sourceCode" id="cb17"><pre class="r"><span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/plot_response_curves.html">plot_response_curves</a></span>(<span class="no">model.non.spatial</span>)</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-31-1.png"><!-- --></p>
<p>In the response curves above, the other predictors are set to their quantiles 0.1, 0.5, and 0.8, but the user can change this behavior by modifying the values of the <code>quantiles</code> argument.</p>
<div class="sourceCode" id="cb18"><pre class="r"><span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/plot_response_surfaces.html">plot_response_surfaces</a></span>(
  <span class="no">model.non.spatial</span>,
  <span class="kw">a</span> <span class="kw">=</span> <span class="st">"climate_bio1_average"</span>,
  <span class="kw">b</span> <span class="kw">=</span> <span class="st">"neighbors_count"</span>
  )</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-32-1.png"><!-- --></p>
<p>In this response surface, the predictors that are not shown are set to their medians (but other quantiles are possible).</p>
<div class="sourceCode" id="cb19"><pre class="r"><span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/plot_importance.html">plot_importance</a></span>(<span class="no">model.non.spatial</span>, <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>)</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-33-1.png"><!-- --></p>
<p><strong>Predicting onto new data</strong></p>
<p>Models fitted with <code><a href="reference/rf.html">rf()</a></code> and other <code>rf_X()</code> functions within the package can be predicted onto new data just as it is done with <code>ranger()</code> models:</p>
<div class="sourceCode" id="cb20"><pre class="r"><span class="no">predicted</span> <span class="kw">&lt;-</span> <span class="kw pkg">stats</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(
  <span class="kw">object</span> <span class="kw">=</span> <span class="no">model.non.spatial</span>,
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">plant_richness_df</span>,
  <span class="kw">type</span> <span class="kw">=</span> <span class="st">"response"</span>
  )$<span class="no">predictions</span></pre></div>
<p><strong>verbose = TRUE</strong></p>
<p>Executing the model with the argument <code>verbose</code> set to <code>TRUE</code> (its default value) prints and plots most of the information required to interpret the model output.</p>
<div class="sourceCode" id="cb21"><pre class="r"><span class="no">model.non.spatial</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/rf.html">rf</a></span>(
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">plant_richness_df</span>,
  <span class="kw">dependent.variable.name</span> <span class="kw">=</span> <span class="no">dependent.variable.name</span>,
  <span class="kw">predictor.variable.names</span> <span class="kw">=</span> <span class="no">predictor.variable.names</span>,
  <span class="kw">distance.matrix</span> <span class="kw">=</span> <span class="no">distance_matrix</span>,
  <span class="kw">distance.thresholds</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">1500</span>, <span class="fl">3000</span>),
  <span class="kw">seed</span> <span class="kw">=</span> <span class="no">random.seed</span>
)</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-35-1.png"><!-- --><img src="README_files/figure-gfm/unnamed-chunk-35-2.png"><!-- --></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Model type</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="do">##   - Fitted with:                     ranger()</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="do">##   - Response variable:               richness_species_vascular</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Random forest parameters</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="do">##   - Type:                            Regression</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="do">##   - Number of trees:                 500</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="do">##   - Sample size:                     227</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="do">##   - Number of predictors:            15</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="do">##   - Mtry:                            3</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="do">##   - Minimum node size:               5</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="do">## Model performance </span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="do">##   - R squared (OOB):                 0.954</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="do">##   - Pseudo R squared:                0.977</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="do">##   - RMSE:                            961.388</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="do">##   - Normalized RMSE:                 0.278</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="do">## Model residuals </span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="do">##   - Stats: </span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="do">##     ┌──────────┬─────────┬─────────┐</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="do">##     │ Min.     │ 1st Q.  │ Median  │</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="do">##     ├──────────┼─────────┼─────────┤</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="do">##     │ -1974.48 │ -473.90 │ -177.07 │</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a><span class="do">##     └──────────┴─────────┴─────────┘</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a><span class="do">## 3/6 columns shown.</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a><span class="do">##   - Spatial autocorrelation: </span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a><span class="do">##    ┌──────────┬───────────┬─────────┐</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ Distance │ Moran's I │ P value │</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a><span class="do">##    ├──────────┼───────────┼─────────┤</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="do">##    │      0.0 │     0.156 │   0.000 │</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="do">##    ├──────────┼───────────┼─────────┤</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a><span class="do">##    │   1500.0 │     0.040 │   0.000 │</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a><span class="do">##    ├──────────┼───────────┼─────────┤</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a><span class="do">##    │   3000.0 │     0.009 │   0.063 │</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a><span class="do">##    └──────────┴───────────┴─────────┘</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a><span class="do">## 3/4 columns shown.</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a><span class="do">## Variable importance: </span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a><span class="do">##    ┌──────────────────┬────────────┐</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ Variable         │ Importance │</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a><span class="do">##    ├──────────────────┼────────────┤</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ climate_bio1_ave │      0.285 │</span></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ rage             │            │</span></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a><span class="do">##    ├──────────────────┼────────────┤</span></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ climate_bio1_ave │      0.228 │</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ rage_X_bias_area │            │</span></span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ _km2             │            │</span></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a><span class="do">##    ├──────────────────┼────────────┤</span></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ climate_hypervol │      0.205 │</span></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ ume              │            │</span></span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a><span class="do">##    ├──────────────────┼────────────┤</span></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ human_population │      0.105 │</span></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ _density         │            │</span></span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a><span class="do">##    ├──────────────────┼────────────┤</span></span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ neighbors_count  │      0.090 │</span></span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a><span class="do">##    ├──────────────────┼────────────┤</span></span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ bias_species_per │      0.054 │</span></span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ _record          │            │</span></span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a><span class="do">##    ├──────────────────┼────────────┤</span></span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ neighbors_area   │      0.046 │</span></span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a><span class="do">##    ├──────────────────┼────────────┤</span></span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ fragmentation_co │      0.045 │</span></span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ hesion           │            │</span></span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a><span class="do">##    ├──────────────────┼────────────┤</span></span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ climate_velocity │      0.043 │</span></span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ _lgm_average     │            │</span></span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a><span class="do">##    ├──────────────────┼────────────┤</span></span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ topography_eleva │      0.038 │</span></span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ tion_average     │            │</span></span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a><span class="do">##    ├──────────────────┼────────────┤</span></span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ climate_aridity_ │      0.034 │</span></span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ index_average    │            │</span></span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a><span class="do">##    ├──────────────────┼────────────┤</span></span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ neighbors_percen │      0.028 │</span></span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ t_shared_edge    │            │</span></span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a><span class="do">##    ├──────────────────┼────────────┤</span></span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ fragmentation_di │      0.025 │</span></span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ vision           │            │</span></span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a><span class="do">##    ├──────────────────┼────────────┤</span></span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ climate_bio15_mi │      0.023 │</span></span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ nimum            │            │</span></span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a><span class="do">##    ├──────────────────┼────────────┤</span></span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ landcover_herbs_ │      0.007 │</span></span>
<span id="cb22-87"><a href="#cb22-87" aria-hidden="true" tabindex="-1"></a><span class="do">##    │ percent_average  │            │</span></span>
<span id="cb22-88"><a href="#cb22-88" aria-hidden="true" tabindex="-1"></a><span class="do">##    └──────────────────┴────────────┘</span></span></code></pre></div>
<p><strong>Repeating a model execution</strong></p>
<p>Random Forest is an stochastic algorithm that yields slightly different results on each run unless a random seed is set. This particularity has implications for the interpretation of variable importance scores. For example, in the plot above, the difference in importance between the predictors <code>climate_hypervolume</code> and <code>climate_bio1_average_X_bias_area_km2</code> could be just the result of chance. The function <a href="https://blasbenito.github.io/spatialRF/reference/rf_repeat.html"><code><a href="reference/rf_repeat.html">rf_repeat()</a></code></a> repeats a model execution and yields the distribution of importance scores of the predictors across executions.</p>
<div class="sourceCode" id="cb23"><pre class="r"><span class="no">model.non.spatial.repeat</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/rf_repeat.html">rf_repeat</a></span>(
  <span class="kw">model</span> <span class="kw">=</span> <span class="no">model.non.spatial</span>,
  <span class="kw">repetitions</span> <span class="kw">=</span> <span class="fl">30</span>,
  <span class="kw">seed</span> <span class="kw">=</span> <span class="no">random.seed</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>
)

<span class="fu"><a href="reference/plot_importance.html">plot_importance</a></span>(
  <span class="no">model.non.spatial.repeat</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>
  )</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-36-1.png"><!-- --></p>
<p>After 30 model repetitions it is clear that the difference in importance between <code>climate_hypervolume</code> and <code>climate_bio1_average_X_bias_area_km2</code> is not the result of chance.</p>
<p>The response curves of models fitted with <code><a href="reference/rf_repeat.html">rf_repeat()</a></code> can be plotted with <code><a href="reference/plot_response_curves.html">plot_response_curves()</a></code> as well. The median prediction is shown with a thicker line.</p>
<div class="sourceCode" id="cb24"><pre class="r"><span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/plot_response_curves.html">plot_response_curves</a></span>(
  <span class="no">model.non.spatial.repeat</span>,
  <span class="kw">quantiles</span> <span class="kw">=</span> <span class="fl">0.5</span>
  )</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-37-1.png"><!-- --> The function <code><a href="reference/get_response_curves.html">get_response_curves()</a></code> returns a data frame with the data required to make custom plots of the response curves.</p>
<div class="sourceCode" id="cb25"><pre class="r"><span class="no">reponse.curves.df</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/get_response_curves.html">get_response_curves</a></span>(<span class="no">model.non.spatial.repeat</span>)</pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">response</th>
<th align="right">predictor</th>
<th align="left">quantile</th>
<th align="right">model</th>
<th align="left">predictor.name</th>
<th align="left">response.name</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1410.021</td>
<td align="right">-183.8091</td>
<td align="left">0.1</td>
<td align="right">1</td>
<td align="left">climate_bio1_average</td>
<td align="left">richness_species_vascular</td>
</tr>
<tr class="even">
<td align="right">1410.021</td>
<td align="right">-181.5008</td>
<td align="left">0.1</td>
<td align="right">1</td>
<td align="left">climate_bio1_average</td>
<td align="left">richness_species_vascular</td>
</tr>
<tr class="odd">
<td align="right">1410.021</td>
<td align="right">-179.1924</td>
<td align="left">0.1</td>
<td align="right">1</td>
<td align="left">climate_bio1_average</td>
<td align="left">richness_species_vascular</td>
</tr>
<tr class="even">
<td align="right">1410.021</td>
<td align="right">-176.8841</td>
<td align="left">0.1</td>
<td align="right">1</td>
<td align="left">climate_bio1_average</td>
<td align="left">richness_species_vascular</td>
</tr>
<tr class="odd">
<td align="right">1410.021</td>
<td align="right">-174.5758</td>
<td align="left">0.1</td>
<td align="right">1</td>
<td align="left">climate_bio1_average</td>
<td align="left">richness_species_vascular</td>
</tr>
<tr class="even">
<td align="right">1410.021</td>
<td align="right">-172.2675</td>
<td align="left">0.1</td>
<td align="right">1</td>
<td align="left">climate_bio1_average</td>
<td align="left">richness_species_vascular</td>
</tr>
<tr class="odd">
<td align="right">1410.021</td>
<td align="right">-169.9592</td>
<td align="left">0.1</td>
<td align="right">1</td>
<td align="left">climate_bio1_average</td>
<td align="left">richness_species_vascular</td>
</tr>
<tr class="even">
<td align="right">1410.021</td>
<td align="right">-167.6509</td>
<td align="left">0.1</td>
<td align="right">1</td>
<td align="left">climate_bio1_average</td>
<td align="left">richness_species_vascular</td>
</tr>
<tr class="odd">
<td align="right">1410.021</td>
<td align="right">-165.3426</td>
<td align="left">0.1</td>
<td align="right">1</td>
<td align="left">climate_bio1_average</td>
<td align="left">richness_species_vascular</td>
</tr>
<tr class="even">
<td align="right">1410.021</td>
<td align="right">-163.0343</td>
<td align="left">0.1</td>
<td align="right">1</td>
<td align="left">climate_bio1_average</td>
<td align="left">richness_species_vascular</td>
</tr>
</tbody>
</table>
</div>
<div id="tuning-random-forest-hyperparameters" class="section level1">
<h1 class="hasAnchor">
<a href="#tuning-random-forest-hyperparameters" class="anchor"></a>Tuning Random Forest hyperparameters</h1>
<p>The model fitted above was based on the default hyperparameter values provided by <code>ranger()</code>, and those might not be the most adequate ones for a given dataset. The function <a href="https://blasbenito.github.io/spatialRF/reference/rf_tuning.html"><code><a href="reference/rf_tuning.html">rf_tuning()</a></code></a> helps the user to choose sensible values for three Random Forest hyperparameters that are critical to model performance:</p>
<ul>
<li>
<code>num.trees</code>: number of regression trees in the forest.</li>
<li>
<code>mtry</code>: number of variables to choose from on each tree split.</li>
<li>
<code>min.node.size</code>: minimum number of cases on a terminal node.</li>
</ul>
<p>Model tuning is done via spatial cross-validation, to ensure that the selected combination of hyperparameters maximizes the ability of the model to predict data not used to train it.</p>
<div class="sourceCode" id="cb26"><pre class="r"><span class="no">model.non.spatial.tuned</span> <span class="kw">&lt;-</span> <span class="fu"><a href="reference/rf_tuning.html">rf_tuning</a></span>(
  <span class="kw">model</span> <span class="kw">=</span> <span class="no">model.non.spatial</span>,
  <span class="kw">xy</span> <span class="kw">=</span> <span class="no">plant_richness_df</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"x"</span>, <span class="st">"y"</span>)],
  <span class="kw">repetitions</span> <span class="kw">=</span> <span class="fl">30</span>,
  <span class="kw">training.fraction</span> <span class="kw">=</span> <span class="fl">0.75</span>,
  <span class="kw">num.trees</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">500</span>, <span class="fl">1000</span>),
  <span class="kw">mtry</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(
    <span class="fl">2</span>,
    <span class="fl">14</span>, <span class="co">#equal or lower than the number of predictors</span>
    <span class="kw">by</span> <span class="kw">=</span> <span class="fl">3</span>
    ),
  <span class="kw">min.node.size</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">5</span>, <span class="fl">15</span>),
  <span class="kw">seed</span> <span class="kw">=</span> <span class="no">random.seed</span>
)</pre></div>
<div class="sourceCode" id="cb27"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Exploring 20 combinations of hyperparameters.</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Best hyperparameters:</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="do">##   - num.trees:     1000</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="do">##   - mtry:          14</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="do">##   - min.node.size: 5</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="do">## gain in r.squared: 0.033</span></span></code></pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-40-1.png"><!-- --></p>
<p>The function <code><a href="reference/rf_tuning.html">rf_tuning()</a></code> returns a model fitted with the same data as the original model, but using the best hyperparameters found during tuning. Model tuning has helped to a very small improvement in performance measures (+ 0.033 R squared), so from here, we can keep working with <code>model.non.spatial.tuned</code>.</p>
</div>
<div id="fitting-a-spatial-model" class="section level1">
<h1 class="hasAnchor">
<a href="#fitting-a-spatial-model" class="anchor"></a>Fitting a spatial model</h1>
<p>The spatial autocorrelation of the residuals of <code>model.non.spatial</code>, measured with <a href="https://en.wikipedia.org/wiki/Moran%27s_I">Moran’s I</a>, can be plotted with <a href="https://blasbenito.github.io/spatialRF/reference/plot_moran.html"><code><a href="reference/plot_moran.html">plot_moran()</a></code></a>.</p>
<div class="sourceCode" id="cb28"><pre class="r"><span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/plot_moran.html">plot_moran</a></span>(
  <span class="no">model.non.spatial.tuned</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>
  )</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-41-1.png"><!-- --></p>
<p>According to the plot, the spatial autocorrelation of the residuals is highly positive for a neighborhood of 0 km, while it becomes non-significant (p-value &gt; 0.05, whatever that means) at 1500 and 3000 km. To reduce the spatial autocorrelation of the residuals as much as possible, the non-spatial tuned model fitted above can be converted into a spatial model easily with <a href="https://blasbenito.github.io/spatialRF/reference/rf_spatial.html"><code><a href="reference/rf_spatial.html">rf_spatial()</a></code></a>, that by default uses the Moran’s Eigenvector Maps method.</p>
<div class="sourceCode" id="cb29"><pre class="r"><span class="no">model.spatial</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/rf_spatial.html">rf_spatial</a></span>(
  <span class="kw">model</span> <span class="kw">=</span> <span class="no">model.non.spatial.tuned</span>,
  <span class="kw">method</span> <span class="kw">=</span> <span class="st">"mem.moran.sequential"</span>, <span class="co">#default method</span>
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
  <span class="kw">seed</span> <span class="kw">=</span> <span class="no">random.seed</span>
  )</pre></div>
<p>The plot below shows the Moran’s I of the residuals of the spatial model. It shows that <code><a href="reference/rf_spatial.html">rf_spatial()</a></code> has managed to remove the spatial autocorrelation (p-values of the Moran’s I estimates for each neighborhood distance are higher than 0.05) of the model residuals for every neighborhood distance.</p>
<div class="sourceCode" id="cb30"><pre class="r"><span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/plot_moran.html">plot_moran</a></span>(
  <span class="no">model.spatial</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>
  )</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-43-1.png"><!-- --></p>
<p>If we compare the variable importance plots of both models, we can see that the spatial model has an additional set of dots under the name “spatial_predictors”, and that the maximum importance of a few of these spatial predictors matches the importance of the most relevant non-spatial predictors.</p>
<div class="sourceCode" id="cb31"><pre class="r"><span class="no">p1</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/plot_importance.html">plot_importance</a></span>(
  <span class="no">model.non.spatial</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Non-spatial model"</span>)

<span class="no">p2</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/plot_importance.html">plot_importance</a></span>(
  <span class="no">model.spatial</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>) +
  <span class="kw pkg">ggplot2</span><span class="kw ns">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Spatial model"</span>)

<span class="no">p1</span> <span class="kw">|</span> <span class="no">p2</span></pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-44-1.png"><!-- --></p>
<p>If we take a look to the ten most important variables in <code>model.spatial</code> we will see that a few of them are spatial predictors.</p>
<table class="table">
<thead><tr class="header">
<th align="left">variable</th>
<th align="right">importance</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">climate_bio1_average_X_bias_area_km2</td>
<td align="right">0.166</td>
</tr>
<tr class="even">
<td align="left">spatial_predictor_0_2</td>
<td align="right">0.148</td>
</tr>
<tr class="odd">
<td align="left">climate_hypervolume</td>
<td align="right">0.146</td>
</tr>
<tr class="even">
<td align="left">climate_bio1_average</td>
<td align="right">0.131</td>
</tr>
<tr class="odd">
<td align="left">bias_species_per_record</td>
<td align="right">0.075</td>
</tr>
<tr class="even">
<td align="left">spatial_predictor_0_1</td>
<td align="right">0.068</td>
</tr>
<tr class="odd">
<td align="left">spatial_predictor_3000_1</td>
<td align="right">0.054</td>
</tr>
<tr class="even">
<td align="left">spatial_predictor_0_6</td>
<td align="right">0.048</td>
</tr>
<tr class="odd">
<td align="left">spatial_predictor_0_5</td>
<td align="right">0.043</td>
</tr>
<tr class="even">
<td align="left">neighbors_count</td>
<td align="right">0.040</td>
</tr>
</tbody>
</table>
<p>Spatial predictors are named <code>spatial_predictor_X_Y</code>, where <code>X</code> is the neighborhood distance at which the predictor has been generated, and <code>Y</code> is the index of the predictor.</p>
<p>Spatial predictors, as shown below, are smooth surfaces representing neighborhood among records at different spatial scales.</p>
<p><img src="README_files/figure-gfm/unnamed-chunk-46-1.png"><!-- --></p>
<p>The spatial predictors in the spatial model have been generated using the method “mem.moran.sequential” (function’s default), that mimics the Moran’s Eigenvector Maps method described in <a href="https://www.sciencedirect.com/science/article/abs/pii/S0304380006000925">(Dray, Legendre, and Peres-Neto 2006)</a>.</p>
<p>In brief, the method consist on transforming the distance matrix into a double-centered matrix of normalized weights, to then compute the positive eigenvectors of the weights matrix (a.k.a, Moran’s Eigenvector Maps, or MEMs).</p>
<p>The MEMs are included in the model one by one in the order of their Moran’s I, and the subset of MEMs maximizing the model’s R squared and minimizing the Moran’s I of the residuals and the number of MEMs added to the model are selected, as shown in the optimization plot below (dots linked by lines represent the selected spatial predictors). The selection procedure is performed by the function <a href="https://blasbenito.github.io/spatialRF/reference/select_spatial_predictors_sequential.html"><code><a href="reference/select_spatial_predictors_sequential.html">select_spatial_predictors_sequential()</a></code></a>.</p>
<p><img src="README_files/figure-gfm/unnamed-chunk-47-1.png"><!-- --></p>
<p><strong>Tuning spatial models</strong></p>
<p>Spatial models fitted with <code><a href="reference/rf_spatial.html">rf_spatial()</a></code> can be tuned as well with <code><a href="reference/rf_tuning.html">rf_tuning()</a></code>. However, tuning may in some cases increase the spatial autocorrelation of the model residuals. In that case, the function will return a message explaining the situation, and the original model without any sort of tuning applied</p>
<div class="sourceCode" id="cb32"><pre class="r"><span class="no">model.spatial.tuned</span> <span class="kw">&lt;-</span> <span class="fu"><a href="reference/rf_tuning.html">rf_tuning</a></span>(
  <span class="kw">model</span> <span class="kw">=</span> <span class="no">model.spatial</span>,
  <span class="kw">xy</span> <span class="kw">=</span> <span class="no">plant_richness_df</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"x"</span>, <span class="st">"y"</span>)],
  <span class="kw">repetitions</span> <span class="kw">=</span> <span class="fl">30</span>,
  <span class="kw">num.trees</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">500</span>, <span class="fl">1000</span>),
  <span class="kw">mtry</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(
    <span class="fl">2</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">model.spatial</span>$<span class="no">ranger.arguments</span>$<span class="no">predictor.variable.names</span>),
    <span class="kw">by</span> <span class="kw">=</span> <span class="fl">9</span>),
  <span class="kw">min.node.size</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">5</span>, <span class="fl">15</span>),
  <span class="kw">seed</span> <span class="kw">=</span> <span class="no">random.seed</span>
)</pre></div>
<div class="sourceCode" id="cb33"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Exploring 24 combinations of hyperparameters.</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Best hyperparameters:</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="do">##   - num.trees:     500</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="do">##   - mtry:          47</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="do">##   - min.node.size: 5</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="do">## gain in r.squared: 0.025</span></span></code></pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-48-1.png"><!-- --></p>
</div>
<div id="assessing-model-performance-on-spatially-independent-folds" class="section level1">
<h1 class="hasAnchor">
<a href="#assessing-model-performance-on-spatially-independent-folds" class="anchor"></a>Assessing model performance on spatially independent folds</h1>
<p>The function <a href="https://blasbenito.github.io/spatialRF/reference/rf_evaluate.html"><code><a href="reference/rf_evaluate.html">rf_evaluate()</a></code></a> separates the training data into a number of spatially independent training and testing folds, fits a model on each training fold, predicts over each testing fold, and computes performance measures, to finally aggregate them across model repetitions. Let’s see how it works.</p>
<div class="sourceCode" id="cb34"><pre class="r"><span class="no">model.spatial.tuned</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/rf_evaluate.html">rf_evaluate</a></span>(
  <span class="kw">model</span> <span class="kw">=</span> <span class="no">model.spatial.tuned</span>,
  <span class="kw">xy</span> <span class="kw">=</span> <span class="no">plant_richness_df</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"x"</span>, <span class="st">"y"</span>)], <span class="co">#data coordinates</span>
  <span class="kw">repetitions</span> <span class="kw">=</span> <span class="fl">30</span>,                      <span class="co">#number of folds</span>
  <span class="kw">training.fraction</span> <span class="kw">=</span> <span class="fl">0.8</span>,               <span class="co">#training data fraction</span>
  <span class="kw">metrics</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"r.squared"</span>, <span class="st">"rmse"</span>),
  <span class="kw">seed</span> <span class="kw">=</span> <span class="no">random.seed</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>
)</pre></div>
<p>The function generates a new slot in the model named “evaluation” with several objects that summarize the spatial cross-validation results.</p>
<div class="sourceCode" id="cb35"><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">model.spatial.tuned</span>$<span class="no">evaluation</span>)</pre></div>
<div class="sourceCode" id="cb36"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] "metrics"          </span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [2] "training.fraction"</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="do">## [3] "spatial.folds"    </span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="do">## [4] "per.fold"         </span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="do">## [5] "per.fold.long"    </span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="do">## [6] "per.model"        </span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="do">## [7] "aggregated"</span></span></code></pre></div>
<p>The slot “spatial.folds”, produced by <a href="https://blasbenito.github.io/spatialRF/reference/make_spatial_folds.html"><code><a href="reference/make_spatial_folds.html">make_spatial_folds()</a></code></a>, contains the indices of the training and testing cases for each cross-validation repetition. The maps below show two sets of training and testing spatial folds.</p>
<p><img src="README_files/figure-gfm/unnamed-chunk-51-1.png"><!-- --></p>
<p>The functions <a href="https://blasbenito.github.io/spatialRF/reference/plot_evaluation.html"><code><a href="reference/plot_evaluation.html">plot_evaluation()</a></code></a> and <a href="https://blasbenito.github.io/spatialRF/reference/print_evaluation.html"><code><a href="reference/print_evaluation.html">print_evaluation()</a></code></a> allow to check the evaluation results as a plot or as a table.</p>
<div class="sourceCode" id="cb37"><pre class="r"><span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/print_evaluation.html">print_evaluation</a></span>(<span class="no">model.spatial.tuned</span>)</pre></div>
<div class="sourceCode" id="cb38"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Spatial evaluation </span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="do">##   - Training fraction:             0.8</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="do">##   - Spatial folds:                 25</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="do">##     Metric     Mean Standard deviation</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="do">##  r.squared    0.252              0.163</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="do">##       rmse 3196.160            819.998</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="do">##   Minimum  Maximum</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="do">##     0.076    0.615</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="do">##  2267.920 4741.310</span></span></code></pre></div>
<p>The low R squared yielded by the model evaluation shows that the spatial model is hard to transfer outside of the training space. Models based on a spatial structure like the ones fitted with <code><a href="reference/rf_spatial.html">rf_spatial()</a></code> do not work well when transferred to a different place (that is what <code><a href="reference/rf_compare.html">rf_compare()</a></code> does), because spatial structures are not transferable when the data is irregularly distributed, as it is the case with <code>plant_richness_df</code>. The comparison below shows how non-spatial models may show better (not bad, not great) evaluation scores on independent spatial folds.</p>
</div>
<div id="comparing-several-models" class="section level1">
<h1 class="hasAnchor">
<a href="#comparing-several-models" class="anchor"></a>Comparing several models</h1>
<p>The function <code><a href="reference/rf_evaluate.html">rf_evaluate()</a></code> only assesses the predictive performance on unseen data of one model at a time. If the goal is to compare two models, <code><a href="reference/rf_evaluate.html">rf_evaluate()</a></code> can be indeed ran twice, but <code>spatialRF</code> offers a more convenient option named <a href="https://blasbenito.github.io/spatialRF/reference/rf_compare.html"><code><a href="reference/rf_compare.html">rf_compare()</a></code></a>. It takes as input a named list with as many models as the user needs to compare.</p>
<div class="sourceCode" id="cb39"><pre class="r"><span class="no">comparison</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/rf_compare.html">rf_compare</a></span>(
  <span class="kw">models</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    <span class="kw">`Non-spatial`</span> <span class="kw">=</span> <span class="no">model.non.spatial</span>,
    <span class="kw">`Non-spatial tuned`</span> <span class="kw">=</span> <span class="no">model.non.spatial.tuned</span>,
    <span class="kw">`Spatial`</span> <span class="kw">=</span> <span class="no">model.spatial</span>,
    <span class="kw">`Spatial tuned`</span> <span class="kw">=</span> <span class="no">model.spatial.tuned</span>
  ),
  <span class="kw">xy</span> <span class="kw">=</span> <span class="no">plant_richness_df</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"x"</span>, <span class="st">"y"</span>)],
  <span class="kw">repetitions</span> <span class="kw">=</span> <span class="fl">30</span>,
  <span class="kw">training.fraction</span> <span class="kw">=</span> <span class="fl">0.8</span>,
  <span class="kw">metrics</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"r.squared"</span>, <span class="st">"rmse"</span>),
  <span class="kw">notch</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
  <span class="kw">seed</span> <span class="kw">=</span> <span class="no">random.seed</span>
  )</pre></div>
<p><img src="README_files/figure-gfm/unnamed-chunk-53-1.png"><!-- --></p>
<table class="table">
<thead><tr class="header">
<th align="left">Model</th>
<th align="left">Metric</th>
<th align="right">Mean</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Non-spatial</td>
<td align="left">r.squared</td>
<td align="right">0.336</td>
</tr>
<tr class="even">
<td align="left">Non-spatial tuned</td>
<td align="left">r.squared</td>
<td align="right">0.412</td>
</tr>
<tr class="odd">
<td align="left">Spatial</td>
<td align="left">r.squared</td>
<td align="right">0.163</td>
</tr>
<tr class="even">
<td align="left">Spatial tuned</td>
<td align="left">r.squared</td>
<td align="right">0.222</td>
</tr>
<tr class="odd">
<td align="left">Non-spatial</td>
<td align="left">rmse</td>
<td align="right">2817.225</td>
</tr>
<tr class="even">
<td align="left">Non-spatial tuned</td>
<td align="left">rmse</td>
<td align="right">2329.933</td>
</tr>
<tr class="odd">
<td align="left">Spatial</td>
<td align="left">rmse</td>
<td align="right">3083.346</td>
</tr>
<tr class="even">
<td align="left">Spatial tuned</td>
<td align="left">rmse</td>
<td align="right">2847.590</td>
</tr>
</tbody>
</table>
</div>
<div id="generating-spatial-predictors-for-other-models" class="section level1">
<h1 class="hasAnchor">
<a href="#generating-spatial-predictors-for-other-models" class="anchor"></a>Generating spatial predictors for other models</h1>
<p>You might not love Random Forest, but <code>spatialRF</code> loves you, and as such, it gives you tools to generate spatial predictors for other models anyway.</p>
<p>The first step requires generating Moran’s Eigenvector Maps (MEMs) from the distance matrix. Here there are two options, computing MEMs for a single neighborhood distance with <a href="https://blasbenito.github.io/spatialRF/reference/mem.html"><code><a href="reference/mem.html">mem()</a></code></a>, and computing MEMs for several neighborhood distances at once with <a href="https://blasbenito.github.io/spatialRF/reference/mem_multithreshold.html"><code><a href="reference/mem_multithreshold.html">mem_multithreshold()</a></code></a>.</p>
<div class="sourceCode" id="cb40"><pre class="r"><span class="co">#single distance (0km by default)</span>
<span class="no">mems</span> <span class="kw">&lt;-</span> <span class="fu"><a href="reference/mem.html">mem</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">distance_matrix</span>)

<span class="co">#several distances</span>
<span class="no">mems</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/mem_multithreshold.html">mem_multithreshold</a></span>(
  <span class="kw">x</span> <span class="kw">=</span> <span class="no">distance_matrix</span>,
  <span class="kw">distance.thresholds</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">1000</span>, <span class="fl">2000</span>)
)</pre></div>
<p>In either case the result is a data frame with Moran’s Eigenvector Maps (“just” the positive eigenvectors of the double-centered distance matrix).</p>
<table class="table">
<colgroup>
<col width="25%">
<col width="25%">
<col width="25%">
<col width="25%">
</colgroup>
<thead><tr class="header">
<th align="right">spatial_predictor_0_1</th>
<th align="right">spatial_predictor_0_2</th>
<th align="right">spatial_predictor_0_3</th>
<th align="right">spatial_predictor_0_4</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">0.0259217</td>
<td align="right">0.0052203</td>
<td align="right">0.0416969</td>
<td align="right">-0.0363324</td>
</tr>
<tr class="even">
<td align="right">0.0996679</td>
<td align="right">0.0539713</td>
<td align="right">0.1324480</td>
<td align="right">0.3826928</td>
</tr>
<tr class="odd">
<td align="right">0.0010477</td>
<td align="right">-0.0143046</td>
<td align="right">-0.0443602</td>
<td align="right">-0.0031386</td>
</tr>
<tr class="even">
<td align="right">0.0165695</td>
<td align="right">0.0047991</td>
<td align="right">0.0307457</td>
<td align="right">0.0005170</td>
</tr>
<tr class="odd">
<td align="right">0.0225761</td>
<td align="right">0.0019595</td>
<td align="right">0.0230368</td>
<td align="right">-0.0524239</td>
</tr>
<tr class="even">
<td align="right">0.0155252</td>
<td align="right">0.0023742</td>
<td align="right">0.0197953</td>
<td align="right">-0.0338956</td>
</tr>
<tr class="odd">
<td align="right">0.0229197</td>
<td align="right">0.0039860</td>
<td align="right">0.0312561</td>
<td align="right">-0.0416697</td>
</tr>
<tr class="even">
<td align="right">-0.2436009</td>
<td align="right">-0.1155295</td>
<td align="right">0.0791452</td>
<td align="right">0.0189996</td>
</tr>
<tr class="odd">
<td align="right">0.0150725</td>
<td align="right">-0.0158684</td>
<td align="right">-0.1010284</td>
<td align="right">0.0095590</td>
</tr>
<tr class="even">
<td align="right">-0.1187381</td>
<td align="right">-0.0471879</td>
<td align="right">0.0359881</td>
<td align="right">0.0065211</td>
</tr>
</tbody>
</table>
<p>But not all MEMs are made equal, and you will need to rank them by their Moran’s I. The function <a href="https://blasbenito.github.io/spatialRF/reference/rank_spatial_predictors.html"><code><a href="reference/rank_spatial_predictors.html">rank_spatial_predictors()</a></code></a> will help you do so.</p>
<div class="sourceCode" id="cb41"><pre class="r"><span class="no">mem.rank</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/rank_spatial_predictors.html">rank_spatial_predictors</a></span>(
  <span class="kw">distance.matrix</span> <span class="kw">=</span> <span class="no">distance_matrix</span>,
  <span class="kw">spatial.predictors.df</span> <span class="kw">=</span> <span class="no">mems</span>
)</pre></div>
<p>The output of <code><a href="reference/rank_spatial_predictors.html">rank_spatial_predictors()</a></code> is a list with three slots: “method”, a character string with the name of the ranking method; “criteria”, an ordered data frame with the criteria used to rank the spatial predictors; and “ranking”, a character vector with the names of the spatial predictors in the order of their ranking (it is just the first column of the “criteria” data frame). We can use this “ranking” object to reorder or <code>mems</code> data frame.</p>
<div class="sourceCode" id="cb42"><pre class="r"><span class="no">mems</span> <span class="kw">&lt;-</span> <span class="no">mems</span>[, <span class="no">mem.rank</span>$<span class="no">ranking</span>]

<span class="co">#also:</span>
<span class="co">#mems &lt;- mem.rank$spatial.predictors.df</span></pre></div>
<p>From here, spatial predictors can be included in any model one by one, in the order of the ranking, until the spatial autocorrelation of the residuals is gone, or our model gets totally defaced. A little example with a linear model follows.</p>
<div class="sourceCode" id="cb43"><pre class="r"><span class="co">#model definition</span>
<span class="no">predictors</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(
  <span class="st">"climate_aridity_index_average "</span>,
  <span class="st">"climate_bio1_average"</span>,
  <span class="st">"bias_species_per_record"</span>,
  <span class="st">"human_population_density"</span>,
  <span class="st">"topography_elevation_average"</span>,
  <span class="st">"fragmentation_division"</span>
)
<span class="no">model.formula</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(
    <span class="no">dependent.variable.name</span>,
    <span class="st">" ~ "</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(
      <span class="no">predictors</span>,
      <span class="kw">collapse</span> <span class="kw">=</span> <span class="st">" + "</span>
    )
  )
)

<span class="co">#scaling the data</span>
<span class="no">model.data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span>(<span class="no">plant_richness_df</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>()

<span class="co">#fitting the model</span>
<span class="no">m</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(<span class="no">model.formula</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">plant_richness_df</span>)

<span class="co">#Moran's I test of the residuals</span>
<span class="no">moran.test</span> <span class="kw">&lt;-</span> <span class="kw pkg">spatialRF</span><span class="kw ns">::</span><span class="fu"><a href="reference/moran.html">moran</a></span>(
  <span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">m</span>),
  <span class="kw">distance.matrix</span> <span class="kw">=</span> <span class="no">distance_matrix</span>,
)
<span class="no">moran.test</span></pre></div>
<div class="sourceCode" id="cb44"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="do">##   distance.threshold moran.i.null</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 1                  0 -0.004424779</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="do">##    moran.i      p.value</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 0.209955 2.081346e-09</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="do">##                 interpretation</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 Positive spatial correlation</span></span></code></pre></div>
<p>According to the Moran’s I test, the model residuals show spatial autocorrelation. Let’s introduce MEMs one by one until the problem is solved.</p>
<div class="sourceCode" id="cb45"><pre class="r"><span class="co">#add mems to the data and applies scale()</span>
<span class="no">model.data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="no">plant_richness_df</span>,
  <span class="no">mems</span>
) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>()

<span class="co">#initialize predictors.i</span>
<span class="no">predictors.i</span> <span class="kw">&lt;-</span> <span class="no">predictors</span>

<span class="co">#iterating through MEMs</span>
<span class="kw">for</span>(<span class="no">mem.i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">mems</span>)){

  <span class="co">#add mem name to model definintion</span>
  <span class="no">predictors.i</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">predictors.i</span>, <span class="no">mem.i</span>)

  <span class="co">#generate model formula with the new spatial predictor</span>
  <span class="no">model.formula.i</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(
      <span class="no">dependent.variable.name</span>,
      <span class="st">" ~ "</span>,
      <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(
        <span class="no">predictors.i</span>,
        <span class="kw">collapse</span> <span class="kw">=</span> <span class="st">" + "</span>
      )
    )
  )

  <span class="co">#fit model</span>
  <span class="no">m.i</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(<span class="no">model.formula.i</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">model.data</span>)

  <span class="co">#Moran's I test</span>
  <span class="no">moran.test.i</span> <span class="kw">&lt;-</span> <span class="fu"><a href="reference/moran.html">moran</a></span>(
    <span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">m.i</span>),
    <span class="kw">distance.matrix</span> <span class="kw">=</span> <span class="no">distance_matrix</span>,
  )

  <span class="co">#stop if no autocorrelation</span>
  <span class="kw">if</span>(<span class="no">moran.test.i</span>$<span class="no">interpretation</span> <span class="kw">!=</span> <span class="st">"Positive spatial correlation"</span>){
    <span class="kw">break</span>
  }

}<span class="co">#end of loop</span></pre></div>
<p>Now we can compare the model without spatial predictors <code>m</code> and the model with spatial predictors <code>m.i</code>.</p>
<table class="table">
<thead><tr class="header">
<th align="left">Model</th>
<th align="right">Predictors</th>
<th align="right">R_squared</th>
<th align="right">AIC</th>
<th align="right">BIC</th>
<th align="right">Moran.I</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Non-spatial</td>
<td align="right">6</td>
<td align="right">0.38</td>
<td align="right">4238</td>
<td align="right">4266</td>
<td align="right">0.21</td>
</tr>
<tr class="even">
<td align="left">Spatial</td>
<td align="right">21</td>
<td align="right">0.51</td>
<td align="right">529</td>
<td align="right">608</td>
<td align="right">0.06</td>
</tr>
</tbody>
</table>
<p>According to the model comparison, it can be concluded that the addition of spatial predictors, in spite of the increase in complexity, has improved the model. In any case, this is just a simple demonstration of how spatial predictors generated with functions of the <code>spatialRF</code> package can still help you fit spatial models with other modeling methods.</p>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Browse source code at <br><a href="https://github.com/BlasBenito/spatialRF/">https://​github.com/​BlasBenito/​spatialRF/​</a>
</li>
<li>Report a bug at <br><a href="https://github.com/BlasBenito/spatialRF/issues">https://​github.com/​BlasBenito/​spatialRF/​issues</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://www.r-project.org/Licenses/GPL-3">GPL-3</a></small></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Blas M. Benito <br><small class="roles"> Author, maintainer, copyright holder </small> <a href="https://orcid.org/0000-0001-5105-7232" target="orcid.widget" aria-label="ORCID"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>

  <div class="dev-status">
<h2>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/blasbenito/spatialRF"><img src="https://img.shields.io/badge/devel%20version-1.0.7-blue.svg" alt="Devel-version"></a></li>
<li><a href="https://lifecycle.r-lib.org/articles/stages.html"><img src="https://img.shields.io/badge/lifecycle-experimental-orange.svg" alt="lifecycle"></a></li>
<li><a href="https://github.com/blasbenito/spatialRF"><img src="https://img.shields.io/badge/CRAN-not_published_yet-red" alt="CRAN"></a></li>
<li><a href="https://www.gnu.org/licenses/gpl-3.0.en.html"><img src="https://img.shields.io/badge/license-GPL--3-blue.svg" alt="License"></a></li>
</ul>
</div>
</div>
</div>


      <footer><div class="copyright">
  <p>Developed by Blas M. Benito.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
